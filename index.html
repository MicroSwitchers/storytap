<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#6366f1" />
  <!-- iOS PWA fullscreen support -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="StoryTap" />
  <!-- Android PWA fullscreen support -->
  <meta name="mobile-web-app-capable" content="yes" />
  <!-- Prevent auto-formatting of phone numbers/addresses -->
  <meta name="format-detection" content="telephone=no, address=no, email=no" />
  <!-- SEO -->
  <meta name="description" content="Interactive touch stories for children with accessibility features." />
  <title>StoryTap â€” Touch Books for Little Ones</title>
  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/svg+xml" href="icon.svg" />
  <link rel="apple-touch-icon" href="icon.svg" />
  <!-- Preconnect for faster font loading -->
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Crimson+Pro:wght@400;500;600&display=swap"
    rel="stylesheet">
  <script src="https://cdn.tailwindcss.com/3.4.16"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Nunito', 'system-ui', 'sans-serif'],
            serif: ['Crimson Pro', 'Georgia', 'serif'],
          },
        },
      },
    };
  </script>
  <style>
    /* ================================================
       PERFORMANCE & ACCESSIBILITY OPTIMIZATIONS
       ================================================ */
    * {
      -webkit-tap-highlight-color: transparent;
      /* Hint to browser for smoother animations */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Reduce animations for users who prefer reduced motion */
    @media (prefers-reduced-motion: reduce) {

      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* ================================================
       FULLSCREEN PWA BODY STYLES
       ================================================ */
    html {
      height: 100%;
      overflow: hidden;
    }

    body {
      margin: 0;
      padding: 0;
      min-height: 100%;
      width: 100%;
      overscroll-behavior: none;
      font-family: 'Nunito', sans-serif;
      /* Safe area insets for notched devices */
      padding-top: env(safe-area-inset-top, 0px);
      padding-bottom: env(safe-area-inset-bottom, 0px);
      padding-left: env(safe-area-inset-left, 0px);
      padding-right: env(safe-area-inset-right, 0px);
      -webkit-user-select: none;
      user-select: none;
      touch-action: manipulation;
      /* Prevent pull-to-refresh on mobile */
      overscroll-behavior-y: contain;
      /* GPU acceleration hint */
      -webkit-transform: translateZ(0);
      transform: translateZ(0);
    }

    /* Root container - allows scrolling for library/create modes */
    #root {
      width: 100%;
      min-height: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      /* Smooth scrolling on iOS */
      /* Contain layout recalculations */
      contain: style;
    }

    input,
    textarea {
      -webkit-user-select: text;
      user-select: text;
      touch-action: auto;
      /* Prevent iOS zoom on input focus */
      font-size: 16px !important;
    }

    /* ================================================
       ORIENTATION-SPECIFIC STYLES
       ================================================ */
    @media (orientation: landscape) {

      /* Adjust for landscape viewing */
      .story-text {
        max-width: 70vw;
      }
    }

    @media (orientation: portrait) {

      /* Adjust for portrait viewing */
      .story-text {
        max-width: 90vw;
      }
    }

    /* Small screens (phones) */
    @media (max-height: 500px) and (orientation: landscape) {

      /* Extra compact layout for phones in landscape */
      .story-container {
        padding: 1rem;
      }
    }

    @keyframes breathe {

      0%,
      100% {
        transform: scale(1);
        opacity: 0.5;
      }

      50% {
        transform: scale(1.1);
        opacity: 0.7;
      }
    }

    .ambient-orb {
      animation: breathe 8s ease-in-out infinite;
    }

    .ambient-orb-2 {
      animation: breathe 10s ease-in-out infinite;
      animation-delay: -3s;
    }

    @keyframes pulse-ring {
      0% {
        transform: scale(0.8);
        opacity: 0.8;
      }

      50% {
        transform: scale(1);
        opacity: 0.4;
      }

      100% {
        transform: scale(0.8);
        opacity: 0.8;
      }
    }

    .pulse-ring {
      animation: pulse-ring 2s ease-in-out infinite;
    }

    @keyframes glow {

      0%,
      100% {
        box-shadow: 0 0 30px rgba(255, 255, 255, 0.1);
      }

      50% {
        box-shadow: 0 0 60px rgba(255, 255, 255, 0.2);
      }
    }

    .glow {
      animation: glow 3s ease-in-out infinite;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in-up {
      animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    @keyframes pageTurn {
      0% {
        opacity: 1;
        transform: translateX(0);
      }

      50% {
        opacity: 0;
        transform: translateX(50px);
      }

      51% {
        opacity: 0;
        transform: translateX(-50px);
      }

      100% {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .page-turn {
      animation: pageTurn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes burst {
      0% {
        transform: scale(0) rotate(0deg);
        opacity: 1;
      }

      100% {
        transform: scale(2) rotate(180deg);
        opacity: 0;
      }
    }

    .burst {
      animation: burst 1s ease-out forwards;
    }

    @keyframes processingPulse {

      0%,
      100% {
        border-color: rgba(129, 140, 248, 0.3);
      }

      50% {
        border-color: rgba(129, 140, 248, 1);
      }
    }

    .processing-card {
      animation: processingPulse 2s ease-in-out infinite;
      border-width: 3px;
    }

    /* Custom Scrollbar for Settings */
    .settings-scroll::-webkit-scrollbar {
      width: 8px;
    }

    .settings-scroll::-webkit-scrollbar-track {
      background: transparent;
    }

    .settings-scroll::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
      border: 2px solid transparent;
      background-clip: content-box;
    }

    .settings-scroll::-webkit-scrollbar-thumb:hover {
      background-color: rgba(0, 0, 0, 0.4);
    }

    /* High contrast scrollbar override */
    .high-contrast .settings-scroll::-webkit-scrollbar-thumb {
      background-color: rgba(255, 255, 255, 0.4);
    }

    .high-contrast .settings-scroll::-webkit-scrollbar-thumb:hover {
      background-color: rgba(255, 255, 255, 0.6);
    }
  </style>
  <script src="quickstories.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useRef, useCallback, useMemo } from 'https://esm.sh/react@18.3.1';
    import { createRoot } from 'https://esm.sh/react-dom@18.3.1/client';
    import { BookOpen, Play, Volume2, VolumeX, Sparkles, ArrowLeft, Loader2, Check, Star, Heart, Moon, Sun, Wand2, Settings, X, Eye, Vibrate, Palette, AlertTriangle, List, Trash2, Save, Plus, Download, Pencil, SkipForward, Lock, Unlock, Layout, Type, RefreshCw, PenTool, Maximize2, Minimize2 } from 'https://esm.sh/lucide-react?deps=react@18.3.1,react-dom@18.3.1';
    import { KokoroTTS } from 'https://esm.sh/kokoro-js';

    const MODEL_ID = "onnx-community/Kokoro-82M-v1.0-ONNX";

    // =============================================
    // CONFIGURATION
    // =============================================
    const VOICES = [
      { name: "af_heart", label: "Warm & Gentle", desc: "Best for bedtime", emoji: "ðŸŒ™", color: "bg-violet-500" },
      { name: "af_sky", label: "Bright & Cheerful", desc: "Great for adventure", emoji: "â˜€ï¸", color: "bg-amber-400" },
      { name: "bf_lily", label: "Soft & British", desc: "Classic fairy tales", emoji: "ðŸŒ¸", color: "bg-pink-400" },
      { name: "am_puck", label: "Playful & Fun", desc: "Silly stories", emoji: "ðŸŽ­", color: "bg-emerald-400" },
      { name: "am_fenrir", label: "Deep & Mysterious", desc: "Legends and myths", emoji: "ðŸº", color: "bg-slate-600" },
      { name: "af_bella", label: "Rich & Expressive", desc: "Epic tales", emoji: "âœ¨", color: "bg-fuchsia-500" },
    ];

    const SPEEDS = [
      { label: "Storytelling", value: 0.75, icon: Moon, desc: "Perfect for kids" },
      { label: "Relaxed", value: 0.9, icon: Heart, desc: "Calm & steady" },
      { label: "Natural", value: 1.0, icon: Sun, desc: "Standard pace" },
      { label: "Brisk", value: 1.15, icon: Sparkles, desc: "Energetic" },
    ];

    const THEMES = [
      {
        id: 'default',
        label: 'Default',
        desc: 'Clean & Crisp',
        bg: 'bg-slate-900', // Flat
        text: 'text-white',
        accent: 'indigo',
        progress: 'bg-indigo-500',
        coverBg: 'bg-slate-900', // Flat
        coverText: 'text-white',
        coverSub: 'text-indigo-200',
        pulse: 'bg-white/10',
        coverBorder: 'border-white', // High Contrast
        coverElementBg: 'bg-white/5',
        readingDark: true,

        // PWA & Setup Screen
        pageBg: 'bg-slate-50',
        cardBg: 'bg-white',
        textMain: 'text-slate-900',
        textSub: 'text-slate-700',
        border: 'border-slate-300',
        inputBg: 'bg-slate-50',
        highlight: 'indigo',
        highlightBorder: 'border-indigo-500',
        highlightBgLight: 'bg-indigo-50',
        highlightFocus: 'focus:border-indigo-500',
        highlightRing: 'ring-indigo-200',
        highlightText: 'text-indigo-600'
      },
      {
        id: 'buff',
        label: 'Buff',
        desc: 'Easy on Eyes',
        bg: 'bg-[#F0EAD6]', // Buff Color
        text: 'text-black', // Black text
        accent: 'stone',
        progress: 'bg-black', // Black progress
        coverBg: 'bg-[#F0EAD6]', // Buff Color
        coverText: 'text-black', // Black text
        coverSub: 'text-stone-800', // Dark subtext
        pulse: 'bg-black/10',
        coverBorder: 'border-black', // Black border
        coverElementBg: 'bg-white/40',
        readingDark: false,

        // PWA & Setup Screen
        pageBg: 'bg-[#F5F5DC]', // Beige
        cardBg: 'bg-[#F0EAD6]', // Buff
        textMain: 'text-black', // Black text
        textSub: 'text-stone-800',
        border: 'border-black',
        inputBg: 'bg-white',
        highlight: 'stone',
        highlightBorder: 'border-stone-500',
        highlightBgLight: 'bg-stone-100',
        highlightFocus: 'focus:border-stone-500',
        highlightRing: 'ring-stone-300',
        highlightText: 'text-stone-700'
      },
      {
        id: 'calm',
        label: 'Calm Sky',
        desc: 'Peaceful Blue',
        bg: 'bg-blue-50', // Flat
        text: 'text-slate-900', // Darker text for contrast on light bg
        accent: 'sky',
        progress: 'bg-sky-600',
        coverBg: 'bg-sky-100', // Flat
        coverText: 'text-sky-950',
        coverSub: 'text-sky-950', // Darker
        pulse: 'bg-sky-500/10',
        coverBorder: 'border-sky-900', // High Contrast
        coverElementBg: 'bg-white/60',
        readingDark: false,

        // PWA & Setup Screen
        pageBg: 'bg-slate-50',
        cardBg: 'bg-white',
        textMain: 'text-slate-900',
        textSub: 'text-slate-700',
        border: 'border-sky-700', // Darker for contrast
        inputBg: 'bg-sky-50',
        highlight: 'sky',
        highlightBorder: 'border-sky-500',
        highlightBgLight: 'bg-sky-50',
        highlightFocus: 'focus:border-sky-500',
        highlightRing: 'ring-sky-200',
        highlightText: 'text-sky-600'
      },
      {
        id: 'high-contrast-wb',
        label: 'High Contrast',
        desc: 'White on Black',
        bg: 'bg-black', // Flat
        text: 'text-white',
        accent: 'white',
        progress: 'bg-white',
        coverBg: 'bg-black', // Flat
        coverText: 'text-white',
        coverSub: 'text-white',
        pulse: 'bg-white/20',
        coverBorder: 'border-white',
        coverElementBg: 'bg-transparent',
        readingDark: true,

        // PWA & Setup Screen
        pageBg: 'bg-black',
        cardBg: 'bg-zinc-900',
        textMain: 'text-white',
        textSub: 'text-slate-300',
        border: 'border-white',
        inputBg: 'bg-black',
        highlight: 'white',
        highlightBorder: 'border-white',
        highlightBgLight: 'bg-white/10',
        highlightFocus: 'focus:border-white',
        highlightRing: 'ring-white/30',
        highlightText: 'text-white'
      },
      {
        id: 'high-contrast-yb',
        label: 'Yellow on Black',
        desc: 'Accessibility',
        bg: 'bg-black', // Flat
        text: 'text-yellow-400',
        accent: 'yellow',
        progress: 'bg-yellow-400',
        coverBg: 'bg-black', // Flat
        coverText: 'text-yellow-400',
        coverSub: 'text-yellow-400/80',
        pulse: 'bg-yellow-400/20',
        coverBorder: 'border-yellow-400',
        coverElementBg: 'bg-transparent',
        readingDark: true,

        // PWA & Setup Screen
        pageBg: 'bg-black',
        cardBg: 'bg-zinc-900',
        textMain: 'text-yellow-400',
        textSub: 'text-yellow-200',
        border: 'border-yellow-400',
        inputBg: 'bg-black',
        highlight: 'yellow',
        highlightBorder: 'border-yellow-400',
        highlightBgLight: 'bg-yellow-400/10',
        highlightFocus: 'focus:border-yellow-400',
        highlightRing: 'ring-yellow-200',
        highlightText: 'text-yellow-400'
      }
    ];

    // Optimized yield - use requestIdleCallback when available for non-urgent work
    const yieldToBrowser = () => new Promise(r => requestAnimationFrame(() => setTimeout(r, 0)));
    const yieldIdle = (timeout = 100) => new Promise(r => {
      if (window.requestIdleCallback) {
        window.requestIdleCallback(r, { timeout });
      } else {
        setTimeout(r, 16);
      }
    });

    // Detect device capabilities
    const getDeviceInfo = () => {
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const hasWebGPU = !!navigator.gpu;
      const memory = navigator.deviceMemory || 4; // Default to 4GB if not available
      const cores = navigator.hardwareConcurrency || 4;

      return { isMobile, isSafari, isIOS, hasWebGPU, memory, cores };
    };

    // =============================================
    // FULLSCREEN API (Cross-browser)
    // =============================================
    const enterFullscreen = (element = document.documentElement) => {
      try {
        if (element.requestFullscreen) {
          return element.requestFullscreen();
        } else if (element.webkitRequestFullscreen) {
          // Safari/iOS
          return element.webkitRequestFullscreen();
        } else if (element.mozRequestFullScreen) {
          // Firefox
          return element.mozRequestFullScreen();
        } else if (element.msRequestFullscreen) {
          // IE/Edge
          return element.msRequestFullscreen();
        }
      } catch (e) {
        console.warn('Fullscreen not supported:', e);
      }
      return Promise.resolve();
    };

    const exitFullscreen = () => {
      try {
        if (document.exitFullscreen) {
          return document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          return document.webkitExitFullscreen();
        } else if (document.mozCancelFullScreen) {
          return document.mozCancelFullScreen();
        } else if (document.msExitFullscreen) {
          return document.msExitFullscreen();
        }
      } catch (e) {
        console.warn('Exit fullscreen failed:', e);
      }
      return Promise.resolve();
    };

    const isFullscreen = () => {
      return !!(
        document.fullscreenElement ||
        document.webkitFullscreenElement ||
        document.mozFullScreenElement ||
        document.msFullscreenElement
      );
    };

    const toggleFullscreen = () => {
      if (isFullscreen()) {
        return exitFullscreen();
      } else {
        return enterFullscreen();
      }
    };

    // Check if running as installed PWA (standalone mode)
    const isStandalone = () => {
      return window.matchMedia('(display-mode: standalone)').matches ||
        window.matchMedia('(display-mode: fullscreen)').matches ||
        window.navigator.standalone === true; // iOS Safari
    };
    // =============================================
    // AUDIO CACHE SYSTEM (IndexedDB)
    // =============================================
    const DB_NAME = 'StoryTapAudioCache';
    const DB_VERSION = 2; // Upgraded to support LRU
    const STORE_NAME = 'audio_v2';
    const MAX_ITEMS = 300; // Limit to ~15MB of audio

    const openDB = () => new Promise((resolve, reject) => {
      const request = indexedDB.open(DB_NAME, DB_VERSION);
      request.onerror = () => reject(request.error);
      request.onsuccess = () => resolve(request.result);
      request.onupgradeneeded = (e) => {
        const db = e.target.result;
        // Clean up old v1 store if exists
        if (db.objectStoreNames.contains('audio')) {
          db.deleteObjectStore('audio');
        }
        if (!db.objectStoreNames.contains(STORE_NAME)) {
          const store = db.createObjectStore(STORE_NAME, { keyPath: 'key' });
          store.createIndex('ts', 'ts'); // Timestamp index for LRU
        }
      };
    });

    const getCachedAudio = async (key) => {
      try {
        const db = await openDB();
        return new Promise((resolve) => {
          const tx = db.transaction(STORE_NAME, 'readwrite'); // Readwrite to update TS
          const store = tx.objectStore(STORE_NAME);
          const request = store.get(key);
          request.onsuccess = () => {
            const result = request.result;
            if (result) {
              // Update timestamp (LRU)
              result.ts = Date.now();
              store.put(result);
              resolve(result.blob);
            } else resolve(null);
          };
          request.onerror = () => resolve(null);
        });
      } catch (e) { return null; }
    };

    const setCachedAudio = async (key, blob) => {
      try {
        const db = await openDB();
        return new Promise((resolve) => {
          const tx = db.transaction(STORE_NAME, 'readwrite');
          const store = tx.objectStore(STORE_NAME);

          store.put({ key, blob, ts: Date.now() });

          // Periodic cleanup (simple check)
          const countReq = store.count();
          countReq.onsuccess = () => {
            if (countReq.result > MAX_ITEMS) {
              // Delete oldest
              const idx = store.index('ts');
              const cursorReq = idx.openCursor(); // Ascending = oldest first
              let deleted = 0;
              cursorReq.onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor && deleted < (countReq.result - MAX_ITEMS) + 5) {
                  cursor.delete();
                  deleted++;
                  cursor.continue();
                }
              };
            }
          };

          tx.oncomplete = () => resolve(true);
          tx.onerror = () => resolve(false);
        });
      } catch (e) { return false; }
    };

    // Create a hash key for caching (text + voice + speed + version)
    // Version 2: Fixed chunking bug - invalidates old partial audio
    const CACHE_VERSION = 3; // Bumped: invalidates old entries with bad elongated-letter audio
    const getCacheKey = (text, voice, speed) => {
      const str = `v${CACHE_VERSION}|${text}|${voice}|${speed}`;
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) - hash) + str.charCodeAt(i);
        hash = hash & hash;
      }
      return `audio_${hash}`;
    };

    // Get cache statistics (item count + total blob size)
    const getCacheStats = async () => {
      try {
        const db = await openDB();
        return new Promise((resolve) => {
          const tx = db.transaction(STORE_NAME, 'readonly');
          const store = tx.objectStore(STORE_NAME);
          const countReq = store.count();
          let totalSize = 0;
          const cursorReq = store.openCursor();
          cursorReq.onsuccess = (e) => {
            const cursor = e.target.result;
            if (cursor) {
              if (cursor.value.blob) totalSize += cursor.value.blob.size || 0;
              cursor.continue();
            }
          };
          tx.oncomplete = () => resolve({ count: countReq.result, totalSize });
          tx.onerror = () => resolve({ count: 0, totalSize: 0 });
        });
      } catch (e) { return { count: 0, totalSize: 0 }; }
    };

    // Delete ALL cached audio data from IndexedDB (all sessions)
    const clearAllCachedAudio = async () => {
      try {
        await new Promise((resolve, reject) => {
          const request = indexedDB.deleteDatabase(DB_NAME);
          request.onsuccess = () => resolve();
          request.onerror = () => reject(request.error);
        });
        // Also clear any Service Worker caches that may contain voice data
        if ('caches' in window) {
          const names = await caches.keys();
          await Promise.all(names.map(name => caches.delete(name)));
        }
        return true;
      } catch (e) { return false; }
    };

    // =============================================
    // TEXT OPTIMIZATION FOR FASTER TTS
    // =============================================
    // Clean text for TTS processing
    // Clean text for TTS processing - Added Flow & Cadence Enhancements
    // Clean text for TTS processing - MAXIMIZE PAUSES
    const cleanTextForTTS = (text) => {
      if (!text) return '';
      let t = text.trim();

      // 1. Collapse duplicate chars
      t = t.replace(/(.)\1{2,}/gi, '$1$1');

      // 2. Handle Independent Dashes (Space - Space) -> Period
      // Force full stop pause for dramatic dashes
      // Note: Hyphenated words (e.g. "semi-circle") are ignored because they lack spaces
      t = t.replace(/ - /g, '. ');
      t = t.replace(/â€”/g, '. ');
      t = t.replace(/â€“/g, '. ');
      t = t.replace(/--+/g, '. ');

      // 3. Handle Commas -> Period
      // Force full stop pause for commas (Prevents rushing)
      t = t.replace(/,/g, '. ');

      // 4. Handle Semi-colons -> Period
      t = t.replace(/;/g, '. ');

      // 5. Handle Ellipses -> Period
      // Convert "..." to "." to avoid stuttering/glitching
      t = t.replace(/\.\.\./g, '. ');

      // 6. Enhance Sentence Breaks
      // Ensure punctuation has space after it
      t = t.replace(/([.?!])(?=\S)/g, '$1 ');

      // 7. Text Cleanup
      t = t.replace(/[""â€œ]([^""â€]+)[""â€]/g, '$1'); // Strip quotes
      t = t.replace(/[""'''"']/g, '');             // Strip remaining quotes
      t = t.replace(/\.\.+/g, '.');                // Fix ".." -> "."
      t = t.replace(/\. \./g, '.');                // Fix ". ." -> "."
      t = t.replace(/\s+/g, ' ');                  // Normalize spaces

      return t;
    };

    // Split story text into PAGES (by line) rather than sentences
    // This restores the "intuitive" control where hitting Enter = New Page
    const splitIntoSentences = (text) => {
      if (!text) return [];
      return text.split('\n')
        .map(l => l.replace(/^\d+[\.\)]\s*/, '').trim()) // Remove "1. ", "2. " etc.
        .filter(l => l.length > 0);                      // Remove empty lines
    };

    // =============================================
    // AUDIO CUE ENGINE
    // =============================================
    const useAudioCues = (enabled, vibrationEnabled) => {
      const ctxRef = useRef(null);

      const getCtx = useCallback(() => {
        if (!ctxRef.current) {
          ctxRef.current = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (ctxRef.current.state === 'suspended') {
          ctxRef.current.resume().catch(() => { });
        }
        return ctxRef.current;
      }, []);

      const vibrate = useCallback((pattern) => {
        if (vibrationEnabled && navigator.vibrate) {
          try { navigator.vibrate(pattern); } catch (e) { }
        }
      }, [vibrationEnabled]);

      const play = useCallback((type) => {
        // Haptic patterns tailored for each cue type
        const haptics = {
          tap: 25,
          story_start: [40, 40, 80],
          story_end: [80, 40, 80, 40, 150],
          ready: [60, 30, 60],        // Strong double-pulse: "your turn!"
          advance: 20,
          busy: [15, 15, 15],         // Quick triple-buzz: "wait"
          cover_tap: [30, 20, 30],    // Gentle nudge
          download_done: [50, 30, 80] // Celebration
        };
        vibrate(haptics[type] || 15);

        if (!enabled) return;

        try {
          const ctx = getCtx();
          const now = ctx.currentTime;

          if (type === 'tap') {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, now);
            osc.frequency.exponentialRampToValueAtTime(1320, now + 0.05);
            gain.gain.setValueAtTime(0.12, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.08);
            osc.connect(gain).connect(ctx.destination);
            osc.start(now); osc.stop(now + 0.1);
          } else if (type === 'story_start') {
            [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              osc.type = 'triangle';
              osc.frequency.value = freq;
              gain.gain.setValueAtTime(0, now + i * 0.1);
              gain.gain.linearRampToValueAtTime(0.1, now + i * 0.1 + 0.03);
              gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.1 + 0.35);
              osc.connect(gain).connect(ctx.destination);
              osc.start(now + i * 0.1); osc.stop(now + i * 0.1 + 0.4);
            });
          } else if (type === 'ready') {
            // Friendly two-tone "ding-ding" â€” clearly signals "your turn to tap!"
            [698.46, 880].forEach((freq, i) => {
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              osc.type = 'sine';
              osc.frequency.value = freq;
              gain.gain.setValueAtTime(0, now + i * 0.15);
              gain.gain.linearRampToValueAtTime(0.14, now + i * 0.15 + 0.02);
              gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.15 + 0.35);
              osc.connect(gain).connect(ctx.destination);
              osc.start(now + i * 0.15); osc.stop(now + i * 0.15 + 0.4);
            });
          } else if (type === 'cover_tap') {
            // Warm welcoming tone for the cover page
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(523.25, now);
            osc.frequency.exponentialRampToValueAtTime(659.25, now + 0.15);
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.1, now + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
            osc.connect(gain).connect(ctx.destination);
            osc.start(now); osc.stop(now + 0.35);
          } else if (type === 'download_done') {
            // Happy completion chime
            [523.25, 659.25, 783.99].forEach((freq, i) => {
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              osc.type = 'triangle';
              osc.frequency.value = freq;
              gain.gain.setValueAtTime(0, now + i * 0.08);
              gain.gain.linearRampToValueAtTime(0.1, now + i * 0.08 + 0.02);
              gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.08 + 0.3);
              osc.connect(gain).connect(ctx.destination);
              osc.start(now + i * 0.08); osc.stop(now + i * 0.08 + 0.35);
            });
          } else if (type === 'advance') {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(440, now);
            osc.frequency.exponentialRampToValueAtTime(660, now + 0.12);
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.05, now + 0.03);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
            osc.connect(gain).connect(ctx.destination);
            osc.start(now); osc.stop(now + 0.2);
          } else if (type === 'story_end') {
            [[523.25, 0], [659.25, 0.12], [783.99, 0.24], [1046.50, 0.36]].forEach(([freq, delay]) => {
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              osc.type = 'triangle';
              osc.frequency.value = freq;
              gain.gain.setValueAtTime(0, now + delay);
              gain.gain.linearRampToValueAtTime(0.12, now + delay + 0.02);
              gain.gain.exponentialRampToValueAtTime(0.001, now + delay + 0.5);
              osc.connect(gain).connect(ctx.destination);
              osc.start(now + delay); osc.stop(now + delay + 0.6);
            });
          } else if (type === 'busy') {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.value = 200;
            gain.gain.setValueAtTime(0.06, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
            osc.connect(gain).connect(ctx.destination);
            osc.start(now); osc.stop(now + 0.15);
          }
        } catch (e) {
          console.warn('Audio cue error:', e);
        }
      }, [enabled, getCtx, vibrate]);

      return { play, vibrate };
    };

    // =============================================
    // MAIN APPLICATION
    // =============================================
    const DEFAULT_STORY_TITLE = "The Brave Little Bear";
    const DEFAULT_STORY_TEXT = "Once upon a time, there was a little bear who lived in a cozy cave.\nThe bear loved honey more than anything in the world.\nOne sunny morning, the bear smelled something sweet.\nIt was coming from a tall, tall tree!\nThe bear looked up and saw a beehive.\nBuzz buzz buzz, sang the busy bees.\nThe little bear was scared, but also very hungry.\nSo the bear took a deep breath and started to climb.\nUp, up, up went the brave little bear!\nThe bees flew around, but the bear kept going.\nFinally, the bear reached the golden honey.\nYum yum yum! It was the sweetest honey ever.\nThe bear climbed down with a happy, sticky smile.\nAnd from that day on, everyone called the bear the bravest in the forest.\nThe end.";
    const STORAGE_KEY = 'storytap_prefs_v1';
    const App = () => {
      // Load preferences
      const prefs = useMemo(() => {
        try {
          return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
        } catch { return {}; }
      }, []);

      const [mode, setMode] = useState('library');
      const [storyTitle, setStoryTitle] = useState(prefs.storyTitle || DEFAULT_STORY_TITLE);
      const [rawText, setRawText] = useState(prefs.rawText || DEFAULT_STORY_TEXT);
      const [sentences, setSentences] = useState([]);
      const [currentIndex, setCurrentIndex] = useState(-1);
      const [voice, setVoice] = useState(prefs.voice || VOICES[0].name);
      const [speed, setSpeed] = useState(prefs.speed || 0.85);
      const [isTransitioning, setIsTransitioning] = useState(false);

      // New Accessibility & Option States
      const [showBoundary, setShowBoundary] = useState(prefs.showBoundary || false);
      const [boundaryColor, setBoundaryColor] = useState(prefs.boundaryColor || 'yellow');
      const [showTitlePage, setShowTitlePage] = useState(prefs.showTitlePage !== false); // Default true
      const [loopStory, setLoopStory] = useState(prefs.loopStory || false);

      // Lock Button Timer State
      const [isHoldingLock, setIsHoldingLock] = useState(false);
      const [lockHoldProgress, setLockHoldProgress] = useState(0);

      // Engine state
      const [engineMode, setEngineMode] = useState('kokoro'); // 'kokoro' | 'fallback'
      const [modelReady, setModelReady] = useState(false);
      const [modelProgress, setModelProgress] = useState(0);
      const [modelStatus, setModelStatus] = useState('');
      const [loadError, setLoadError] = useState(null);
      const [isGenerating, setIsGenerating] = useState(false);
      const [isPlaying, setIsPlaying] = useState(false);

      const [storyToPlay, setStoryToPlay] = useState(null);
      const [editingId, setEditingId] = useState(null);
      const [viewFolder, setViewFolder] = useState(null); // 'Simple Stories' or null
      const [showSettings, setShowSettings] = useState(false);
      const [isFullscreenMode, setIsFullscreenMode] = useState(isFullscreen());
      // Library & Processing Queue
      const [library, setLibrary] = useState(() => {
        try {
          const saved = JSON.parse(localStorage.getItem('storytap_library_v1')) || [];
          return saved.map(s => ({
            ...s,
            status: s.status || 'ready',
            progress: s.progress || 100,
            voice: s.voice || 'af_heart',
            speed: s.speed || 0.85
          }));
        }
        catch { return []; }
      });
      useEffect(() => localStorage.setItem('storytap_library_v1', JSON.stringify(library)), [library]);

      // LOAD SIMPLE STORIES (JS Variable)
      // This is robust for local file:// usage where fetch() is blocked by CORS
      useEffect(() => {
        const loadStories = () => {
          const data = window.QUICK_STORIES;
          if (data && Array.isArray(data)) {
            setLibrary(prev => {
              const newLib = [...prev];
              let changed = false;
              data.forEach(s => {
                const id = 'simple_' + s.title.toLowerCase().replace(/[^a-z0-9]/g, '');
                const existingIdx = newLib.findIndex(existing => existing.id === id);

                if (existingIdx === -1) {
                  // Add new
                  newLib.push({
                    id,
                    title: s.title,
                    text: s.text,
                    voice: 'af_heart',
                    speed: 0.75,
                    status: 'ready',
                    progress: 100,
                    folder: 'Simple Stories'
                  });
                  changed = true;
                } else {
                  // Update existing if changed (reflects file edits)
                  const ex = newLib[existingIdx];
                  if (ex.text !== s.text || ex.title !== s.title) {
                    newLib[existingIdx] = { ...ex, title: s.title, text: s.text };
                    changed = true;
                  }
                }
              });
              return changed ? newLib : prev;
            });
          }
        };

        // Try immediately
        loadStories();

        // And retry briefly in case of race condition
        setTimeout(loadStories, 100);
        setTimeout(loadStories, 500);
      }, []);

      // Processing Queue
      const processingRef = useRef(null);
      const lockHoldTimerRef = useRef(null);

      // Save Preferences
      useEffect(() => {
        const settings = {
          voice, speed, textSize, theme,
          soundCuesEnabled, vibrationEnabled, allowSkip,
          showBoundary, boundaryColor, showTitlePage, loopStory
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
      }, [voice, speed, textSize, theme, soundCuesEnabled, vibrationEnabled, allowSkip, showBoundary, boundaryColor, showTitlePage, loopStory]);

      // Cancel a download in progress
      const cancelDownload = (storyId, e) => {
        if (e) e.stopPropagation();
        if (processingRef.current === storyId) {
          processingRef.current = null;
        }
        setLibrary(prev => prev.map(s => s.id === storyId ? { ...s, status: 'ready', progress: 0 } : s));
      };

      const processStory = async (story) => {
        processingRef.current = story.id;

        const sentences = splitIntoSentences(story.text);

        const total = sentences.length;
        if (total === 0) {
          setLibrary(prev => prev.map(s => s.id === story.id ? { ...s, status: 'cached', progress: 100 } : s));
          processingRef.current = null;
          return;
        }

        // Ensure model is loaded before we start downloading
        if (!ttsRef.current) {
          setModelStatus('Loading voice engine for download...');
          const success = await loadKokoroModel();
          if (!success) {
            console.error('Failed to load model for download');
            setLibrary(prev => prev.map(s => s.id === story.id ? { ...s, status: 'ready', progress: 0 } : s));
            processingRef.current = null;
            return;
          }
        }

        let completed = 0;
        const BATCH_SIZE = 3; // Process 3 sentences then yield

        // Set initial progress to show download has started
        setLibrary(prev => prev.map(s => s.id === story.id ? {
          ...s,
          progress: 0,
          progressText: `0 of ${total}`
        } : s));

        for (let i = 0; i < sentences.length; i++) {
          // Check for cancellation before each sentence
          if (processingRef.current !== story.id) {
            console.log('Download cancelled for story:', story.id);
            return;
          }

          try {
            await generateKokoroAudio(sentences[i], story.voice, story.speed);
          } catch (e) {
            console.warn('Error caching sentence:', e);
            // Continue even if one sentence fails
          }

          completed++;

          // Calculate progress with more precision
          const progressPercent = Math.round((completed / total) * 100);

          // Update library state immediately with both percentage and count
          setLibrary(prev => prev.map(s => s.id === story.id ? {
            ...s,
            progress: progressPercent,
            progressText: `${completed} of ${total}`
          } : s));

          // Force a UI update by yielding to browser immediately
          await yieldToBrowser();

          // Add small delay between sentences for UI responsiveness
          // Longer pause every BATCH_SIZE sentences
          if (i % BATCH_SIZE === BATCH_SIZE - 1) {
            await new Promise(r => setTimeout(r, 200));
            await yieldIdle(100);
          } else {
            await new Promise(r => setTimeout(r, 50));
          }
        }

        if (processingRef.current === story.id) {
          setLibrary(prev => prev.map(s => s.id === story.id ? {
            ...s,
            status: 'cached',
            progress: 100,
            progressText: null
          } : s));
          processingRef.current = null;
          playCue('download_done');
        }
      };

      // Watch for stories that need processing (Download button was pressed)
      useEffect(() => {
        if (mode !== 'library') return; // Never cache while editing â€” too disruptive
        const task = library.find(s => s.status === 'processing');
        // Process if there's a task and we're not already processing it
        if (task && (!processingRef.current || processingRef.current !== task.id)) {
          processStory(task);
        }
      }, [library, mode]);

      // Track fullscreen state changes
      useEffect(() => {
        const handleFullscreenChange = () => {
          setIsFullscreenMode(isFullscreen());
        };
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('MSFullscreenChange', handleFullscreenChange);
        return () => {
          document.removeEventListener('fullscreenchange', handleFullscreenChange);
          document.removeEventListener('webkitfullscreenchange', handleFullscreenChange);
          document.removeEventListener('mozfullscreenchange', handleFullscreenChange);
          document.removeEventListener('MSFullscreenChange', handleFullscreenChange);
        };
      }, []);

      // Handle fullscreen toggle (stops event propagation)
      const handleFullscreenToggle = (e) => {
        e.stopPropagation();
        e.preventDefault();
        toggleFullscreen();
      };

      const createNewBook = () => {
        setStoryTitle('');
        setRawText('');
        setEditingId(null);
        setMode('create');
      };

      const editBook = (story, e) => {
        e.stopPropagation();
        setStoryTitle(story.title);
        setRawText(story.text);
        setVoice(story.voice || VOICES[0].name);
        setSpeed(story.speed || 0.85);
        setEditingId(story.id);
        setMode('create');
      };

      const saveCreatedBook = () => {
        if (!storyTitle.trim()) return;

        const storyData = {
          title: storyTitle,
          text: rawText,
          voice,
          speed,
          status: 'ready',  // Save without auto-caching â€” user can Download to pre-cache
          progress: 100
        };

        if (editingId) {
          setLibrary(prev => prev.map(s => s.id === editingId ? { ...storyData, id: editingId } : s));
          setEditingId(null);
        } else {
          setLibrary(prev => [{ ...storyData, id: Date.now() }, ...prev]);
        }
        setMode('library');
      };

      const loadBookForPlay = (story) => {
        if (story.status === 'processing') return; // Block only while downloading
        setStoryTitle(story.title);
        setRawText(story.text);
        setVoice(story.voice || VOICES[0].name);
        setSpeed(story.speed || 0.85);
        setStoryToPlay(story);
      };
      const preloadBook = (story, e) => {
        e.stopPropagation();
        setLibrary(prev => prev.map(s => s.id === story.id ? { ...s, status: 'processing', progress: 0 } : s));
      };

      const deleteBook = (id, e) => {
        e.stopPropagation();
        if (confirm('Delete this story?')) {
          setLibrary(prev => prev.filter(s => s.id !== id));
        }
      };
      const [soundCuesEnabled, setSoundCuesEnabled] = useState(prefs.soundCuesEnabled ?? true);
      const [vibrationEnabled, setVibrationEnabled] = useState(prefs.vibrationEnabled ?? true);
      const [theme, setTheme] = useState(prefs.theme || 'default');
      const [textSize, setTextSize] = useState(prefs.textSize || 'huge');
      const [allowSkip, setAllowSkip] = useState(prefs.allowSkip ?? false);
      const [showEditControls, setShowEditControls] = useState(false);

      // Save preferences on change
      useEffect(() => {
        const toSave = {
          storyTitle, rawText, voice, speed,
          soundCuesEnabled, vibrationEnabled, theme, textSize, allowSkip
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
      }, [storyTitle, rawText, voice, speed, soundCuesEnabled, vibrationEnabled, theme, textSize, allowSkip]);

      // Exit button hold state
      const [isHoldingExit, setIsHoldingExit] = useState(false);
      const [holdProgress, setHoldProgress] = useState(0);
      const holdTimerRef = useRef(null);
      const holdStartRef = useRef(null);
      const lastInteractionRef = useRef(0);

      // Settings hold state (child-safe â€” requires 2s hold to open on library page)
      const [isHoldingSettings, setIsHoldingSettings] = useState(false);
      const [settingsHoldProgress, setSettingsHoldProgress] = useState(0);
      const settingsHoldTimerRef = useRef(null);
      const settingsHoldStartRef = useRef(null);

      // Refs
      const ttsRef = useRef(null);
      const audioRef = useRef(null);
      const cacheRef = useRef({});
      const prefetchRef = useRef(new Set());
      const deviceInfoRef = useRef(getDeviceInfo());
      const initPromiseRef = useRef(null);

      const { play: playCue } = useAudioCues(soundCuesEnabled, vibrationEnabled);
      const currentTheme = THEMES.find(t => t.id === theme) || THEMES[0];

      const getTextSizeClass = () => {
        if (textSize === 'huge') return 'text-4xl md:text-6xl lg:text-7xl';
        if (textSize === 'large') return 'text-3xl md:text-5xl lg:text-6xl';
        return 'text-2xl md:text-4xl lg:text-5xl';
      };

      // =============================================
      // KOKORO TTS ENGINE (Primary)
      // =============================================
      const loadKokoroModel = useCallback(async () => {
        if (ttsRef.current) {
          setModelReady(true);
          return true;
        }

        if (initPromiseRef.current) return initPromiseRef.current;

        initPromiseRef.current = (async () => {
          const device = deviceInfoRef.current;
          setLoadError(null);
          setModelProgress(0);
          setModelStatus('Initializing...');

          try {
            await yieldToBrowser();

            // Determine optimal settings based on device
            let useWebGPU = false;
            let dtype = 'q8'; // Default to q8 for stability

            // Only try WebGPU on desktop Chrome/Edge with good specs
            if (!device.isMobile && !device.isSafari && device.hasWebGPU && device.memory >= 8) {
              try {
                const adapter = await navigator.gpu.requestAdapter();
                if (adapter) {
                  const gpuDevice = await adapter.requestDevice();
                  gpuDevice.destroy();
                  useWebGPU = true;
                  dtype = 'fp32';
                  setModelStatus('Using GPU acceleration...');
                }
              } catch (e) {
                console.warn('WebGPU not available:', e);
              }
            }

            // Tiered model quality based on device capabilities
            if (device.isMobile || device.memory < 4 || device.cores < 4) {
              dtype = 'q4';
              setModelStatus('Loading compact model...');
            } else if (device.memory < 6 && !useWebGPU) {
              dtype = 'q4';
              setModelStatus('Loading optimized model...');
            } else if (!useWebGPU) {
              dtype = 'q8';
              setModelStatus('Loading high-quality model...');
            } else {
              setModelStatus('Loading premium model...');
            }

            console.log(`Loading Kokoro TTS: device=${useWebGPU ? 'webgpu' : 'wasm'}, dtype=${dtype}`);

            const tts = await KokoroTTS.from_pretrained(MODEL_ID, {
              dtype,
              device: useWebGPU ? 'webgpu' : 'wasm',
              progress_callback: (p) => {
                if (p.status === 'progress' && p.total) {
                  const pct = Math.round((p.loaded / p.total) * 100);
                  setModelProgress(pct);
                  if (pct < 30) setModelStatus('Downloading voice model...');
                  else if (pct < 70) setModelStatus('Preparing voice engine...');
                  else if (pct < 95) setModelStatus('Almost ready...');
                  else setModelStatus('Finalizing...');
                }
              }
            });

            ttsRef.current = tts;
            setModelReady(true);
            setEngineMode('kokoro');
            console.log('Kokoro TTS loaded successfully');
            return true;

          } catch (error) {
            console.error('Kokoro TTS failed to load:', error);
            setLoadError(`Voice engine error: ${error.message || 'Unknown error'}`);
            initPromiseRef.current = null; // Reset promise on error so we can retry
            return false;
          }
        })();

        return initPromiseRef.current;
      }, []);

      // NOTE: Model is NOT auto-loaded on mount anymore
      // It only loads when actually needed (first uncached sentence playback)
      // This prevents lag in the menu on slower devices

      // Load audio from IndexedDB cache ONLY (no generation)
      // This can run without the TTS model being loaded
      const loadFromCache = useCallback(async (text, voiceOpt, speedOpt) => {
        const useVoice = voiceOpt || voice;
        const useSpeed = speedOpt || speed;
        const cleanText = cleanTextForTTS(text);
        const cacheKey = getCacheKey(cleanText, useVoice, useSpeed);

        try {
          const cachedBlob = await getCachedAudio(cacheKey);
          if (cachedBlob) {
            return URL.createObjectURL(cachedBlob);
          }
        } catch (e) { /* Cache miss */ }
        return null;
      }, [voice, speed]);

      // Generate audio with Kokoro + persistent cache
      // This requires the TTS model to be loaded
      const generateKokoroAudio = useCallback(async (text, voiceOpt, speedOpt) => {
        const useVoice = voiceOpt || voice;
        const useSpeed = speedOpt || speed;

        // Clean text FIRST â€” normalize elongated letters, whitespace, etc.
        const cleanText = cleanTextForTTS(text);
        const cacheKey = getCacheKey(cleanText, useVoice, useSpeed);

        // Check persistent cache first (doesn't require model)
        try {
          const cachedBlob = await getCachedAudio(cacheKey);
          if (cachedBlob) {
            return URL.createObjectURL(cachedBlob);
          }
        } catch (e) { /* Cache miss, generate fresh */ }

        // Need model to generate - ensure it's loaded
        if (!ttsRef.current) {
          const success = await loadKokoroModel();
          if (!success) return null;
        }

        try {
          await yieldIdle(10);

          const audio = await ttsRef.current.generate(cleanText, { voice: useVoice, speed: useSpeed });
          const resultBlob = audio.toBlob();

          // Save to persistent cache (don't await, do in background)
          setCachedAudio(cacheKey, resultBlob).catch(() => { });

          return URL.createObjectURL(resultBlob);

        } catch (error) {
          console.error('Kokoro generation error:', error);
          return null;
        }
      }, [voice, speed, loadKokoroModel]);

      // =============================================
      // WEB SPEECH FALLBACK ENGINE
      // =============================================
      const speakWithFallback = useCallback((text) => {
        return new Promise((resolve, reject) => {
          if (!window.speechSynthesis) {
            reject(new Error('Speech synthesis not available'));
            return;
          }

          window.speechSynthesis.cancel();
          const utterance = new SpeechSynthesisUtterance(text);

          // Find a good English voice
          const voices = window.speechSynthesis.getVoices();
          const englishVoice = voices.find(v => v.lang.startsWith('en') && v.name.includes('Female'))
            || voices.find(v => v.lang.startsWith('en'))
            || voices[0];
          if (englishVoice) utterance.voice = englishVoice;

          utterance.rate = speed * 0.9;
          utterance.pitch = 1.0;
          utterance.onend = resolve;
          utterance.onerror = reject;

          window.speechSynthesis.speak(utterance);
        });
      }, [speed]);

      // =============================================
      // UNIFIED SPEECH SYSTEM
      // =============================================
      // NOTE: No background prefetching - audio is ONLY cached via:
      // 1. Download button (processStory function)
      // 2. On-demand when playing each sentence (generateKokoroAudio caches to IndexedDB)
      // This ensures the app never stalls on low-power devices

      const playSentence = useCallback(async (idx, list) => {
        if (idx < -1 || idx >= list.length) return; // Allow -1 for Title

        // Stop current audio
        setIsPlaying(false);
        if (audioRef.current) {
          try { audioRef.current.pause(); audioRef.current.currentTime = 0; } catch (e) { }
        }
        window.speechSynthesis?.cancel();

        const text = idx === -1 ? `Title: ${storyTitle}` : list[idx];

        // First check in-memory cache (fastest)
        let url = cacheRef.current[idx];

        // If not in memory, try IndexedDB cache (doesn't need TTS model)
        if (!url) {
          url = await loadFromCache(text);
          if (url) cacheRef.current[idx] = url; // Store in memory for next time
        }

        // If still no URL, we need to generate (this will load model if needed)
        if (!url && engineMode !== 'fallback') {
          setIsGenerating(true);
          url = await generateKokoroAudio(text);
          if (url) cacheRef.current[idx] = url;
          setIsGenerating(false);
        }

        // Try to play the audio
        if (url && audioRef.current) {
          try {
            audioRef.current.src = url;
            await audioRef.current.play();
            setIsPlaying(true);

            // NO background prefetching - audio is ONLY cached via Download button
            // This prevents stalling on low-power devices

            return;
          } catch (e) {
            console.warn('Audio playback failed, trying fallback:', e);
          }
        }

        // Fallback to Web Speech
        console.log('Using Web Speech fallback');
        setEngineMode('fallback');
        setIsPlaying(true);

        try {
          await speakWithFallback(text);
        } catch (e) {
          console.error('Fallback speech error:', e);
        }

        setIsPlaying(false);
        playCue('ready');
      }, [engineMode, generateKokoroAudio, loadFromCache, speakWithFallback, playCue, storyTitle]);

      // Audio ended handler
      const handleAudioEnded = useCallback(() => {
        setIsPlaying(false);
        if (currentIndex >= 0 && currentIndex < sentences.length) {
          playCue('ready');

          // If next sentence is already cached (from Download), pre-load it for instant playback
          // But NO background generation - just check if it's already in cache
          const nextIdx = currentIndex + 1;
          if (nextIdx < sentences.length) {
            const nextUrl = cacheRef.current[nextIdx];
            if (nextUrl && audioRef.current) {
              audioRef.current.src = nextUrl;
              audioRef.current.load(); // Force browser to decode cached audio ahead of time
            }
          }
          // NO prefetching here - audio is ONLY cached via Download button
        }
      }, [currentIndex, sentences, playCue]);

      // Exit button hold logic
      const startHoldExit = (e) => {
        e.preventDefault(); // Prevent synthesized mouse events from reaching parent
        e.stopPropagation();
        setIsHoldingExit(true);
        holdStartRef.current = Date.now();

        const updateProgress = () => {
          const elapsed = Date.now() - holdStartRef.current;
          const progress = Math.min((elapsed / 2000) * 100, 100);
          setHoldProgress(progress);

          if (progress >= 100) {
            exitStory();
            endHoldExit();
          } else {
            holdTimerRef.current = requestAnimationFrame(updateProgress);
          }
        };
        holdTimerRef.current = requestAnimationFrame(updateProgress);
      };

      const endHoldExit = () => {
        setIsHoldingExit(false);
        setHoldProgress(0);
        if (holdTimerRef.current) {
          cancelAnimationFrame(holdTimerRef.current);
          holdTimerRef.current = null;
        }
      };

      // Settings hold-to-open (child-safe on library page)
      const startHoldSettings = (e) => {
        e.preventDefault();
        e.stopPropagation();
        setIsHoldingSettings(true);
        settingsHoldStartRef.current = Date.now();
        const updateProgress = () => {
          const elapsed = Date.now() - settingsHoldStartRef.current;
          const progress = Math.min((elapsed / 2000) * 100, 100);
          setSettingsHoldProgress(progress);
          if (progress >= 100) {
            setShowSettings(true);
            endHoldSettings();
          } else {
            settingsHoldTimerRef.current = requestAnimationFrame(updateProgress);
          }
        };
        settingsHoldTimerRef.current = requestAnimationFrame(updateProgress);
      };

      const endHoldSettings = () => {
        setIsHoldingSettings(false);
        setSettingsHoldProgress(0);
        if (settingsHoldTimerRef.current) {
          cancelAnimationFrame(settingsHoldTimerRef.current);
          settingsHoldTimerRef.current = null;
        }
      };

      // Lock button hold timer
      const startHoldLock = (e) => {
        e.preventDefault();
        e.stopPropagation();
        setIsHoldingLock(true);
        const start = Date.now();
        const updateProgress = () => {
          const elapsed = Date.now() - start;
          const progress = Math.min((elapsed / 2000) * 100, 100);
          setLockHoldProgress(progress);
          if (progress >= 100) {
            setShowEditControls(prev => !prev);
            endHoldLock();
          } else {
            lockHoldTimerRef.current = requestAnimationFrame(updateProgress);
          }
        };
        lockHoldTimerRef.current = requestAnimationFrame(updateProgress);
      };

      const endHoldLock = () => {
        setIsHoldingLock(false);
        setLockHoldProgress(0);
        if (lockHoldTimerRef.current) {
          cancelAnimationFrame(lockHoldTimerRef.current);
          lockHoldTimerRef.current = null;
        }
      };

      // Main tap handler
      const handleTap = useCallback(() => {
        if (isGenerating || isTransitioning) { playCue('busy'); return; }

        if (isPlaying) {
          if (!allowSkip) { playCue('busy'); return; }
          // Skip mode: stop current audio and continue to advance
          if (audioRef.current) {
            try { audioRef.current.pause(); audioRef.current.currentTime = 0; } catch (e) { }
          }
          window.speechSynthesis?.cancel();
          setIsPlaying(false);
        }

        // Context-aware tap cue
        if (currentIndex === -1) {
          playCue('cover_tap');
        } else {
          playCue('tap');
        }
        setIsTransitioning(true);

        const nextIndex = currentIndex + 1;

        if (currentIndex >= sentences.length) {
          playCue('story_start');
          setTimeout(() => {
            setCurrentIndex(-1);
            setIsTransitioning(false);
          }, 500);
          return;
        }

        if (currentIndex === -1) {
          playCue('story_start');
          setTimeout(() => {
            setCurrentIndex(0);
            playSentence(0, sentences);
            setIsTransitioning(false);
          }, 300); // Reduced from 500ms for snappier start
          return;
        }

        if (nextIndex >= sentences.length) {
          if (loopStory) {
            const loopStart = showTitlePage ? -1 : 0;
            playCue('story_start');
            setTimeout(() => {
              setCurrentIndex(loopStart);
              playSentence(loopStart, sentences);
              setIsTransitioning(false);
            }, 300);
            return;
          }

          playCue('story_end');
          setTimeout(() => {
            setCurrentIndex(sentences.length);
            setIsTransitioning(false);
          }, 80);
          return;
        }

        playCue('advance');
        setTimeout(() => {
          setCurrentIndex(nextIndex);
          playSentence(nextIndex, sentences);
          setIsTransitioning(false);
        }, 80); // Reduced from 150ms â€” much snappier page turns
      }, [currentIndex, sentences, isGenerating, isPlaying, isTransitioning, allowSkip, playCue, playSentence, loopStory, showTitlePage]);

      // Ultra-responsive touch handler for accessibility
      // Fires on the SLIGHTEST contact â€” any finger count, any pressure
      // Uses touchstart (not click) for zero-delay response
      const handleInteraction = useCallback((e) => {
        // Prevent all default browser behaviors (scrolling, zooming, pull-to-refresh, text selection)
        e.preventDefault();

        // Debounce: touchstart + synthesized mousedown can double-fire
        const now = Date.now();
        if (now - lastInteractionRef.current < 180) return;
        lastInteractionRef.current = now;

        handleTap();
      }, [handleTap]);

      // Clear in-memory cache when voice/speed settings change
      // No automatic pre-generation - audio is ONLY cached via Download button or on-demand playback
      useEffect(() => {
        Object.values(cacheRef.current).forEach(url => URL.revokeObjectURL(url));
        cacheRef.current = {};
        prefetchRef.current.clear();
      }, [voice, speed]);

      // Start story
      const startStory = async () => {
        const allSentences = splitIntoSentences(rawText);
        if (!allSentences.length) return;

        setSentences(allSentences);
        const startIndex = showTitlePage ? -1 : 0;
        setCurrentIndex(startIndex);
        setMode('loading');

        // For cached stories (downloaded via Download button):
        // Check IndexedDB first - if first sentence is cached, we can skip model loading entirely!
        const firstSentence = allSentences[0];
        let firstUrl = await loadFromCache(firstSentence);

        if (firstUrl) {
          // Story is cached! Store in memory and go directly to reading
          cacheRef.current[0] = firstUrl;
          setModelReady(true); // Mark as ready even without model - we have cached audio
          setMode('reading');
          setTimeout(() => playSentence(startIndex, allSentences), 300); // Faster start for cached
          return;
        }

        // Story NOT cached - need to generate, which requires loading the model
        setModelStatus('Loading voice engine...');

        if (!ttsRef.current) {
          const success = await loadKokoroModel();
          if (!success) {
            setEngineMode('fallback');
            setModelReady(true);
            setMode('reading');
            setTimeout(() => playSentence(startIndex, allSentences), 600);
            return;
          }
        }

        // Generate just the first sentence for immediate playback
        setModelStatus('Preparing audio...');
        try {
          const url = await generateKokoroAudio(firstSentence);
          if (url) cacheRef.current[0] = url;
        } catch (e) {
          console.warn('Initial generation error:', e);
        }

        setMode('reading');

        // Auto-read on entry (Title or First Sentence)
        setTimeout(() => playSentence(startIndex, allSentences), 600);

        // NO background prefetching - audio is ONLY cached via Download button
      };

      useEffect(() => {
        if (storyToPlay && rawText === storyToPlay.text) {
          startStory();
          setStoryToPlay(null);
        }
      }, [storyToPlay, rawText]);

      // Exit story
      const exitStory = () => {
        if (audioRef.current) {
          try { audioRef.current.pause(); audioRef.current.src = ''; } catch (e) { }
        }
        window.speechSynthesis?.cancel();
        setMode('library');
        setCurrentIndex(-1);
        setIsPlaying(false);
        setIsGenerating(false);
      };

      // Clear all cached audio from all storage
      const handleClearCache = async () => {
        const stats = await getCacheStats();
        const sizeMB = (stats.totalSize / (1024 * 1024)).toFixed(1);

        if (stats.count === 0) {
          alert('No cached audio data found.');
          return;
        }

        if (!confirm(`This will delete ${stats.count} cached audio files (${sizeMB} MB).\n\nAll stories will need to re-download their audio.\n\nContinue?`)) return;

        await clearAllCachedAudio();

        // Reset all library items to 'ready'
        setLibrary(prev => prev.map(s => ({ ...s, status: 'ready', progress: 100 })));

        // Clear in-memory cache
        Object.values(cacheRef.current).forEach(url => URL.revokeObjectURL(url));
        cacheRef.current = {};
        prefetchRef.current.clear();
        processingRef.current = null;
      };

      // =============================================
      // SETTINGS MODAL
      // =============================================
      const SettingsModal = () => (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/60 backdrop-blur-sm" onClick={() => setShowSettings(false)}>
          <div className={`${currentTheme.cardBg} rounded-3xl shadow-2xl max-w-lg w-full max-h-[85vh] flex flex-col ${currentTheme.border} border ${theme.includes('high-contrast') ? 'high-contrast' : ''}`} onClick={e => e.stopPropagation()}>
            <div className={`p-6 border-b ${currentTheme.border} flex items-center justify-between`}>
              <h2 className={`text-xl font-bold ${currentTheme.textMain}`}>Accessibility Settings</h2>
              <button onClick={() => setShowSettings(false)} className={`p-2 rounded-full transition-colors ${theme.includes('high-contrast') ? `hover:bg-white/10 ${currentTheme.textMain}` : `hover:bg-slate-100 ${currentTheme.textSub}`}`}>
                <X size={20} />
              </button>
            </div>

            <div className="p-6 space-y-6 overflow-y-auto settings-scroll">
              {/* Sound Cues */}
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${theme.includes('high-contrast') ? `border ${currentTheme.border}` : 'bg-indigo-100'}`}>
                    {soundCuesEnabled ? <Volume2 size={20} className={theme.includes('high-contrast') ? currentTheme.textMain : 'text-indigo-600'} /> : <VolumeX size={20} className={currentTheme.textSub} />}
                  </div>
                  <div>
                    <div className={`font-bold ${currentTheme.textMain}`}>Sound Cues</div>
                    <div className={`text-sm ${currentTheme.textSub}`}>Audio feedback on taps</div>
                  </div>
                </div>
                <button onClick={() => setSoundCuesEnabled(!soundCuesEnabled)} className={`w-14 h-8 rounded-full transition-colors relative ${soundCuesEnabled ? `bg-${currentTheme.highlight}-500 ${theme === 'high-contrast-wb' ? 'bg-white' : ''}` : 'bg-slate-200'} ${theme.includes('high-contrast') && !soundCuesEnabled ? 'bg-zinc-700' : ''}`}>
                  <div className={`absolute top-1 w-6 h-6 rounded-full shadow transition-all ${soundCuesEnabled ? 'left-7' : 'left-1'} ${theme.includes('high-contrast') ? 'bg-black' : 'bg-white'}`} />
                </button>
              </div>

              {/* Vibration */}
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${theme.includes('high-contrast') ? `border ${currentTheme.border}` : 'bg-purple-100'}`}>
                    <Vibrate size={20} className={theme.includes('high-contrast') ? currentTheme.textMain : 'text-purple-600'} />
                  </div>
                  <div>
                    <div className={`font-bold ${currentTheme.textMain}`}>Vibration</div>
                    <div className={`text-sm ${currentTheme.textSub}`}>Haptic feedback on taps</div>
                  </div>
                </div>
                <button onClick={() => setVibrationEnabled(!vibrationEnabled)} className={`w-14 h-8 rounded-full transition-colors relative ${vibrationEnabled ? `bg-${currentTheme.highlight}-500 ${theme === 'high-contrast-wb' ? 'bg-white' : ''}` : 'bg-slate-200'} ${theme.includes('high-contrast') && !vibrationEnabled ? 'bg-zinc-700' : ''}`}>
                  <div className={`absolute top-1 w-6 h-6 rounded-full shadow transition-all ${vibrationEnabled ? 'left-7' : 'left-1'} ${theme.includes('high-contrast') ? 'bg-black' : 'bg-white'}`} />
                </button>
              </div>

              {/* Allow Skip */}
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${theme.includes('high-contrast') ? `border ${currentTheme.border}` : 'bg-sky-100'}`}>
                    <SkipForward size={20} className={theme.includes('high-contrast') ? currentTheme.textMain : 'text-sky-600'} />
                  </div>
                  <div>
                    <div className={`font-bold ${currentTheme.textMain}`}>Allow Skip</div>
                    <div className={`text-sm ${currentTheme.textSub}`}>Tap to skip during playback</div>
                  </div>
                </div>
                <button onClick={() => setAllowSkip(!allowSkip)} className={`w-14 h-8 rounded-full transition-colors relative border-2 ${allowSkip ? `bg-${currentTheme.highlight}-500 border-${currentTheme.highlight}-500 ${theme === 'high-contrast-wb' ? 'bg-white border-white' : ''}` : 'bg-slate-300 border-slate-500'} ${theme.includes('high-contrast') && !allowSkip ? 'bg-zinc-700 border-zinc-500' : ''}`}>
                  <div className={`absolute top-0.5 w-6 h-6 rounded-full shadow transition-all ${allowSkip ? 'left-7' : 'left-0.5'} ${theme.includes('high-contrast') ? 'bg-black' : 'bg-white'}`} />
                </button>
              </div>

              {/* Visual Theme */}
              <div className="space-y-3">
                <div className="flex items-center gap-3">
                  <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${theme.includes('high-contrast') ? `border ${currentTheme.border}` : 'bg-amber-100'}`}>
                    <Palette size={20} className={theme.includes('high-contrast') ? currentTheme.textMain : 'text-amber-600'} />
                  </div>
                  <div>
                    <div className={`font-bold ${currentTheme.textMain}`}>Visual Theme</div>
                    <div className={`text-sm ${currentTheme.textSub}`}>Reading appearance</div>
                  </div>
                </div>
                <div className="grid grid-cols-2 gap-3 mt-3">
                  {THEMES.map(t => (
                    <button key={t.id} onClick={() => setTheme(t.id)} className={`relative overflow-hidden p-1 rounded-xl border-2 transition-all group ${theme === t.id ? `${currentTheme.highlightBorder} ring-2 ${currentTheme.highlightRing}` : `${theme.includes('high-contrast') ? 'border-zinc-700 hover:border-zinc-500' : 'border-slate-200 hover:border-indigo-200'}`}`}>
                      <div className={`w-full aspect-[16/10] rounded-lg ${t.bg} flex flex-col items-center justify-center relative overflow-hidden`}>
                        {/* Mini text preview */}
                        <div className={`text-xs font-serif font-medium ${t.text} opacity-90 mb-1`}>Fairy Tale</div>
                        <div className={`w-12 h-0.5 rounded-full ${t.text} opacity-20`} />

                        {/* Mini progress bar */}
                        <div className="absolute bottom-0 left-0 right-0 h-1 bg-white/10">
                          <div className={`h-full w-2/3 ${t.progress}`} />
                        </div>
                      </div>

                      <div className={`p-2 text-center ${currentTheme.cardBg}`}>
                        <div className={`font-bold text-xs ${currentTheme.textMain}`}>{t.label}</div>
                      </div>

                      {/* Selection check */}
                      {theme === t.id && (
                        <div className={`absolute top-2 right-2 w-5 h-5 rounded-full flex items-center justify-center shadow-sm z-10 ${theme.includes('high-contrast') ? `${currentTheme.border} border-2 ${currentTheme.textMain}` : 'bg-indigo-500 text-white'}`}>
                          <Check size={12} className={theme.includes('high-contrast') ? '' : 'text-white'} strokeWidth={3} />
                        </div>
                      )}
                    </button>
                  ))}
                </div>
              </div>

              {/* Text Size */}
              <div className="space-y-3">
                <div className="flex items-center gap-3">
                  <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${theme.includes('high-contrast') ? `border ${currentTheme.border}` : 'bg-emerald-100'}`}>
                    <Eye size={20} className={theme.includes('high-contrast') ? currentTheme.textMain : 'text-emerald-600'} />
                  </div>
                  <div>
                    <div className={`font-bold ${currentTheme.textMain}`}>Text Size</div>
                    <div className={`text-sm ${currentTheme.textSub}`}>Story text size</div>
                  </div>
                </div>
                <div className="flex gap-2 mt-3">
                  {[{ id: 'normal', label: 'Normal' }, { id: 'large', label: 'Large' }, { id: 'huge', label: 'Huge' }].map(s => (
                    <button key={s.id} onClick={() => setTextSize(s.id)} className={`flex-1 p-3 rounded-xl border-2 text-center transition-all ${textSize === s.id ? `${currentTheme.highlightBorder} ${currentTheme.highlightBgLight}` : `${currentTheme.border} ${theme.includes('high-contrast') ? '' : 'hover:bg-slate-50'}`} ${currentTheme.cardBg}`}>
                      <div className={`font-bold mb-1 ${s.id === 'huge' ? 'text-2xl' : s.id === 'large' ? 'text-xl' : 'text-base'} ${currentTheme.textMain}`}>Aa</div>
                      <div className={`text-xs ${currentTheme.textSub}`}>{s.label}</div>
                    </button>
                  ))}
                </div>
              </div>



              {/* Screen Boundary */}
              <div className={`space-y-3 pt-4 border-t ${currentTheme.border}`}>
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${theme.includes('high-contrast') ? `border ${currentTheme.border}` : 'bg-orange-100'}`}>
                      <Layout size={20} className={theme.includes('high-contrast') ? currentTheme.textMain : 'text-orange-600'} />
                    </div>
                    <div>
                      <div className={`font-bold ${currentTheme.textMain}`}>Show Screen Boundary</div>
                      <div className={`text-sm ${currentTheme.textSub}`}>High contrast edge outline</div>
                    </div>
                  </div>
                  <button onClick={() => setShowBoundary(!showBoundary)} className={`w-14 h-8 rounded-full transition-colors relative border-2 ${showBoundary ? `bg-${currentTheme.highlight}-500 border-${currentTheme.highlight}-500 ${theme === 'high-contrast-wb' ? 'bg-white border-white' : ''}` : 'bg-slate-300 border-slate-500'} ${theme.includes('high-contrast') && !showBoundary ? 'bg-zinc-700 border-zinc-500' : ''}`}>
                    <div className={`absolute top-0.5 w-6 h-6 rounded-full shadow transition-all ${showBoundary ? 'left-7' : 'left-0.5'} ${theme.includes('high-contrast') ? 'bg-black' : 'bg-white'}`} />
                  </button>
                </div>

                <div className={`pt-4 border-t ${currentTheme.border} mt-4`}>
                  <div className="flex items-center gap-3 mb-3">
                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${theme.includes('high-contrast') ? `border ${currentTheme.border}` : 'bg-slate-100'}`}>
                      <PenTool size={16} className={theme.includes('high-contrast') ? currentTheme.textMain : 'text-slate-600'} />
                    </div>
                    <span className={`text-xs font-bold uppercase tracking-wider ${currentTheme.textSub}`}>Highlight Color (Boundary & Progress)</span>
                  </div>

                  <div className="grid grid-cols-6 gap-2">
                    {[{ id: 'yellow', hex: '#facc15', label: 'Yellow' }, { id: 'red', hex: '#ef4444', label: 'Red' }, { id: 'green', hex: '#10b981', label: 'Green' }, { id: 'orange', hex: '#f97316', label: 'Orange' }, { id: 'purple', hex: '#a855f7', label: 'Purple' }, { id: 'blue', hex: '#3b82f6', label: 'Blue' }].map(c => (
                      <button
                        key={c.id}
                        onClick={() => setBoundaryColor(c.id)}
                        className={`w-10 h-10 rounded-full transition-transform shadow-sm ${boundaryColor === c.id ? `ring-4 ring-offset-2 ${currentTheme.highlightRing} scale-110 ${theme.includes('high-contrast') ? 'ring-offset-zinc-900' : ''}` : `hover:scale-105 border-2 opacity-80 hover:opacity-100 ${theme.includes('high-contrast') ? 'border-zinc-600' : 'border-slate-200'}`}`}
                        style={{ backgroundColor: c.hex }}
                        title={c.label}
                      />
                    ))}
                  </div>
                </div>
              </div>

              {/* STORY OPTIONS */}
              <div className={`space-y-3 pt-4 border-t ${currentTheme.border}`}>
                <h3 className={`text-xs font-bold uppercase tracking-wider ${currentTheme.textSub}`}>Story Options</h3>

                {/* Show Title Page */}
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${theme.includes('high-contrast') ? `border ${currentTheme.border}` : 'bg-teal-100'}`}>
                      <Type size={20} className={theme.includes('high-contrast') ? currentTheme.textMain : 'text-teal-600'} />
                    </div>
                    <div>
                      <div className={`font-bold ${currentTheme.textMain}`}>Show Title Page</div>
                      <div className={`text-sm ${currentTheme.textSub}`}>Read title before story</div>
                    </div>
                  </div>
                  <button onClick={() => setShowTitlePage(!showTitlePage)} className={`w-14 h-8 rounded-full transition-colors relative border-2 ${showTitlePage ? `bg-${currentTheme.highlight}-500 border-${currentTheme.highlight}-500 ${theme === 'high-contrast-wb' ? 'bg-white border-white' : ''}` : 'bg-slate-300 border-slate-500'} ${theme.includes('high-contrast') && !showTitlePage ? 'bg-zinc-700 border-zinc-500' : ''}`}>
                    <div className={`absolute top-0.5 w-6 h-6 rounded-full shadow transition-all ${showTitlePage ? 'left-7' : 'left-0.5'} ${theme.includes('high-contrast') ? 'bg-black' : 'bg-white'}`} />
                  </button>
                </div>

                {/* Loop Story */}
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${theme.includes('high-contrast') ? `border ${currentTheme.border}` : 'bg-blue-100'}`}>
                      <RefreshCw size={20} className={theme.includes('high-contrast') ? currentTheme.textMain : 'text-blue-600'} />
                    </div>
                    <div>
                      <div className={`font-bold ${currentTheme.textMain}`}>Loop Story</div>
                      <div className={`text-sm ${currentTheme.textSub}`}>Restart automatically</div>
                    </div>
                  </div>
                  <button onClick={() => setLoopStory(!loopStory)} className={`w-14 h-8 rounded-full transition-colors relative border-2 ${loopStory ? `bg-${currentTheme.highlight}-500 border-${currentTheme.highlight}-500 ${theme === 'high-contrast-wb' ? 'bg-white border-white' : ''}` : 'bg-slate-300 border-slate-500'} ${theme.includes('high-contrast') && !loopStory ? 'bg-zinc-700 border-zinc-500' : ''}`}>
                    <div className={`absolute top-0.5 w-6 h-6 rounded-full shadow transition-all ${loopStory ? 'left-7' : 'left-0.5'} ${theme.includes('high-contrast') ? 'bg-black' : 'bg-white'}`} />
                  </button>
                </div>
              </div>

              {/* Clear Audio Cache - At Bottom */}
              <div className={`flex items-center justify-between pt-4 border-t ${currentTheme.border}`}>
                <div className="flex items-center gap-3">
                  <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${theme.includes('high-contrast') ? `border ${currentTheme.border}` : 'bg-rose-100'}`}>
                    <Trash2 size={20} className={theme.includes('high-contrast') ? currentTheme.textMain : 'text-rose-600'} />
                  </div>
                  <div>
                    <div className={`font-bold ${currentTheme.textMain}`}>Clear Audio Cache</div>
                    <div className={`text-sm ${currentTheme.textSub}`}>Free up storage space</div>
                  </div>
                </div>
                <button onClick={handleClearCache} className={`px-4 py-2 rounded-xl text-sm font-bold transition-colors ${theme.includes('high-contrast') ? 'bg-rose-900/50 text-rose-200 hover:bg-rose-900' : 'bg-rose-50 text-rose-600 hover:bg-rose-100'}`}>
                  Clear
                </button>
              </div>

            </div>

            <div className={`p-6 border-t ${currentTheme.border}`}>
              <button onClick={() => setShowSettings(false)} className={`w-full py-3 font-bold rounded-xl transition-colors ${theme === 'high-contrast-yb' ? 'bg-yellow-400 text-black hover:bg-yellow-300' : theme === 'high-contrast-wb' ? 'bg-white text-black hover:bg-slate-200' : `bg-${currentTheme.highlight}-500 text-white hover:bg-${currentTheme.highlight}-600`}`}>Done</button>
            </div>
          </div>
        </div>
      );

      // BOUNDARY OVERLAY (High Visibility)
      // BOUNDARY OVERLAY (High Visibility)
      const renderBoundary = () => {
        if (!showBoundary) return null;
        const colors = {
          yellow: 'border-yellow-400',
          red: 'border-red-500',
          green: 'border-emerald-500',
          orange: 'border-orange-500',
          purple: 'border-purple-500',
          blue: 'border-blue-500'
        };
        return (
          <div className={`fixed inset-0 border-[12px] ${colors[boundaryColor] || 'border-yellow-400'} pointer-events-none z-[9999]`} style={{ boxShadow: 'inset 0 0 20px rgba(0,0,0,0.2)' }} />
        );
      };

      // =============================================
      // LOADING SCREEN
      // =============================================
      if (mode === 'loading') {
        return (
          <div className={`fixed inset-0 flex flex-col items-center justify-center p-8 ${theme.includes('high-contrast') ? currentTheme.pageBg : 'bg-slate-900'}`}>
            <div className="relative mb-8">
              <div className={`w-24 h-24 rounded-3xl flex items-center justify-center shadow-2xl ${theme.includes('high-contrast') ? `border-2 ${currentTheme.border}` : 'bg-indigo-600 shadow-indigo-500/30'}`}>
                <Wand2 size={40} className={`animate-pulse ${theme.includes('high-contrast') ? currentTheme.textMain : 'text-white'}`} />
              </div>
            </div>
            <h2 className={`text-2xl font-extrabold mb-2 ${theme.includes('high-contrast') ? currentTheme.textMain : 'text-white'}`}>Preparing Magic Voice</h2>
            <p className={`text-sm mb-6 ${theme.includes('high-contrast') ? `${currentTheme.textSub}` : 'text-indigo-300'}`}>{modelStatus || 'This only happens once...'}</p>
            <div className={`w-64 h-2 rounded-full overflow-hidden ${theme.includes('high-contrast') ? `border ${currentTheme.border}` : 'bg-slate-800'}`}>
              <div className={`h-full transition-all duration-300 rounded-full ${theme.includes('high-contrast') ? currentTheme.progress : 'bg-indigo-500'}`} style={{ width: `${modelProgress}%` }} />
            </div>
            <p className={`mt-3 font-bold ${theme.includes('high-contrast') ? currentTheme.textMain : 'text-indigo-400'}`}>{modelProgress}%</p>

            {loadError && (
              <div className={`mt-6 p-4 rounded-xl max-w-md text-center ${theme.includes('high-contrast') ? `border ${currentTheme.border} ${currentTheme.textMain}` : 'bg-amber-900/50 text-amber-200'}`}>
                <AlertTriangle className="mx-auto mb-2" size={24} />
                <p className="text-sm">{loadError}</p>
                <p className="text-xs mt-2 opacity-75">Switching to backup voice...</p>
              </div>
            )}
          </div>
        );
      }

      // =============================================
      // LIBRARY SCREEN (Main Landing)
      // =============================================
      if (mode === 'library') {
        // Helper to render card (extracted to avoid duplication)
        const renderStoryCard = (story) => (
          <div key={story.id} onClick={() => loadBookForPlay(story)} className={`aspect-[3/4] relative rounded-3xl overflow-hidden shadow-xl transition-all cursor-pointer group ${currentTheme.cardBg} ${story.status === 'processing' ? 'processing-card' : `border-2 ${currentTheme.border} hover:scale-[1.02]`}`}>
            <div className={`h-2 w-full ${VOICES.find(v => v.name === story.voice)?.color || 'bg-indigo-400'}`} />
            <div className="px-6 pt-5 pb-6 flex flex-col justify-between" style={{ height: 'calc(100% - 8px)' }}>
              <div>
                {story.status === 'processing' && (
                  <div className="flex justify-end mb-2">
                    <Loader2 className={`${currentTheme.textSub} animate-spin`} size={20} />
                  </div>
                )}
                <div className={`font-bold text-2xl leading-tight mb-3 line-clamp-3 ${currentTheme.textMain}`}>{story.title}</div>
                <div className={`text-sm leading-relaxed ${currentTheme.textSub} line-clamp-4`}>{story.text}</div>
              </div>

              <div className="flex items-center justify-between mt-4">
                {story.status === 'processing' ? (
                  <div className="flex-1 mr-2 flex items-center gap-2">
                    <div className="flex-1">
                      <div className={`text-xs font-bold mb-1.5 ${currentTheme.highlightText}`}>
                        Downloading... {story.progress}%
                        {story.progressText && <span className="opacity-75 ml-1">({story.progressText})</span>}
                      </div>
                      <div className={`h-2.5 w-full rounded-full overflow-hidden ${theme.includes('high-contrast') ? 'bg-zinc-800' : 'bg-slate-200'}`}>
                        <div
                          className={`h-full ${currentTheme.progress} rounded-full`}
                          style={{
                            width: `${story.progress}%`,
                            transition: 'width 0.15s ease-out'
                          }}
                        />
                      </div>
                    </div>
                    <button
                      onClick={(e) => cancelDownload(story.id, e)}
                      className={`p-2 rounded-full transition-colors flex-shrink-0 ${theme.includes('high-contrast') ? 'text-rose-400 hover:bg-white/10' : 'text-rose-400 hover:text-rose-600 hover:bg-rose-50'}`}
                      title="Cancel download"
                    >
                      <X size={18} />
                    </button>
                  </div>
                ) : story.status === 'cached' ? (
                  <div className="flex items-center gap-1 text-xs font-bold uppercase tracking-wider text-emerald-500">
                    <Check size={12} strokeWidth={3} /> Cached & Ready
                  </div>
                ) : (
                  <div className={`flex items-center gap-1 text-xs font-bold uppercase tracking-wider ${currentTheme.textSub}`}>
                    <Play size={12} fill="currentColor" /> Tap to Read
                  </div>
                )}

                {showEditControls && (
                  <div className="flex items-center -mr-2">
                    {story.status !== 'processing' && story.status !== 'cached' && (
                      <button onClick={(e) => preloadBook(story, e)} className={`p-2 rounded-full transition-colors ${theme.includes('high-contrast') ? `${currentTheme.textSub} hover:bg-white/10` : 'text-indigo-400 hover:text-indigo-600 hover:bg-indigo-50'}`} title="Download audio for faster playback">
                        <Download size={18} />
                      </button>
                    )}
                    {story.status === 'cached' && (
                      <div className={`p-2 ${theme.includes('high-contrast') ? currentTheme.textMain : 'text-emerald-400'}`} title="Audio cached">
                        <Download size={18} />
                      </div>
                    )}
                    <button onClick={(e) => editBook(story, e)} className={`p-2 rounded-full transition-colors ${theme.includes('high-contrast') ? `${currentTheme.textSub} hover:bg-white/10` : 'text-amber-400 hover:text-amber-600 hover:bg-amber-50'}`} title="Edit Story">
                      <Pencil size={18} />
                    </button>
                    <button onClick={(e) => deleteBook(story.id, e)} className={`p-2 rounded-full transition-colors ${theme.includes('high-contrast') ? 'text-rose-400 hover:bg-white/10' : 'text-rose-300 hover:text-rose-500 hover:bg-rose-50'}`}>
                      <Trash2 size={18} />
                    </button>
                  </div>
                )}
              </div>
            </div>
          </div>
        );

        const simpleStories = library.filter(s => s.folder === 'Simple Stories');
        const userStories = library.filter(s => !s.folder); // User stories have no folder property or null

        return (
          <div className={`min-h-screen ${currentTheme.pageBg} p-6 md:p-8 transition-colors duration-300`}>
            {renderBoundary()}
            {showSettings && SettingsModal()}

            <header className="max-w-4xl mx-auto flex items-center justify-between mb-8">
              <div className="flex items-center gap-3">
                {viewFolder ? (
                  <button onClick={() => setViewFolder(null)} className={`flex items-center gap-2 font-bold ${currentTheme.textMain} hover:opacity-80 transition-colors`}>
                    <div className={`w-10 h-10 rounded-xl flex items-center justify-center border-2 ${theme.includes('high-contrast') ? `${currentTheme.cardBg} ${currentTheme.border}` : `${currentTheme.inputBg} ${currentTheme.border}`}`}>
                      <ArrowLeft size={20} className={currentTheme.textMain} />
                    </div>
                    <span className="text-xl">Back to Library</span>
                  </button>
                ) : (
                  <>
                    <div className={`w-12 h-12 rounded-xl bg-indigo-600 flex items-center justify-center shadow-lg text-white`}>
                      <BookOpen size={24} />
                    </div>
                    <h1 className={`text-3xl font-bold font-serif ${currentTheme.textMain} tracking-tight`}>StoryTap</h1>
                  </>
                )}
              </div>
              <div className="flex items-center gap-2">
                <button onMouseDown={startHoldLock} onMouseUp={endHoldLock} onMouseLeave={endHoldLock} onTouchStart={startHoldLock} onTouchEnd={endHoldLock} onTouchCancel={endHoldLock} className={`relative p-3 rounded-2xl shadow-md hover:shadow-lg transition-all border ${currentTheme.cardBg} ${currentTheme.border} ${showEditControls ? 'text-amber-500' : currentTheme.textSub}`} title="Hold to toggle lock">
                  {isHoldingLock && (
                    <svg className="absolute inset-0 w-full h-full pointer-events-none" viewBox="0 0 48 48">
                      <circle cx="24" cy="24" r="20" fill="none" stroke="currentColor" strokeWidth="3" strokeOpacity="0.15" />
                      <circle cx="24" cy="24" r="20" fill="none" stroke="currentColor" strokeWidth="3" strokeDasharray="126" strokeDashoffset={126 - (lockHoldProgress / 100) * 126} strokeLinecap="round" style={{ transform: 'rotate(-90deg)', transformOrigin: 'center' }} />
                    </svg>
                  )}
                  {showEditControls ? <Unlock size={22} /> : <Lock size={22} />}
                </button>
                <button onMouseDown={startHoldSettings} onMouseUp={endHoldSettings} onMouseLeave={endHoldSettings} onTouchStart={startHoldSettings} onTouchEnd={endHoldSettings} onTouchCancel={endHoldSettings} className={`relative p-3 rounded-2xl shadow-md hover:shadow-lg transition-all border ${currentTheme.cardBg} ${currentTheme.border} ${currentTheme.textSub}`} title="Hold for settings">
                  {isHoldingSettings && (
                    <svg className="absolute inset-0 w-full h-full pointer-events-none" viewBox="0 0 48 48">
                      <circle cx="24" cy="24" r="20" fill="none" stroke="currentColor" strokeWidth="3" strokeOpacity="0.15" />
                      <circle cx="24" cy="24" r="20" fill="none" stroke="currentColor" strokeWidth="3" strokeDasharray="126" strokeDashoffset={126 - (settingsHoldProgress / 100) * 126} strokeLinecap="round" style={{ transform: 'rotate(-90deg)', transformOrigin: 'center' }} />
                    </svg>
                  )}
                  <Settings size={22} />
                </button>
              </div>
            </header>
            {(isHoldingSettings || isHoldingLock) && (
              <div className={`max-w-4xl mx-auto -mt-6 mb-4 text-center text-sm font-bold ${currentTheme.textSub}`}>
                {isHoldingLock ? 'Hold to toggle lock...' : 'Hold for settings...'}
              </div>
            )}

            <div className="max-w-4xl mx-auto pb-12">

              {/* FOLDER VIEW: Simple Stories */}
              {viewFolder === 'Simple Stories' && (
                <div>
                  <div className="flex items-center gap-3 mb-6">
                    <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${theme.includes('high-contrast') ? `border ${currentTheme.border} ${currentTheme.textMain}` : 'bg-amber-100 text-amber-500'}`}>
                      <Star size={24} fill="currentColor" />
                    </div>
                    <h2 className={`text-2xl font-bold ${currentTheme.textMain}`}>Simple Stories</h2>
                  </div>
                  <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                    {simpleStories.map(renderStoryCard)}
                  </div>
                </div>
              )}

              {/* ROOT VIEW: Folders + User Stories */}
              {viewFolder === null && (
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">

                  {/* Create New (Edit Mode Only, Root Only) */}
                  {showEditControls && (
                    <button onClick={createNewBook} className={`aspect-[3/4] rounded-3xl border-4 border-dashed flex flex-col items-center justify-center gap-4 transition-all group ${currentTheme.border} ${theme.includes('high-contrast') ? `hover:border-current hover:bg-white/5 ${currentTheme.textMain}` : `hover:border-${currentTheme.highlight}-400 hover:bg-${currentTheme.highlight}-50/30`}`}>
                      <div className={`w-20 h-20 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform ${theme.includes('high-contrast') ? `border-2 ${currentTheme.border} ${currentTheme.textMain}` : `bg-${currentTheme.highlight}-100 text-${currentTheme.highlight}-600`}`}>
                        <Plus size={40} />
                      </div>
                      <span className={`font-bold text-lg ${currentTheme.textSub}`}>Create New Book</span>
                    </button>
                  )}

                  {/* FOLDER: Simple Stories */}
                  {simpleStories.length > 0 && (
                    <button onClick={() => setViewFolder('Simple Stories')} className={`aspect-[3/4] relative rounded-3xl overflow-hidden shadow-xl transition-all cursor-pointer group hover:scale-[1.02] ${theme.includes('high-contrast') ? `${currentTheme.cardBg} border-2 ${currentTheme.border}` : 'bg-amber-50 border-2 border-amber-100 hover:border-amber-300'}`}>
                      <div className="absolute inset-0 flex flex-col items-center justify-center p-6 text-center">
                        <div className="relative mb-6 group-hover:scale-110 transition-transform duration-300">
                          {!theme.includes('high-contrast') && <div className="absolute inset-0 bg-amber-200 blur-xl opacity-50 rounded-full"></div>}
                          <Star size={64} className={`relative drop-shadow-sm ${theme.includes('high-contrast') ? currentTheme.textMain : 'text-amber-400'}`} fill="currentColor" />
                        </div>
                        <h3 className={`text-2xl font-bold mb-2 ${theme.includes('high-contrast') ? currentTheme.textMain : 'text-amber-900'}`}>Simple Stories</h3>
                        <div className={`inline-flex items-center gap-2 px-4 py-1.5 rounded-full text-sm font-bold shadow-sm ${theme.includes('high-contrast') ? `border ${currentTheme.border} ${currentTheme.textMain}` : 'bg-white/60 text-amber-700'}`}>
                          <BookOpen size={14} />
                          {simpleStories.length} Books
                        </div>
                      </div>
                    </button>
                  )}

                  {/* User Stories */}
                  {userStories.map(renderStoryCard)}
                </div>
              )}
            </div>
          </div>
        );
      }

      // =============================================
      // CREATE BOOK SCREEN
      // =============================================
      if (mode === 'create') {
        const isHighContrast = theme.includes('high-contrast');

        return (
          <div className={`min-h-screen ${currentTheme.pageBg} p-6 md:p-8 transition-colors duration-300`}>
            {renderBoundary()}
            {showSettings && <SettingsModal />}

            <div className="max-w-2xl mx-auto space-y-6">
              <header className="flex items-center justify-between mb-8">
                <button onClick={() => setMode('library')} className={`flex items-center gap-2 font-bold ${currentTheme.textMain} hover:opacity-80 transition-colors`}>
                  <div className={`w-10 h-10 rounded-xl flex items-center justify-center border-2 ${theme.includes('high-contrast') ? `${currentTheme.cardBg} ${currentTheme.border}` : `${currentTheme.inputBg} ${currentTheme.border}`}`}>
                    <ArrowLeft size={20} className={currentTheme.textMain} />
                  </div>
                  <span className="text-lg">Back</span>
                </button>
                <h1 className={`text-2xl font-bold font-serif ${currentTheme.textMain}`}>{editingId ? 'Edit Story' : 'Create Story'}</h1>
              </header>

              <div className={`rounded-2xl p-4 shadow-lg ${isHighContrast ? `${currentTheme.cardBg} border ${currentTheme.border} ${currentTheme.textMain}` : 'bg-indigo-500 text-white shadow-indigo-200'}`}>
                <div className="flex items-start gap-3">
                  <div className={`w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0 ${isHighContrast ? `border ${currentTheme.border}` : 'bg-white/20'}`}>
                    <Volume2 size={20} className={isHighContrast ? currentTheme.textMain : 'text-white'} />
                  </div>
                  <div>
                    <h3 className="font-bold mb-1">Designed for Blind Children</h3>
                    <p className={`text-sm ${isHighContrast ? currentTheme.textSub : 'text-white/80'}`}>Your child taps anywhere to hear each sentence with audio cues and vibrations.</p>
                  </div>
                </div>
              </div>

              {modelReady && (
                <div className={`flex items-center justify-center gap-2 rounded-full py-2 px-4 mx-auto w-fit ${isHighContrast ? `${currentTheme.cardBg} border ${currentTheme.border} ${currentTheme.textMain}` : 'bg-emerald-50 text-emerald-600'}`}>
                  <Check size={16} strokeWidth={3} />
                  <span className="text-sm font-bold">{engineMode === 'kokoro' ? 'Premium voice ready' : 'Voice ready'}</span>
                </div>
              )}

              <div className={`${currentTheme.cardBg} rounded-3xl shadow-xl p-6 md:p-8 space-y-8 border ${currentTheme.border} transition-colors`}>
                <div className="space-y-2">
                  <label className={`text-xs font-bold uppercase tracking-wide ${currentTheme.textSub}`}>Story Title</label>
                  <input type="text" value={storyTitle} onChange={e => setStoryTitle(e.target.value)} className={`w-full p-4 rounded-2xl border-2 text-xl font-bold focus:outline-none transition-colors ${currentTheme.inputBg} ${currentTheme.textMain} ${currentTheme.border} ${currentTheme.highlightFocus}`} placeholder="Once Upon a Time..." />
                </div>

                <div className="space-y-2">
                  <label className={`text-xs font-bold uppercase tracking-wide ${currentTheme.textSub}`}>Story Text</label>
                  <textarea value={rawText} onChange={e => setRawText(e.target.value)} className={`w-full min-h-[180px] p-4 rounded-2xl border-2 text-base leading-relaxed focus:outline-none transition-colors font-serif ${currentTheme.inputBg} ${currentTheme.textMain} ${currentTheme.border} ${currentTheme.highlightFocus}`} placeholder="Paste or type your story here..." />
                </div>

                <div className="space-y-3">
                  <label className={`text-xs font-bold uppercase tracking-wide ${currentTheme.textSub}`}>Narrator Voice</label>
                  <div className="grid grid-cols-2 gap-3">
                    {VOICES.map(v => (
                      <button key={v.name} onClick={() => setVoice(v.name)} className={`relative p-4 rounded-2xl border-2 text-left transition-all overflow-hidden group ${voice === v.name ? `${currentTheme.highlightBorder} shadow-lg` : `${currentTheme.border} ${isHighContrast ? '' : 'hover:border-slate-200'}`} ${currentTheme.inputBg} ${currentTheme.textMain}`}>
                        {!isHighContrast && <div className={`absolute inset-0 ${v.color} opacity-0 group-hover:opacity-10 transition-opacity ${voice === v.name ? 'opacity-20' : ''}`} />}
                        <div className="relative flex items-center gap-3">
                          <span className="text-2xl">{v.emoji}</span>
                          <div>
                            <div className="font-bold">{v.label}</div>
                            <div className={`text-xs ${currentTheme.textSub}`}>{v.desc}</div>
                          </div>
                        </div>
                        {voice === v.name && <div className={`absolute top-2 right-2 w-5 h-5 rounded-full flex items-center justify-center ${isHighContrast ? (theme === 'high-contrast-yb' ? 'bg-yellow-400 text-black' : 'bg-white text-black') : 'bg-indigo-500 text-white'}`}><Check size={12} /></div>}
                      </button>
                    ))}
                  </div>
                </div>

                <div className="space-y-3">
                  <label className={`text-xs font-bold uppercase tracking-wide ${currentTheme.textSub}`}>Reading Speed</label>
                  <div className="flex gap-2">
                    {SPEEDS.map(s => {
                      const Icon = s.icon;
                      return (
                        <button key={s.value} onClick={() => setSpeed(s.value)} className={`flex-1 p-4 rounded-2xl border-2 text-center transition-all ${speed === s.value ? `${currentTheme.highlightBorder} ${isHighContrast ? `${currentTheme.textMain} ${currentTheme.highlightBgLight}` : 'bg-indigo-50 text-indigo-700'}` : `${currentTheme.border} ${currentTheme.textSub} ${isHighContrast ? '' : 'hover:border-slate-200'}`} ${currentTheme.inputBg}`}>
                          <Icon size={20} className="mx-auto mb-1" />
                          <div className="font-bold text-sm">{s.label}</div>
                        </button>
                      );
                    })}
                  </div>
                </div>

                <button onClick={saveCreatedBook} disabled={!rawText.trim() || !storyTitle.trim()} className={`w-full font-extrabold py-5 rounded-2xl text-xl flex items-center justify-center gap-3 shadow-xl transition-all duration-500 disabled:opacity-50 ${isHighContrast ? `${currentTheme.border} border-2 ${currentTheme.textMain} hover:bg-white/10` : 'bg-indigo-500 hover:bg-indigo-600 text-white shadow-indigo-200'}`}>
                  <Sparkles fill={isHighContrast ? "currentColor" : "white"} size={24} />
                  {editingId ? 'Save Changes' : 'Save Book'}
                </button>
              </div>
            </div>
          </div>
        );
      }

      // =============================================
      // READING MODE
      // =============================================
      const isCover = currentIndex === -1;
      const isEnd = currentIndex >= sentences.length;
      const isReading = !isCover && !isEnd;
      const progress = sentences.length ? ((currentIndex + 1) / sentences.length) * 100 : 0;

      return (
        <div
          onTouchStart={handleInteraction}
          onTouchMove={(e) => e.preventDefault()}
          onMouseDown={handleInteraction}
          onContextMenu={(e) => e.preventDefault()}
          onKeyDown={(e) => { if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); handleInteraction(e); } }}
          className="fixed inset-0 select-none touch-none cursor-pointer overflow-hidden"
          role="button"
          tabIndex={0}
          aria-label={isCover ? 'Tap anywhere to begin the story' : isEnd ? 'Tap to start over' : `Sentence ${currentIndex + 1} of ${sentences.length}. Tap for next.`}
          aria-live="polite"
        >
          {renderBoundary()}
          <audio ref={audioRef} onEnded={handleAudioEnded} preload="auto" hidden />

          <div className="absolute top-6 left-6 z-50">
            <button onMouseDown={startHoldExit} onMouseUp={endHoldExit} onMouseLeave={endHoldExit} onTouchStart={startHoldExit} onTouchEnd={endHoldExit} onTouchCancel={endHoldExit} className={`relative p-3 rounded-full transition-all ${currentTheme.readingDark ? 'bg-white/10 hover:bg-white/20 text-white/40 hover:text-white/70' : 'bg-black/10 hover:bg-black/20 text-black/40 hover:text-black/70'}`}>
              {isHoldingExit && (
                <svg className="absolute inset-0 w-full h-full -rotate-90" viewBox="0 0 36 36">
                  <circle cx="18" cy="18" r="16" fill="none" stroke="currentColor" strokeWidth="2" strokeOpacity="0.2" />
                  <circle cx="18" cy="18" r="16" fill="none" stroke="currentColor" strokeWidth="2" strokeDasharray="100" strokeDashoffset={100 - holdProgress} strokeLinecap="round" />
                </svg>
              )}
              <ArrowLeft size={18} />
            </button>
            {isHoldingExit && <div className={`absolute left-12 top-1/2 -translate-y-1/2 text-xs px-3 py-1.5 rounded-lg whitespace-nowrap ${currentTheme.readingDark ? 'bg-black/80 text-white' : 'bg-white/90 text-black shadow-lg'}`}>Hold to exit...</div>}
          </div>

          {/* Fullscreen toggle - only show when not in standalone PWA mode */}
          {!isStandalone() && (
            <div className="absolute top-6 right-6 z-50">
              <button
                onClick={handleFullscreenToggle}
                onTouchEnd={handleFullscreenToggle}
                className={`p-3 rounded-full transition-all ${currentTheme.readingDark ? 'bg-white/10 hover:bg-white/20 text-white/40 hover:text-white/70' : 'bg-black/10 hover:bg-black/20 text-black/40 hover:text-black/70'}`}
                title={isFullscreenMode ? 'Exit fullscreen' : 'Enter fullscreen'}
              >
                {isFullscreenMode ? <Minimize2 size={18} /> : <Maximize2 size={18} />}
              </button>
            </div>
          )}

          {isCover && (
            <div className={`absolute inset-0 ${currentTheme.coverBg} flex flex-col items-center justify-center p-8`}>
              {!theme.includes('high-contrast') && (
                <div className="absolute inset-0 overflow-hidden pointer-events-none">
                  {/* Flat ambient background removed for accessibility */}
                </div>
              )}
              <div className="flex flex-col items-center justify-between h-full max-h-[800px] py-4">
                <div className="flex-1 flex flex-col items-center justify-center w-full">
                  <div className={`w-20 h-28 rounded-xl flex items-center justify-center border-4 ${currentTheme.readingDark ? 'glow' : 'shadow-lg'} backdrop-blur-sm mb-6 ${currentTheme.coverBorder} ${currentTheme.readingDark ? 'bg-white/10' : 'bg-black/5'}`}>
                    <BookOpen size={40} className={currentTheme.coverText} />
                  </div>
                  <h1 className={`text-4xl md:text-6xl font-black font-serif text-center mb-4 leading-tight tracking-tight fade-in-up ${currentTheme.coverText} max-w-4xl`}>{storyTitle}</h1>
                  <p className={`text-xl font-bold mb-8 fade-in-up ${currentTheme.coverSub}`}>A Story for You</p>

                  <div className="relative mb-8">
                    <div className={`absolute inset-0 w-20 h-20 rounded-full pulse-ring ${currentTheme.pulse}`} />
                    <div className={`w-20 h-20 rounded-full flex items-center justify-center border-4 backdrop-blur-sm ${currentTheme.coverElementBg} ${currentTheme.coverBorder}`}>
                      <Volume2 size={32} className={currentTheme.coverText} />
                    </div>
                  </div>
                </div>

                <div className="flex flex-col items-center pb-8">
                  <span className={`font-black text-xl uppercase tracking-widest mb-2 ${currentTheme.coverSub}`}>Tap Anywhere</span>
                  <span className={`text-lg font-bold ${currentTheme.coverSub} border-b-2 ${currentTheme.coverBorder} pb-1`}>Title Page</span>
                </div>
              </div>
            </div>
          )
          }

          {
            isReading && (
              <div className={`absolute inset-0 ${currentTheme.bg} flex flex-col items-center justify-center p-6 pb-36 md:p-16 md:pb-44`}>
                {isGenerating && (
                  <div className="absolute inset-0 flex items-center justify-center bg-black/50 z-20 backdrop-blur-sm">
                    <Loader2 className={`w-12 h-12 animate-spin ${currentTheme.text}`} />
                  </div>
                )}
                <div className={`relative max-w-5xl mx-auto px-6 ${isTransitioning ? 'page-turn' : ''}`}>
                  <p className={`${getTextSizeClass()} font-serif font-bold text-center leading-loose tracking-wide ${currentTheme.text}`}>{sentences[currentIndex]}</p>
                </div>
                <div className="absolute bottom-0 left-0 right-0 p-8 flex flex-col items-center gap-6">
                  {isPlaying ? (
                    <div className={`flex items-center gap-3 ${currentTheme.text} opacity-60`}>
                      <div className="flex gap-1">{[...Array(4)].map((_, i) => (<div key={i} className={`w-1 rounded-full animate-pulse ${currentTheme.progress}`} style={{ height: `${12 + Math.random() * 12}px`, animationDelay: `${i * 0.1}s` }} />))}</div>
                      <span className="text-sm font-semibold uppercase tracking-wider">Listening...</span>
                    </div>
                  ) : !isGenerating && (
                    <div className={`flex items-center gap-2 opacity-40 animate-pulse ${currentTheme.text}`}>
                      <span className="text-sm font-semibold uppercase tracking-wider">Tap for next</span>
                    </div>
                  )}
                  <div className="w-full max-w-md mx-auto">
                    <div className={`h-8 rounded-full overflow-hidden border-4 border-current ${currentTheme.readingDark ? 'bg-white/20' : 'bg-black/10'} shadow-inner ${currentTheme.text}`}>
                      <div className={`h-full transition-all duration-500`} style={{ width: `${progress}%`, backgroundColor: { yellow: '#facc15', red: '#ef4444', green: '#10b981', orange: '#f97316', purple: '#a855f7', blue: '#3b82f6' }[boundaryColor] || '#facc15' }} />
                    </div>
                    <p className={`text-center text-lg mt-3 font-black uppercase tracking-widest ${currentTheme.text}`}>Page {currentIndex + 1}</p>
                  </div>
                </div>
              </div>
            )
          }

          {
            isEnd && (
              <div className={`absolute inset-0 flex flex-col items-center justify-center p-8 ${theme.includes('high-contrast') ? currentTheme.bg : 'bg-orange-500'}`}>
                <div className="absolute inset-0 overflow-hidden pointer-events-none">{[...Array(12)].map((_, i) => (<Sparkles key={i} size={16 + i * 2} className={`absolute burst ${theme.includes('high-contrast') ? `${currentTheme.text} opacity-40` : 'text-white/40'}`} style={{ top: `${20 + Math.random() * 60}%`, left: `${10 + Math.random() * 80}%`, animationDelay: `${i * 0.1}s` }} />))}</div>
                <Sparkles size={80} className={`animate-bounce mb-8 ${theme.includes('high-contrast') ? currentTheme.text : 'text-white'}`} />
                <h2 className={`text-5xl md:text-7xl font-black text-center mb-4 ${theme.includes('high-contrast') ? currentTheme.text : 'text-white'}`}>The End!</h2>
                <p className={`text-xl mb-16 ${theme.includes('high-contrast') ? `${currentTheme.text} opacity-80` : 'text-white/80'}`}>What a great story!</p>
                <div className="flex flex-col items-center">
                  <div className={`w-20 h-20 rounded-full flex items-center justify-center mb-4 pulse-ring ${theme.includes('high-contrast') ? `border-2 ${currentTheme.coverBorder}` : 'bg-white/20'}`}><Heart size={36} className={theme.includes('high-contrast') ? currentTheme.text : 'text-white'} fill="currentColor" /></div>
                  <span className={`font-bold text-lg uppercase tracking-wider ${theme.includes('high-contrast') ? currentTheme.text : 'text-white/80'}`}>Tap to Start Over</span>
                </div>
              </div>
            )
          }
        </div >
      );
    };

    createRoot(document.getElementById('root')).render(<App />);
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(registration => console.log('SW registered: ', registration.scope))
          .catch(registrationError => console.log('SW registration failed: ', registrationError));
      });
    }
  </script>
</body>

</html>