<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>StoryTap â€” Touch Books for Little Ones</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Crimson+Pro:wght@400;500;600&display=swap"
    rel="stylesheet">
  <script src="https://cdn.tailwindcss.com/3.4.16"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Nunito', 'system-ui', 'sans-serif'],
            serif: ['Crimson Pro', 'Georgia', 'serif'],
          },
        },
      },
    };
  </script>
  <style>
    * {
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      overscroll-behavior: none;
      font-family: 'Nunito', sans-serif;
    }

    @keyframes breathe {

      0%,
      100% {
        transform: scale(1);
        opacity: 0.5;
      }

      50% {
        transform: scale(1.1);
        opacity: 0.7;
      }
    }

    .ambient-orb {
      animation: breathe 8s ease-in-out infinite;
    }

    .ambient-orb-2 {
      animation: breathe 10s ease-in-out infinite;
      animation-delay: -3s;
    }

    @keyframes pulse-ring {
      0% {
        transform: scale(0.8);
        opacity: 0.8;
      }

      50% {
        transform: scale(1);
        opacity: 0.4;
      }

      100% {
        transform: scale(0.8);
        opacity: 0.8;
      }
    }

    .pulse-ring {
      animation: pulse-ring 2s ease-in-out infinite;
    }

    @keyframes glow {

      0%,
      100% {
        box-shadow: 0 0 30px rgba(255, 255, 255, 0.1);
      }

      50% {
        box-shadow: 0 0 60px rgba(255, 255, 255, 0.2);
      }
    }

    .glow {
      animation: glow 3s ease-in-out infinite;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in-up {
      animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    @keyframes pageTurn {
      0% {
        opacity: 1;
        transform: translateX(0);
      }

      50% {
        opacity: 0;
        transform: translateX(50px);
      }

      51% {
        opacity: 0;
        transform: translateX(-50px);
      }

      100% {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .page-turn {
      animation: pageTurn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes burst {
      0% {
        transform: scale(0) rotate(0deg);
        opacity: 1;
      }

      100% {
        transform: scale(2) rotate(180deg);
        opacity: 0;
      }
    }

    .burst {
      animation: burst 1s ease-out forwards;
    }
  </style>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useRef, useCallback } from 'https://esm.sh/react@18.3.1';
    import { createRoot } from 'https://esm.sh/react-dom@18.3.1/client';
    import { BookOpen, Play, Volume2, VolumeX, Sparkles, ArrowLeft, Loader2, Check, Star, Heart, Moon, Sun, Wand2, Settings, X, Eye, Vibrate, Palette, AlertTriangle } from 'https://esm.sh/lucide-react?deps=react@18.3.1,react-dom@18.3.1';
    import { KokoroTTS } from 'https://esm.sh/kokoro-js';

    const MODEL_ID = "onnx-community/Kokoro-82M-v1.0-ONNX";

    // =============================================
    // CONFIGURATION
    // =============================================
    const VOICES = [
      { name: "af_heart", label: "Gentle", desc: "Warm bedtime voice", emoji: "ðŸŒ™", color: "from-violet-500 to-purple-600" },
      { name: "af_sky", label: "Cheerful", desc: "Bright & happy", emoji: "â˜€ï¸", color: "from-amber-400 to-orange-500" },
      { name: "bf_lily", label: "Soft", desc: "Calm & soothing", emoji: "ðŸŒ¸", color: "from-pink-400 to-rose-500" },
      { name: "am_puck", label: "Playful", desc: "Fun & silly", emoji: "ðŸŽ­", color: "from-emerald-400 to-teal-500" },
    ];

    const SPEEDS = [
      { label: "Slow & Cozy", value: 0.85, icon: Moon },
      { label: "Just Right", value: 1.0, icon: Heart },
      { label: "Energetic", value: 1.15, icon: Sun },
    ];

    const THEMES = [
      { id: 'default', label: 'Default', desc: 'Dark ambient', bg: 'from-slate-950 via-slate-900 to-slate-950', text: 'text-white', accent: 'indigo' },
      { id: 'high-contrast-wb', label: 'High Contrast', desc: 'White on Black', bg: 'from-black to-black', text: 'text-white', accent: 'white' },
      { id: 'high-contrast-yb', label: 'Yellow/Black', desc: 'Yellow on Black', bg: 'from-black to-black', text: 'text-yellow-400', accent: 'yellow' },
      { id: 'cream', label: 'Soft Cream', desc: 'Gentle on eyes', bg: 'from-amber-50 via-orange-50 to-amber-50', text: 'text-amber-950', accent: 'amber' },
    ];

    // Optimized yield - use requestIdleCallback when available for non-urgent work
    const yieldToBrowser = () => new Promise(r => requestAnimationFrame(() => setTimeout(r, 0)));
    const yieldIdle = (timeout = 100) => new Promise(r => {
      if (window.requestIdleCallback) {
        window.requestIdleCallback(r, { timeout });
      } else {
        setTimeout(r, 16);
      }
    });

    // Detect device capabilities
    const getDeviceInfo = () => {
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const hasWebGPU = !!navigator.gpu;
      const memory = navigator.deviceMemory || 4; // Default to 4GB if not available
      const cores = navigator.hardwareConcurrency || 4;

      return { isMobile, isSafari, isIOS, hasWebGPU, memory, cores };
    };

    // =============================================
    // AUDIO CUE ENGINE
    // =============================================
    const useAudioCues = (enabled, vibrationEnabled) => {
      const ctxRef = useRef(null);

      const getCtx = useCallback(() => {
        if (!ctxRef.current) {
          ctxRef.current = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (ctxRef.current.state === 'suspended') {
          ctxRef.current.resume().catch(() => { });
        }
        return ctxRef.current;
      }, []);

      const vibrate = useCallback((pattern) => {
        if (vibrationEnabled && navigator.vibrate) {
          try { navigator.vibrate(pattern); } catch (e) { }
        }
      }, [vibrationEnabled]);

      const play = useCallback((type) => {
        vibrate(type === 'tap' ? 25 : type === 'story_start' ? [40, 40, 80] : type === 'story_end' ? [80, 40, 80, 40, 150] : 15);

        if (!enabled) return;

        try {
          const ctx = getCtx();
          const now = ctx.currentTime;

          if (type === 'tap') {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, now);
            osc.frequency.exponentialRampToValueAtTime(1320, now + 0.05);
            gain.gain.setValueAtTime(0.12, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.08);
            osc.connect(gain).connect(ctx.destination);
            osc.start(now); osc.stop(now + 0.1);
          } else if (type === 'story_start') {
            [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              osc.type = 'triangle';
              osc.frequency.value = freq;
              gain.gain.setValueAtTime(0, now + i * 0.1);
              gain.gain.linearRampToValueAtTime(0.1, now + i * 0.1 + 0.03);
              gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.1 + 0.35);
              osc.connect(gain).connect(ctx.destination);
              osc.start(now + i * 0.1); osc.stop(now + i * 0.1 + 0.4);
            });
          } else if (type === 'ready') {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.value = 698.46;
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.06, now + 0.03);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
            osc.connect(gain).connect(ctx.destination);
            osc.start(now); osc.stop(now + 0.6);
          } else if (type === 'advance') {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(440, now);
            osc.frequency.exponentialRampToValueAtTime(660, now + 0.12);
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.05, now + 0.03);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
            osc.connect(gain).connect(ctx.destination);
            osc.start(now); osc.stop(now + 0.2);
          } else if (type === 'story_end') {
            [[523.25, 0], [659.25, 0.12], [783.99, 0.24], [1046.50, 0.36]].forEach(([freq, delay]) => {
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              osc.type = 'triangle';
              osc.frequency.value = freq;
              gain.gain.setValueAtTime(0, now + delay);
              gain.gain.linearRampToValueAtTime(0.12, now + delay + 0.02);
              gain.gain.exponentialRampToValueAtTime(0.001, now + delay + 0.5);
              osc.connect(gain).connect(ctx.destination);
              osc.start(now + delay); osc.stop(now + delay + 0.6);
            });
          } else if (type === 'busy') {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.value = 200;
            gain.gain.setValueAtTime(0.06, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
            osc.connect(gain).connect(ctx.destination);
            osc.start(now); osc.stop(now + 0.15);
          }
        } catch (e) {
          console.warn('Audio cue error:', e);
        }
      }, [enabled, getCtx, vibrate]);

      return { play, vibrate };
    };

    // =============================================
    // MAIN APPLICATION
    // =============================================
    const App = () => {
      const [mode, setMode] = useState('setup');
      const [storyTitle, setStoryTitle] = useState("The Brave Little Bear");
      const [rawText, setRawText] = useState("Once upon a time, there was a little bear who lived in a cozy cave.\nThe bear loved honey more than anything in the world.\nOne sunny morning, the bear smelled something sweet.\nIt was coming from a tall, tall tree!\nThe bear looked up and saw a beehive.\nBuzz buzz buzz, sang the busy bees.\nThe little bear was scared, but also very hungry.\nSo the bear took a deep breath and started to climb.\nUp, up, up went the brave little bear!\nThe bees flew around, but the bear kept going.\nFinally, the bear reached the golden honey.\nYum yum yum! It was the sweetest honey ever.\nThe bear climbed down with a happy, sticky smile.\nAnd from that day on, everyone called the bear the bravest in the forest.\nThe end.");
      const [sentences, setSentences] = useState([]);
      const [currentIndex, setCurrentIndex] = useState(-1);
      const [voice, setVoice] = useState(VOICES[0].name);
      const [speed, setSpeed] = useState(1.0);
      const [isTransitioning, setIsTransitioning] = useState(false);

      // Engine state
      const [engineMode, setEngineMode] = useState('kokoro'); // 'kokoro' | 'fallback'
      const [modelReady, setModelReady] = useState(false);
      const [modelProgress, setModelProgress] = useState(0);
      const [modelStatus, setModelStatus] = useState('');
      const [loadError, setLoadError] = useState(null);
      const [isGenerating, setIsGenerating] = useState(false);
      const [isPlaying, setIsPlaying] = useState(false);

      // Accessibility Settings
      const [showSettings, setShowSettings] = useState(false);
      const [soundCuesEnabled, setSoundCuesEnabled] = useState(true);
      const [vibrationEnabled, setVibrationEnabled] = useState(true);
      const [theme, setTheme] = useState('default');
      const [textSize, setTextSize] = useState('normal');

      // Exit button hold state
      const [isHoldingExit, setIsHoldingExit] = useState(false);
      const [holdProgress, setHoldProgress] = useState(0);
      const holdTimerRef = useRef(null);
      const holdStartRef = useRef(null);

      // Refs
      const ttsRef = useRef(null);
      const audioRef = useRef(null);
      const cacheRef = useRef({});
      const prefetchRef = useRef(new Set());
      const deviceInfoRef = useRef(getDeviceInfo());

      const { play: playCue } = useAudioCues(soundCuesEnabled, vibrationEnabled);
      const currentTheme = THEMES.find(t => t.id === theme) || THEMES[0];

      const getTextSizeClass = () => {
        if (textSize === 'huge') return 'text-4xl md:text-6xl lg:text-7xl';
        if (textSize === 'large') return 'text-3xl md:text-5xl lg:text-6xl';
        return 'text-2xl md:text-4xl lg:text-5xl';
      };

      // =============================================
      // KOKORO TTS ENGINE (Primary)
      // =============================================
      const loadKokoroModel = useCallback(async () => {
        if (ttsRef.current) {
          setModelReady(true);
          return true;
        }

        const device = deviceInfoRef.current;
        setLoadError(null);
        setModelProgress(0);
        setModelStatus('Initializing...');

        try {
          await yieldToBrowser();

          // Determine optimal settings based on device
          let useWebGPU = false;
          let dtype = 'q8'; // Default to q8 for stability

          // Only try WebGPU on desktop Chrome/Edge with good specs
          if (!device.isMobile && !device.isSafari && device.hasWebGPU && device.memory >= 8) {
            try {
              const adapter = await navigator.gpu.requestAdapter();
              if (adapter) {
                const gpuDevice = await adapter.requestDevice();
                gpuDevice.destroy();
                useWebGPU = true;
                dtype = 'fp32';
                setModelStatus('Using GPU acceleration...');
              }
            } catch (e) {
              console.warn('WebGPU not available:', e);
            }
          }

          // On mobile/low-memory devices, use smallest model
          if (device.isMobile || device.memory < 4) {
            dtype = 'q4';
            setModelStatus('Loading compact model...');
          } else {
            setModelStatus('Loading high-quality model...');
          }

          console.log(`Loading Kokoro TTS: device=${useWebGPU ? 'webgpu' : 'wasm'}, dtype=${dtype}`);

          const tts = await KokoroTTS.from_pretrained(MODEL_ID, {
            dtype,
            device: useWebGPU ? 'webgpu' : 'wasm',
            progress_callback: (p) => {
              if (p.status === 'progress' && p.total) {
                const pct = Math.round((p.loaded / p.total) * 100);
                setModelProgress(pct);
                if (pct < 30) setModelStatus('Downloading voice model...');
                else if (pct < 70) setModelStatus('Preparing voice engine...');
                else if (pct < 95) setModelStatus('Almost ready...');
                else setModelStatus('Finalizing...');
              }
            }
          });

          ttsRef.current = tts;
          setModelReady(true);
          setEngineMode('kokoro');
          console.log('Kokoro TTS loaded successfully');
          return true;

        } catch (error) {
          console.error('Kokoro TTS failed to load:', error);
          setLoadError(`Voice engine error: ${error.message || 'Unknown error'}`);
          return false;
        }
      }, []);

      // Generate audio with Kokoro
      const generateKokoroAudio = useCallback(async (text) => {
        if (!ttsRef.current) return null;
        try {
          await yieldIdle(50);
          const audio = await ttsRef.current.generate(text, { voice, speed });
          return URL.createObjectURL(audio.toBlob());
        } catch (error) {
          console.error('Kokoro generation error:', error);
          return null;
        }
      }, [voice, speed]);

      // =============================================
      // WEB SPEECH FALLBACK ENGINE
      // =============================================
      const speakWithFallback = useCallback((text) => {
        return new Promise((resolve, reject) => {
          if (!window.speechSynthesis) {
            reject(new Error('Speech synthesis not available'));
            return;
          }

          window.speechSynthesis.cancel();
          const utterance = new SpeechSynthesisUtterance(text);

          // Find a good English voice
          const voices = window.speechSynthesis.getVoices();
          const englishVoice = voices.find(v => v.lang.startsWith('en') && v.name.includes('Female'))
            || voices.find(v => v.lang.startsWith('en'))
            || voices[0];
          if (englishVoice) utterance.voice = englishVoice;

          utterance.rate = speed * 0.9;
          utterance.pitch = 1.0;
          utterance.onend = resolve;
          utterance.onerror = reject;

          window.speechSynthesis.speak(utterance);
        });
      }, [speed]);

      // =============================================
      // UNIFIED SPEECH SYSTEM
      // =============================================
      const prefetch = useCallback(async (startIdx, list) => {
        if (engineMode !== 'kokoro' || !ttsRef.current) return;

        // Prefetch next 2 sentences in background
        for (let i = startIdx; i < Math.min(startIdx + 2, list.length); i++) {
          if (cacheRef.current[i] || prefetchRef.current.has(i)) continue;

          prefetchRef.current.add(i);

          // Use idle callback for background prefetching
          await yieldIdle(200);

          try {
            const url = await generateKokoroAudio(list[i]);
            if (url) cacheRef.current[i] = url;
          } catch (e) {
            console.warn('Prefetch error:', e);
          }

          prefetchRef.current.delete(i);
        }
      }, [engineMode, generateKokoroAudio]);

      const playSentence = useCallback(async (idx, list) => {
        if (idx < 0 || idx >= list.length) return;

        // Stop current audio
        setIsPlaying(false);
        if (audioRef.current) {
          try { audioRef.current.pause(); audioRef.current.currentTime = 0; } catch (e) { }
        }
        window.speechSynthesis?.cancel();

        const text = list[idx];

        // Try Kokoro first
        if (engineMode === 'kokoro' && ttsRef.current) {
          let url = cacheRef.current[idx];

          if (!url) {
            setIsGenerating(true);
            url = await generateKokoroAudio(text);
            if (url) cacheRef.current[idx] = url;
            setIsGenerating(false);
          }

          if (url && audioRef.current) {
            try {
              audioRef.current.src = url;
              await audioRef.current.play();
              setIsPlaying(true);
              prefetch(idx + 1, list);
              return;
            } catch (e) {
              console.warn('Kokoro playback failed, trying fallback:', e);
            }
          }
        }

        // Fallback to Web Speech
        console.log('Using Web Speech fallback');
        setEngineMode('fallback');
        setIsPlaying(true);

        try {
          await speakWithFallback(text);
        } catch (e) {
          console.error('Fallback speech error:', e);
        }

        setIsPlaying(false);
        playCue('ready');
      }, [engineMode, generateKokoroAudio, speakWithFallback, prefetch, playCue]);

      // Audio ended handler
      const handleAudioEnded = useCallback(() => {
        setIsPlaying(false);
        if (currentIndex >= 0 && currentIndex < sentences.length) {
          playCue('ready');
        }
      }, [currentIndex, sentences.length, playCue]);

      // Exit button hold logic
      const startHoldExit = (e) => {
        e.stopPropagation();
        setIsHoldingExit(true);
        holdStartRef.current = Date.now();

        const updateProgress = () => {
          const elapsed = Date.now() - holdStartRef.current;
          const progress = Math.min((elapsed / 2000) * 100, 100);
          setHoldProgress(progress);

          if (progress >= 100) {
            exitStory();
            endHoldExit();
          } else {
            holdTimerRef.current = requestAnimationFrame(updateProgress);
          }
        };
        holdTimerRef.current = requestAnimationFrame(updateProgress);
      };

      const endHoldExit = () => {
        setIsHoldingExit(false);
        setHoldProgress(0);
        if (holdTimerRef.current) {
          cancelAnimationFrame(holdTimerRef.current);
          holdTimerRef.current = null;
        }
      };

      // Main tap handler
      const handleTap = useCallback(() => {
        if (isGenerating || isTransitioning) { playCue('busy'); return; }
        if (isPlaying) { playCue('busy'); return; }

        playCue('tap');
        setIsTransitioning(true);

        const nextIndex = currentIndex + 1;

        if (currentIndex === -1) {
          playCue('story_start');
          setTimeout(() => {
            setCurrentIndex(0);
            playSentence(0, sentences);
            setIsTransitioning(false);
          }, 500);
          return;
        }

        if (nextIndex >= sentences.length) {
          playCue('story_end');
          setTimeout(() => {
            setCurrentIndex(sentences.length);
            setIsTransitioning(false);
          }, 100);
          return;
        }

        playCue('advance');
        setTimeout(() => {
          setCurrentIndex(nextIndex);
          playSentence(nextIndex, sentences);
          setIsTransitioning(false);
        }, 150);
      }, [currentIndex, sentences, isGenerating, isPlaying, isTransitioning, playCue, playSentence]);

      // Start story
      const startStory = async () => {
        const allSentences = [];
        rawText.split('\n').forEach(line => {
          (line.match(/[^.!?]+[.!?]+|[^.!?]+$/g) || []).forEach(s => {
            const c = s.trim();
            if (c) allSentences.push(c);
          });
        });
        if (!allSentences.length) return;

        // Clear old cache
        Object.values(cacheRef.current).forEach(url => {
          try { URL.revokeObjectURL(url); } catch (e) { }
        });
        cacheRef.current = {};
        prefetchRef.current.clear();

        setSentences(allSentences);
        setCurrentIndex(-1);

        // Load model if needed
        if (!ttsRef.current) {
          setMode('loading');
          const success = await loadKokoroModel();
          if (!success) {
            // Fall back to Web Speech
            setEngineMode('fallback');
            setModelReady(true);
          }
        }

        setMode('reading');

        // Start prefetching first sentences
        setTimeout(() => prefetch(0, allSentences), 100);
      };

      // Exit story
      const exitStory = () => {
        if (audioRef.current) {
          try { audioRef.current.pause(); audioRef.current.src = ''; } catch (e) { }
        }
        window.speechSynthesis?.cancel();
        setMode('setup');
        setCurrentIndex(-1);
        setIsPlaying(false);
        setIsGenerating(false);
      };

      // =============================================
      // SETTINGS MODAL
      // =============================================
      const SettingsModal = () => (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" onClick={() => setShowSettings(false)}>
          <div className="bg-white rounded-3xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
            <div className="p-6 border-b border-slate-100 flex items-center justify-between">
              <h2 className="text-xl font-bold text-slate-800">Accessibility Settings</h2>
              <button onClick={() => setShowSettings(false)} className="p-2 hover:bg-slate-100 rounded-full transition-colors">
                <X size={20} className="text-slate-500" />
              </button>
            </div>

            <div className="p-6 space-y-6">
              {/* Sound Cues */}
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-xl bg-indigo-100 flex items-center justify-center">
                    {soundCuesEnabled ? <Volume2 size={20} className="text-indigo-600" /> : <VolumeX size={20} className="text-slate-400" />}
                  </div>
                  <div>
                    <div className="font-bold text-slate-800">Sound Cues</div>
                    <div className="text-sm text-slate-500">Audio feedback on taps</div>
                  </div>
                </div>
                <button onClick={() => setSoundCuesEnabled(!soundCuesEnabled)} className={`w-14 h-8 rounded-full transition-colors relative ${soundCuesEnabled ? 'bg-indigo-500' : 'bg-slate-200'}`}>
                  <div className={`absolute top-1 w-6 h-6 bg-white rounded-full shadow transition-all ${soundCuesEnabled ? 'left-7' : 'left-1'}`} />
                </button>
              </div>

              {/* Vibration */}
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-xl bg-purple-100 flex items-center justify-center">
                    <Vibrate size={20} className="text-purple-600" />
                  </div>
                  <div>
                    <div className="font-bold text-slate-800">Vibration</div>
                    <div className="text-sm text-slate-500">Haptic feedback on taps</div>
                  </div>
                </div>
                <button onClick={() => setVibrationEnabled(!vibrationEnabled)} className={`w-14 h-8 rounded-full transition-colors relative ${vibrationEnabled ? 'bg-purple-500' : 'bg-slate-200'}`}>
                  <div className={`absolute top-1 w-6 h-6 bg-white rounded-full shadow transition-all ${vibrationEnabled ? 'left-7' : 'left-1'}`} />
                </button>
              </div>

              {/* Visual Theme */}
              <div className="space-y-3">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-xl bg-amber-100 flex items-center justify-center">
                    <Palette size={20} className="text-amber-600" />
                  </div>
                  <div>
                    <div className="font-bold text-slate-800">Visual Theme</div>
                    <div className="text-sm text-slate-500">Reading appearance</div>
                  </div>
                </div>
                <div className="grid grid-cols-2 gap-2 mt-3">
                  {THEMES.map(t => (
                    <button key={t.id} onClick={() => setTheme(t.id)} className={`p-3 rounded-xl border-2 text-left transition-all ${theme === t.id ? 'border-indigo-500 bg-indigo-50' : 'border-slate-100 hover:bg-slate-50'}`}>
                      <div className={`w-full h-6 rounded-lg bg-gradient-to-r ${t.bg} mb-2 border border-slate-200`} />
                      <div className="font-bold text-sm text-slate-800">{t.label}</div>
                      <div className="text-xs text-slate-500">{t.desc}</div>
                    </button>
                  ))}
                </div>
              </div>

              {/* Text Size */}
              <div className="space-y-3">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-xl bg-emerald-100 flex items-center justify-center">
                    <Eye size={20} className="text-emerald-600" />
                  </div>
                  <div>
                    <div className="font-bold text-slate-800">Text Size</div>
                    <div className="text-sm text-slate-500">Story text size</div>
                  </div>
                </div>
                <div className="flex gap-2 mt-3">
                  {[{ id: 'normal', label: 'Normal' }, { id: 'large', label: 'Large' }, { id: 'huge', label: 'Huge' }].map(s => (
                    <button key={s.id} onClick={() => setTextSize(s.id)} className={`flex-1 p-3 rounded-xl border-2 text-center transition-all ${textSize === s.id ? 'border-indigo-500 bg-indigo-50' : 'border-slate-100 hover:bg-slate-50'}`}>
                      <div className={`font-bold mb-1 ${s.id === 'huge' ? 'text-2xl' : s.id === 'large' ? 'text-xl' : 'text-base'}`}>Aa</div>
                      <div className="text-xs text-slate-500">{s.label}</div>
                    </button>
                  ))}
                </div>
              </div>
            </div>

            <div className="p-6 border-t border-slate-100">
              <button onClick={() => setShowSettings(false)} className="w-full py-3 bg-indigo-500 text-white font-bold rounded-xl hover:bg-indigo-600 transition-colors">Done</button>
            </div>
          </div>
        </div>
      );

      // =============================================
      // LOADING SCREEN
      // =============================================
      if (mode === 'loading') {
        return (
          <div className="fixed inset-0 bg-gradient-to-br from-slate-900 via-indigo-950 to-slate-900 flex flex-col items-center justify-center p-8">
            <div className="relative mb-8">
              <div className="w-24 h-24 rounded-3xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-2xl shadow-indigo-500/30">
                <Wand2 size={40} className="text-white animate-pulse" />
              </div>
            </div>
            <h2 className="text-2xl font-extrabold text-white mb-2">Preparing Magic Voice</h2>
            <p className="text-indigo-300 text-sm mb-6">{modelStatus || 'This only happens once...'}</p>
            <div className="w-64 h-2 bg-slate-800 rounded-full overflow-hidden">
              <div className="h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-300 rounded-full" style={{ width: `${modelProgress}%` }} />
            </div>
            <p className="text-indigo-400 mt-3 font-bold">{modelProgress}%</p>

            {loadError && (
              <div className="mt-6 bg-amber-900/50 text-amber-200 p-4 rounded-xl max-w-md text-center">
                <AlertTriangle className="mx-auto mb-2" size={24} />
                <p className="text-sm">{loadError}</p>
                <p className="text-xs mt-2 opacity-75">Switching to backup voice...</p>
              </div>
            )}
          </div>
        );
      }

      // =============================================
      // PARENT SETUP SCREEN
      // =============================================
      if (mode === 'setup') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-50 via-indigo-50/30 to-purple-50/30 p-4 md:p-8">
            {showSettings && <SettingsModal />}

            <div className="max-w-2xl mx-auto space-y-6">
              <header className="flex items-center justify-between mb-8">
                <div className="flex items-center gap-4">
                  <div className="relative">
                    <div className="w-14 h-14 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-xl shadow-indigo-200">
                      <BookOpen className="text-white" size={28} />
                    </div>
                    <div className="absolute -top-1 -right-1 w-5 h-5 bg-gradient-to-br from-amber-400 to-orange-500 rounded-full flex items-center justify-center">
                      <Star className="text-white" size={12} fill="white" />
                    </div>
                  </div>
                  <div>
                    <h1 className="text-2xl font-black bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">StoryTap</h1>
                    <p className="text-sm text-slate-500 font-medium">Touch stories for little ones</p>
                  </div>
                </div>
                <button onClick={() => setShowSettings(true)} className="p-3 bg-white rounded-xl shadow-md hover:shadow-lg transition-all border border-slate-100">
                  <Settings size={22} className="text-slate-600" />
                </button>
              </header>

              <div className="bg-gradient-to-r from-indigo-500 to-purple-500 rounded-2xl p-4 text-white shadow-lg shadow-indigo-200">
                <div className="flex items-start gap-3">
                  <div className="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center flex-shrink-0">
                    <Volume2 size={20} />
                  </div>
                  <div>
                    <h3 className="font-bold mb-1">Designed for Blind Children</h3>
                    <p className="text-sm text-white/80">Your child taps anywhere to hear each sentence with audio cues and vibrations.</p>
                  </div>
                </div>
              </div>

              {modelReady && (
                <div className="flex items-center justify-center gap-2 text-emerald-600 bg-emerald-50 rounded-full py-2 px-4 mx-auto w-fit">
                  <Check size={16} strokeWidth={3} />
                  <span className="text-sm font-bold">{engineMode === 'kokoro' ? 'Premium voice ready' : 'Voice ready'}</span>
                </div>
              )}

              <div className="bg-white rounded-[2rem] shadow-xl shadow-slate-200/50 p-6 md:p-8 space-y-8 border border-slate-100">
                <div className="space-y-2">
                  <label className="text-xs font-bold text-slate-400 uppercase tracking-wide">Story Title</label>
                  <input type="text" value={storyTitle} onChange={e => setStoryTitle(e.target.value)} className="w-full p-4 rounded-xl border-2 border-slate-100 text-xl font-bold text-slate-800 focus:border-indigo-300 focus:outline-none transition-colors bg-slate-50/50" placeholder="Once Upon a Time..." />
                </div>

                <div className="space-y-2">
                  <label className="text-xs font-bold text-slate-400 uppercase tracking-wide">Story Text</label>
                  <textarea value={rawText} onChange={e => setRawText(e.target.value)} className="w-full min-h-[180px] p-4 rounded-xl border-2 border-slate-100 text-base leading-relaxed text-slate-700 focus:border-indigo-300 focus:outline-none transition-colors bg-slate-50/50 font-serif" placeholder="Paste or type your story here..." />
                </div>

                <div className="space-y-3">
                  <label className="text-xs font-bold text-slate-400 uppercase tracking-wide">Narrator Voice</label>
                  <div className="grid grid-cols-2 gap-3">
                    {VOICES.map(v => (
                      <button key={v.name} onClick={() => setVoice(v.name)} className={`relative p-4 rounded-2xl border-2 text-left transition-all overflow-hidden group ${voice === v.name ? 'border-indigo-500 shadow-lg shadow-indigo-100' : 'border-slate-100 hover:border-slate-200'}`}>
                        <div className={`absolute inset-0 bg-gradient-to-br ${v.color} opacity-0 group-hover:opacity-5 transition-opacity ${voice === v.name ? 'opacity-10' : ''}`} />
                        <div className="relative flex items-center gap-3">
                          <span className="text-2xl">{v.emoji}</span>
                          <div>
                            <div className="font-bold text-slate-800">{v.label}</div>
                            <div className="text-xs text-slate-400">{v.desc}</div>
                          </div>
                        </div>
                        {voice === v.name && <div className="absolute top-2 right-2 w-5 h-5 bg-indigo-500 rounded-full flex items-center justify-center"><Check size={12} className="text-white" /></div>}
                      </button>
                    ))}
                  </div>
                </div>

                <div className="space-y-3">
                  <label className="text-xs font-bold text-slate-400 uppercase tracking-wide">Reading Speed</label>
                  <div className="flex gap-2">
                    {SPEEDS.map(s => {
                      const Icon = s.icon;
                      return (
                        <button key={s.value} onClick={() => setSpeed(s.value)} className={`flex-1 p-4 rounded-xl border-2 text-center transition-all ${speed === s.value ? 'border-indigo-500 bg-indigo-50 text-indigo-700' : 'border-slate-100 text-slate-500 hover:border-slate-200'}`}>
                          <Icon size={20} className="mx-auto mb-1" />
                          <div className="font-bold text-sm">{s.label}</div>
                        </button>
                      );
                    })}
                  </div>
                </div>

                <button onClick={startStory} disabled={!rawText.trim()} className="w-full bg-gradient-to-r from-indigo-500 via-purple-500 to-indigo-500 bg-[length:200%_100%] hover:bg-right text-white font-extrabold py-5 rounded-2xl text-xl flex items-center justify-center gap-3 shadow-xl shadow-indigo-200 transition-all duration-500 disabled:opacity-50">
                  <Play fill="white" size={24} />
                  Give to Child
                </button>
              </div>
            </div>
          </div>
        );
      }

      // =============================================
      // READING MODE
      // =============================================
      const isCover = currentIndex === -1;
      const isEnd = currentIndex >= sentences.length;
      const isReading = !isCover && !isEnd;
      const progress = sentences.length ? ((currentIndex + 1) / sentences.length) * 100 : 0;

      return (
        <div onClick={handleTap} className="fixed inset-0 select-none touch-none cursor-pointer overflow-hidden">
          <audio ref={audioRef} onEnded={handleAudioEnded} hidden />

          <div className="absolute top-4 left-4 z-50">
            <button onMouseDown={startHoldExit} onMouseUp={endHoldExit} onMouseLeave={endHoldExit} onTouchStart={startHoldExit} onTouchEnd={endHoldExit} onTouchCancel={endHoldExit} className="relative p-3 bg-white/10 hover:bg-white/20 rounded-full text-white/40 hover:text-white/70 transition-all">
              {isHoldingExit && (
                <svg className="absolute inset-0 w-full h-full -rotate-90" viewBox="0 0 36 36">
                  <circle cx="18" cy="18" r="16" fill="none" stroke="white" strokeWidth="2" strokeOpacity="0.2" />
                  <circle cx="18" cy="18" r="16" fill="none" stroke="white" strokeWidth="2" strokeDasharray="100" strokeDashoffset={100 - holdProgress} strokeLinecap="round" />
                </svg>
              )}
              <ArrowLeft size={18} />
            </button>
            {isHoldingExit && <div className="absolute left-12 top-1/2 -translate-y-1/2 bg-black/80 text-white text-xs px-3 py-1.5 rounded-lg whitespace-nowrap">Hold to exit...</div>}
          </div>

          {isCover && (
            <div className={`absolute inset-0 bg-gradient-to-br ${theme === 'cream' ? 'from-amber-100 via-orange-50 to-amber-100' : 'from-indigo-900 via-purple-900 to-slate-900'} flex flex-col items-center justify-center p-8`}>
              <div className="absolute inset-0 overflow-hidden pointer-events-none">
                <div className="absolute top-1/4 left-1/4 w-96 h-96 bg-indigo-500/30 rounded-full blur-3xl ambient-orb" />
                <div className="absolute bottom-1/4 right-1/4 w-80 h-80 bg-purple-500/30 rounded-full blur-3xl ambient-orb-2" />
              </div>
              <div className="relative mb-10 fade-in-up">
                <div className="w-32 h-40 bg-gradient-to-br from-white/10 to-white/5 rounded-2xl flex items-center justify-center border border-white/10 glow backdrop-blur-sm">
                  <BookOpen size={56} className={theme === 'cream' ? 'text-amber-800' : 'text-white/80'} />
                </div>
              </div>
              <h1 className={`text-4xl md:text-6xl font-black text-center mb-4 leading-tight fade-in-up ${theme === 'cream' ? 'text-amber-900' : 'text-white'}`}>{storyTitle}</h1>
              <p className={`text-lg mb-16 fade-in-up ${theme === 'cream' ? 'text-amber-700' : 'text-white/50'}`}>A Story for You</p>
              <div className="flex flex-col items-center fade-in-up">
                <div className="relative">
                  <div className={`absolute inset-0 w-24 h-24 rounded-full pulse-ring ${theme === 'cream' ? 'bg-amber-300/30' : 'bg-white/10'}`} />
                  <div className={`w-24 h-24 rounded-full flex items-center justify-center border backdrop-blur-sm ${theme === 'cream' ? 'bg-amber-200/50 border-amber-300' : 'bg-white/10 border-white/20'}`}>
                    <Volume2 size={36} className={theme === 'cream' ? 'text-amber-800' : 'text-white'} />
                  </div>
                </div>
                <span className={`font-bold text-lg mt-6 uppercase tracking-widest ${theme === 'cream' ? 'text-amber-700' : 'text-white/70'}`}>Tap Anywhere</span>
              </div>
            </div>
          )}

          {isReading && (
            <div className={`absolute inset-0 bg-gradient-to-b ${currentTheme.bg} flex flex-col items-center justify-center p-6 md:p-16`}>
              {isGenerating && (
                <div className="absolute inset-0 flex items-center justify-center bg-black/50 z-20 backdrop-blur-sm">
                  <Loader2 className={`w-12 h-12 animate-spin ${currentTheme.text}`} />
                </div>
              )}
              <div className={`relative max-w-4xl mx-auto ${isTransitioning ? 'page-turn' : ''}`}>
                <p className={`${getTextSizeClass()} font-serif font-medium text-center leading-relaxed tracking-wide ${currentTheme.text}`}>{sentences[currentIndex]}</p>
              </div>
              <div className="absolute bottom-0 left-0 right-0 p-8 flex flex-col items-center gap-6">
                {isPlaying ? (
                  <div className={`flex items-center gap-3 ${currentTheme.text} opacity-60`}>
                    <div className="flex gap-1">{[...Array(4)].map((_, i) => (<div key={i} className={`w-1 rounded-full animate-pulse ${theme === 'default' ? 'bg-indigo-400' : theme === 'high-contrast-yb' ? 'bg-yellow-400' : theme === 'cream' ? 'bg-amber-600' : 'bg-white'}`} style={{ height: `${12 + Math.random() * 12}px`, animationDelay: `${i * 0.1}s` }} />))}</div>
                    <span className="text-sm font-semibold uppercase tracking-wider">Listening...</span>
                  </div>
                ) : !isGenerating && (
                  <div className={`flex items-center gap-2 opacity-40 animate-pulse ${currentTheme.text}`}>
                    <span className="text-sm font-semibold uppercase tracking-wider">Tap for next</span>
                  </div>
                )}
                <div className="w-full max-w-xs">
                  <div className={`h-1 rounded-full overflow-hidden ${theme === 'cream' ? 'bg-amber-200' : 'bg-white/10'}`}>
                    <div className={`h-full transition-all duration-500 rounded-full ${theme === 'default' ? 'bg-indigo-500' : theme === 'high-contrast-yb' ? 'bg-yellow-400' : theme === 'cream' ? 'bg-amber-600' : 'bg-white'}`} style={{ width: `${progress}%` }} />
                  </div>
                  <p className={`text-center text-xs mt-2 font-medium ${currentTheme.text} opacity-30`}>{currentIndex + 1} of {sentences.length}</p>
                </div>
              </div>
            </div>
          )}

          {isEnd && (
            <div className="absolute inset-0 bg-gradient-to-br from-amber-400 via-orange-500 to-rose-500 flex flex-col items-center justify-center p-8">
              <div className="absolute inset-0 overflow-hidden pointer-events-none">{[...Array(12)].map((_, i) => (<Sparkles key={i} size={16 + i * 2} className="absolute text-white/40 burst" style={{ top: `${20 + Math.random() * 60}%`, left: `${10 + Math.random() * 80}%`, animationDelay: `${i * 0.1}s` }} />))}</div>
              <Sparkles size={80} className="text-white animate-bounce mb-8" />
              <h2 className="text-5xl md:text-7xl font-black text-white text-center mb-4">The End!</h2>
              <p className="text-white/80 text-xl mb-16">What a great story!</p>
              <div className="flex flex-col items-center">
                <div className="w-20 h-20 rounded-full bg-white/20 flex items-center justify-center mb-4 pulse-ring"><Heart size={36} className="text-white" fill="white" /></div>
                <span className="text-white/80 font-bold text-lg uppercase tracking-wider">Tap to Start Over</span>
              </div>
            </div>
          )}
        </div>
      );
    };

    createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>

</html>