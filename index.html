<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, minimum-scale=1.0, shrink-to-fit=no, viewport-fit=cover" />
  <meta name="theme-color" content="#6366f1" />
  <!-- iOS PWA fullscreen support -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="StoryTap" />
  <!-- Android PWA fullscreen support -->
  <meta name="mobile-web-app-capable" content="yes" />
  <!-- Prevent auto-formatting of phone numbers/addresses -->
  <meta name="format-detection" content="telephone=no, address=no, email=no" />
  <!-- SEO -->
  <meta name="description" content="Interactive touch stories for children with accessibility features." />
  <title>StoryTap â€” Touch Books for Little Ones</title>
  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/svg+xml" href="icon.svg" />
  <link rel="apple-touch-icon" href="icon.svg" />
  <!-- Preconnect for faster font loading -->
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">
  <link rel="dns-prefetch" href="https://huggingface.co">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://huggingface.co" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Crimson+Pro:wght@400;500;600&display=swap"
    rel="stylesheet">
  <script src="https://cdn.tailwindcss.com/3.4.16"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Nunito', 'system-ui', 'sans-serif'],
            serif: ['Crimson Pro', 'Georgia', 'serif'],
          },
        },
      },
    };
  </script>
  <style>
    /* ================================================
       PERFORMANCE & ACCESSIBILITY OPTIMIZATIONS
       ================================================ */
    * {
      -webkit-tap-highlight-color: transparent;
      /* Hint to browser for smoother animations */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Reduce animations for users who prefer reduced motion */
    @media (prefers-reduced-motion: reduce) {

      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* ================================================
       FULLSCREEN PWA BODY STYLES
       ================================================ */
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      /* Prevent text size inflation on mobile browsers (especially Firefox) */
      -webkit-text-size-adjust: 100%;
      -moz-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }

    body {
      font-family: 'Nunito', sans-serif;
      /* Safe area insets for notched devices */
      padding-top: env(safe-area-inset-top, 0px);
      padding-bottom: env(safe-area-inset-bottom, 0px);
      padding-left: env(safe-area-inset-left, 0px);
      padding-right: env(safe-area-inset-right, 0px);
      -webkit-user-select: none;
      user-select: none;
      -webkit-overflow-scrolling: touch;
    }

    /* Root container */
    #root {
      width: 100%;
      min-height: 100dvh;
    }

    input,
    textarea {
      -webkit-user-select: text;
      user-select: text;
      /* Prevent iOS zoom on input focus */
      font-size: 16px !important;
    }

    /* ================================================
       ORIENTATION-SPECIFIC STYLES
       ================================================ */
    @keyframes pulse-ring {
      0% {
        transform: scale(0.8);
        opacity: 0.8;
      }

      50% {
        transform: scale(1);
        opacity: 0.4;
      }

      100% {
        transform: scale(0.8);
        opacity: 0.8;
      }
    }

    .pulse-ring {
      animation: pulse-ring 2s ease-in-out infinite;
    }

    @keyframes glow {

      0%,
      100% {
        box-shadow: 0 0 30px rgba(255, 255, 255, 0.1);
      }

      50% {
        box-shadow: 0 0 60px rgba(255, 255, 255, 0.2);
      }
    }

    .glow {
      animation: glow 3s ease-in-out infinite;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in-up {
      animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    @keyframes pageTurn {
      0% {
        opacity: 1;
        transform: translateX(0);
      }

      50% {
        opacity: 0;
        transform: translateX(50px);
      }

      51% {
        opacity: 0;
        transform: translateX(-50px);
      }

      100% {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .page-turn {
      animation: pageTurn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Coverflow card selection pulse */
    @keyframes coverflow-pulse {

      0%,
      100% {
        outline-offset: 6px;
      }

      50% {
        outline-offset: 10px;
      }
    }

    .coverflow-selected {
      animation: coverflow-pulse 2s ease-in-out infinite;
    }

    /* Custom Scrollbar for Settings */
    .settings-scroll::-webkit-scrollbar {
      width: 8px;
    }

    .settings-scroll::-webkit-scrollbar-track {
      background: transparent;
    }

    .settings-scroll::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
      border: 2px solid transparent;
      background-clip: content-box;
    }

    .settings-scroll::-webkit-scrollbar-thumb:hover {
      background-color: rgba(0, 0, 0, 0.4);
    }

    /* High contrast scrollbar override */
    .high-contrast .settings-scroll::-webkit-scrollbar-thumb {
      background-color: rgba(255, 255, 255, 0.4);
    }

    .high-contrast .settings-scroll::-webkit-scrollbar-thumb:hover {
      background-color: rgba(255, 255, 255, 0.6);
    }
  </style>
  <script src="quickstories.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useRef, useCallback, useMemo } from 'https://esm.sh/react@18.3.1';
    import { createRoot } from 'https://esm.sh/react-dom@18.3.1/client';
    import { BookOpen, Play, Volume2, VolumeX, Sparkles, ArrowLeft, Loader2, Check, Star, Heart, Moon, Sun, Wand2, Settings, X, Eye, Vibrate, Palette, AlertTriangle, Trash2, Plus, Download, Pencil, SkipForward, Lock, Unlock, Layout, Type, RefreshCw, StopCircle, PenTool, Maximize2, Minimize2, Database } from 'https://esm.sh/lucide-react?deps=react@18.3.1,react-dom@18.3.1';
    import { KokoroTTS } from 'https://esm.sh/kokoro-js';

    const MODEL_ID = "onnx-community/Kokoro-82M-v1.0-ONNX";

    // =============================================
    // CONFIGURATION
    // =============================================
    const VOICES = [
      { name: "af_heart", label: "Warm & Gentle", desc: "Natural Storyteller", emoji: "ðŸŒ™", color: "bg-violet-500" },
    ];

    // Speed is now locked to Natural (1.0) for best pronunciation
    const NATURAL_SPEED = 1.0;

    const THEMES = [
      {
        id: 'default',
        label: 'Default',
        desc: 'Clean & Crisp',
        bg: 'bg-slate-900', // Flat
        text: 'text-white',
        accent: 'indigo',
        progress: 'bg-indigo-500',
        coverBg: 'bg-slate-900', // Flat
        coverText: 'text-white',
        coverSub: 'text-indigo-200',
        pulse: 'bg-white/10',
        coverBorder: 'border-white', // High Contrast
        coverElementBg: 'bg-white/5',
        readingDark: true,

        // PWA & Setup Screen
        pageBg: 'bg-slate-50',
        cardBg: 'bg-white',
        textMain: 'text-slate-900',
        textSub: 'text-slate-700',
        border: 'border-slate-300',
        inputBg: 'bg-slate-50',
        highlight: 'indigo',
        highlightBorder: 'border-indigo-500',
        highlightBgLight: 'bg-indigo-50',
        highlightFocus: 'focus:border-indigo-500',
        highlightRing: 'ring-indigo-200',
        highlightText: 'text-indigo-600'
      },
      {
        id: 'buff',
        label: 'Buff',
        desc: 'Easy on Eyes',
        bg: 'bg-[#F0EAD6]', // Buff Color
        text: 'text-black', // Black text
        accent: 'stone',
        progress: 'bg-black', // Black progress
        coverBg: 'bg-[#F0EAD6]', // Buff Color
        coverText: 'text-black', // Black text
        coverSub: 'text-stone-800', // Dark subtext
        pulse: 'bg-black/10',
        coverBorder: 'border-black', // Black border
        coverElementBg: 'bg-black', // Solid black for icon visibility
        readingDark: false,

        // PWA & Setup Screen
        pageBg: 'bg-[#F5F5DC]', // Beige
        cardBg: 'bg-[#F0EAD6]', // Buff
        textMain: 'text-black', // Black text
        textSub: 'text-stone-800',
        border: 'border-black',
        inputBg: 'bg-white',
        highlight: 'stone',
        highlightBorder: 'border-stone-500',
        highlightBgLight: 'bg-stone-100',
        highlightFocus: 'focus:border-stone-500',
        highlightRing: 'ring-stone-300',
        highlightText: 'text-stone-700'
      },
      {
        id: 'calm',
        label: 'Calm Sky',
        desc: 'Peaceful Blue',
        bg: 'bg-blue-50', // Flat
        text: 'text-slate-900', // Darker text for contrast on light bg
        accent: 'sky',
        progress: 'bg-sky-600',
        coverBg: 'bg-sky-100', // Flat
        coverText: 'text-sky-950',
        coverSub: 'text-sky-950', // Darker
        pulse: 'bg-sky-500/10',
        coverBorder: 'border-sky-900', // High Contrast
        coverElementBg: 'bg-black', // Solid black for icon visibility
        readingDark: false,

        // PWA & Setup Screen
        pageBg: 'bg-slate-50',
        cardBg: 'bg-white',
        textMain: 'text-slate-900',
        textSub: 'text-slate-700',
        border: 'border-sky-700', // Darker for contrast
        inputBg: 'bg-sky-50',
        highlight: 'sky',
        highlightBorder: 'border-sky-500',
        highlightBgLight: 'bg-sky-50',
        highlightFocus: 'focus:border-sky-500',
        highlightRing: 'ring-sky-200',
        highlightText: 'text-sky-600'
      },
      {
        id: 'high-contrast-wb',
        label: 'High Contrast',
        desc: 'White on Black',
        bg: 'bg-black', // Flat
        text: 'text-white',
        accent: 'white',
        progress: 'bg-white',
        coverBg: 'bg-black', // Flat
        coverText: 'text-white',
        coverSub: 'text-white',
        pulse: 'bg-white/20',
        coverBorder: 'border-white',
        coverElementBg: 'bg-transparent',
        readingDark: true,

        // PWA & Setup Screen
        pageBg: 'bg-black',
        cardBg: 'bg-zinc-900',
        textMain: 'text-white',
        textSub: 'text-slate-300',
        border: 'border-white',
        inputBg: 'bg-black',
        highlight: 'white',
        highlightBorder: 'border-white',
        highlightBgLight: 'bg-white/10',
        highlightFocus: 'focus:border-white',
        highlightRing: 'ring-white/30',
        highlightText: 'text-white'
      },
      {
        id: 'high-contrast-yb',
        label: 'Yellow on Black',
        desc: 'Accessibility',
        bg: 'bg-black', // Flat
        text: 'text-yellow-400',
        accent: 'yellow',
        progress: 'bg-yellow-400',
        coverBg: 'bg-black', // Flat
        coverText: 'text-yellow-400',
        coverSub: 'text-yellow-400/80',
        pulse: 'bg-yellow-400/20',
        coverBorder: 'border-yellow-400',
        coverElementBg: 'bg-transparent',
        readingDark: true,

        // PWA & Setup Screen
        pageBg: 'bg-black',
        cardBg: 'bg-zinc-900',
        textMain: 'text-yellow-400',
        textSub: 'text-yellow-200',
        border: 'border-yellow-400',
        inputBg: 'bg-black',
        highlight: 'yellow',
        highlightBorder: 'border-yellow-400',
        highlightBgLight: 'bg-yellow-400/10',
        highlightFocus: 'focus:border-yellow-400',
        highlightRing: 'ring-yellow-200',
        highlightText: 'text-yellow-400'
      }
    ];

    // Optimized yield - use requestIdleCallback when available for non-urgent work
    const yieldToBrowser = () => new Promise(r => requestAnimationFrame(() => setTimeout(r, 0)));
    const yieldIdle = (timeout = 100) => new Promise(r => {
      if (window.requestIdleCallback) {
        window.requestIdleCallback(r, { timeout });
      } else {
        setTimeout(r, 16);
      }
    });

    // Detect device capabilities
    const getDeviceInfo = () => {
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const hasWebGPU = !!navigator.gpu;
      const memory = navigator.deviceMemory || 4; // Default to 4GB if not available
      const cores = navigator.hardwareConcurrency || 4;

      return { isMobile, isSafari, isIOS, hasWebGPU, memory, cores };
    };

    // =============================================
    // FULLSCREEN API (Cross-browser)
    // =============================================
    const isFullscreen = () => {
      return !!(
        document.fullscreenElement ||
        document.webkitFullscreenElement ||
        document.mozFullScreenElement ||
        document.msFullscreenElement
      );
    };

    // Check if running as installed PWA (standalone mode)
    const isStandalone = () => {
      return window.matchMedia('(display-mode: standalone)').matches ||
        window.matchMedia('(display-mode: fullscreen)').matches ||
        window.navigator.standalone === true; // iOS Safari
    };
    // =============================================
    // AUDIO CACHE SYSTEM (IndexedDB)
    // =============================================
    const DB_NAME = 'StoryTapAudioCache';
    const DB_VERSION = 2; // Upgraded to support LRU
    const STORE_NAME = 'audio_v2';
    const MAX_ITEMS = 300; // Limit to ~15MB of audio

    // Cache the IndexedDB connection to avoid opening a new one on every read/write
    let _dbInstance = null;
    const openDB = () => {
      if (_dbInstance) return Promise.resolve(_dbInstance);
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          _dbInstance = request.result;
          // Reset cached instance if the connection closes unexpectedly
          _dbInstance.onclose = () => { _dbInstance = null; };
          resolve(_dbInstance);
        };
        request.onupgradeneeded = (e) => {
          const db = e.target.result;
          // Clean up old v1 store if exists
          if (db.objectStoreNames.contains('audio')) {
            db.deleteObjectStore('audio');
          }
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            const store = db.createObjectStore(STORE_NAME, { keyPath: 'key' });
            store.createIndex('ts', 'ts'); // Timestamp index for LRU
          }
        };
      });
    };

    const getCachedAudio = async (key) => {
      try {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          // READONLY transaction â€” fast, non-blocking, no blob rewriting
          // LRU timestamp update removed: it was rewriting entire audio blobs on every read
          const tx = db.transaction(STORE_NAME, 'readonly');
          const store = tx.objectStore(STORE_NAME);
          const request = store.get(key);

          request.onsuccess = () => {
            const result = request.result;
            resolve(result ? result.blob : null);
          };
          request.onerror = () => resolve(null);

          tx.onerror = () => {
            console.warn('IndexedDB transaction error:', tx.error);
            resolve(null);
          };
          tx.onabort = () => {
            console.warn('IndexedDB transaction aborted');
            resolve(null);
          };
        });
      } catch (e) { return null; }
    };

    const setCachedAudio = async (key, blob) => {
      try {
        const db = await openDB();
        return new Promise((resolve) => {
          const tx = db.transaction(STORE_NAME, 'readwrite');
          const store = tx.objectStore(STORE_NAME);

          store.put({ key, blob, ts: Date.now() });

          // Periodic cleanup (simple check)
          const countReq = store.count();
          countReq.onsuccess = () => {
            if (countReq.result > MAX_ITEMS) {
              // Delete oldest
              const idx = store.index('ts');
              const cursorReq = idx.openCursor(); // Ascending = oldest first
              let deleted = 0;
              cursorReq.onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor && deleted < (countReq.result - MAX_ITEMS) + 5) {
                  cursor.delete();
                  deleted++;
                  cursor.continue();
                }
              };
            }
          };

          tx.oncomplete = () => resolve(true);
          tx.onerror = () => resolve(false);
        });
      } catch (e) { return false; }
    };

    // Create a hash key for caching (text + voice + speed + version)
    // Version 4: Use explicit string keys to prevent hash collisions (fixes segment mixing)
    const CACHE_VERSION = 4;
    const getCacheKey = (text, voice, speed) => {
      // Use full text as key to guarantee uniqueness for sentences
      return `v${CACHE_VERSION}|${text}|${voice}|${speed}`;
    };

    // Get cache statistics (item count + total blob size)
    const getCacheStats = async () => {
      try {
        const db = await openDB();
        return new Promise((resolve) => {
          const tx = db.transaction(STORE_NAME, 'readonly');
          const store = tx.objectStore(STORE_NAME);
          const countReq = store.count();
          let totalSize = 0;
          const cursorReq = store.openCursor();
          cursorReq.onsuccess = (e) => {
            const cursor = e.target.result;
            if (cursor) {
              if (cursor.value.blob) totalSize += cursor.value.blob.size || 0;
              cursor.continue();
            }
          };
          tx.oncomplete = () => resolve({ count: countReq.result, totalSize });
          tx.onerror = () => resolve({ count: 0, totalSize: 0 });
        });
      } catch (e) { return { count: 0, totalSize: 0 }; }
    };

    // Delete ALL cached audio data from IndexedDB (all sessions)
    const clearAllCachedAudio = async () => {
      try {
        _dbInstance = null; // Reset cached connection before deleting DB
        await new Promise((resolve, reject) => {
          const request = indexedDB.deleteDatabase(DB_NAME);
          request.onsuccess = () => resolve();
          request.onerror = () => reject(request.error);
        });
        // Also clear any Service Worker caches that may contain voice data
        if ('caches' in window) {
          const names = await caches.keys();
          await Promise.all(names.map(name => caches.delete(name)));
        }
        return true;
      } catch (e) { return false; }
    };

    // =============================================
    // TEXT OPTIMIZATION FOR FASTER TTS
    // =============================================
    // Clean text for TTS processing
    // Clean text for TTS processing - Added Flow & Cadence Enhancements
    // Clean text for TTS processing - MAXIMIZE PAUSES
    const cleanTextForTTS = (text) => {
      if (!text) return '';
      let t = text.trim();

      // 1. Collapse duplicate chars
      t = t.replace(/(.)\1{2,}/gi, '$1$1');

      // 2. Handle Independent Dashes (Space - Space) -> Period
      // Force full stop pause for dramatic dashes
      // Note: Hyphenated words (e.g. "semi-circle") are ignored because they lack spaces
      t = t.replace(/ - /g, '. ');
      t = t.replace(/â€”/g, '. ');
      t = t.replace(/â€“/g, '. ');
      t = t.replace(/--+/g, '. ');

      // 3. Handle Commas -> Period
      // Force full stop pause for commas (Prevents rushing)
      t = t.replace(/,/g, '. ');

      // 4. Handle Semi-colons -> Period
      t = t.replace(/;/g, '. ');

      // 5. Handle Ellipses -> Period
      // Convert "..." to "." to avoid stuttering/glitching
      t = t.replace(/\.\.\./g, '. ');

      // 6. Enhance Sentence Breaks
      // Ensure punctuation has space after it
      t = t.replace(/([.?!])(?=\S)/g, '$1 ');

      // 7. Text Cleanup
      t = t.replace(/[""â€œ]([^""â€]+)[""â€]/g, '$1'); // Strip quotes
      t = t.replace(/[""'''"']/g, '');             // Strip remaining quotes
      t = t.replace(/\.\.+/g, '.');                // Fix ".." -> "."
      t = t.replace(/\. \./g, '.');                // Fix ". ." -> "."
      t = t.replace(/\s+/g, ' ');                  // Normalize spaces

      return t;
    };

    // Split story text into LOGICAL PAGES (Sentences & Paragraphs)
    // - Respects paragraph breaks (newlines)
    // - Splits paragraphs by sentence boundaries for natural pacing
    // - Creates 1-2 sentences per page based on punctuation
    const splitIntoSentences = (text) => {
      if (!text) return [];

      // 1. Split by newlines to preserve paragraph structure
      const paragraphs = text.split(/\n+/).map(l => l.trim()).filter(l => l);
      const pages = [];

      for (const para of paragraphs) {
        // Remove numbered list prefixes (1., 2., etc.)
        const cleaned = para.replace(/^\d+[\.\)]\s*/, '');

        // 2. Split each paragraph by sentence delimiters (.!?)
        // This creates natural page breaks at sentence boundaries
        const sentences = cleaned
          .replace(/([.!?]+)(?=\s+|$)/g, '$1|') // Mark sentence boundaries
          .split('|')
          .map(s => s.trim())
          .filter(s => s);

        if (sentences.length > 0) {
          pages.push(...sentences);
        } else {
          // Fallback for text without punctuation
          pages.push(cleaned);
        }
      }

      return pages;
    };

    // =============================================
    // AUDIO CUE ENGINE
    // =============================================
    const useAudioCues = (enabled, vibrationEnabled) => {
      const ctxRef = useRef(null);

      const getCtx = useCallback(() => {
        if (!ctxRef.current) {
          ctxRef.current = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (ctxRef.current.state === 'suspended') {
          ctxRef.current.resume().catch(() => { });
        }
        return ctxRef.current;
      }, []);

      const vibrate = useCallback((pattern) => {
        if (vibrationEnabled && navigator.vibrate) {
          try { navigator.vibrate(pattern); } catch (e) { }
        }
      }, [vibrationEnabled]);

      const play = useCallback((type) => {
        // Haptic patterns tailored for each cue type
        const haptics = {
          tap: 25,
          story_start: [40, 40, 80],
          story_end: [80, 40, 80, 40, 150],
          ready: [60, 30, 60],        // Strong double-pulse: "your turn!"
          advance: 20,
          busy: [15, 15, 15],         // Quick triple-buzz: "wait"
          cover_tap: [30, 20, 30],    // Gentle nudge
          download_done: [50, 30, 80] // Celebration
        };
        vibrate(haptics[type] || 15);

        if (!enabled) return;

        try {
          const ctx = getCtx();
          const now = ctx.currentTime;

          if (type === 'tap') {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, now);
            osc.frequency.exponentialRampToValueAtTime(1320, now + 0.05);
            gain.gain.setValueAtTime(0.12, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.08);
            osc.connect(gain).connect(ctx.destination);
            osc.start(now); osc.stop(now + 0.1);
          } else if (type === 'story_start') {
            [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              osc.type = 'triangle';
              osc.frequency.value = freq;
              gain.gain.setValueAtTime(0, now + i * 0.1);
              gain.gain.linearRampToValueAtTime(0.1, now + i * 0.1 + 0.03);
              gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.1 + 0.35);
              osc.connect(gain).connect(ctx.destination);
              osc.start(now + i * 0.1); osc.stop(now + i * 0.1 + 0.4);
            });
          } else if (type === 'ready') {
            // Friendly two-tone "ding-ding" â€” clearly signals "your turn to tap!"
            [698.46, 880].forEach((freq, i) => {
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              osc.type = 'sine';
              osc.frequency.value = freq;
              gain.gain.setValueAtTime(0, now + i * 0.15);
              gain.gain.linearRampToValueAtTime(0.14, now + i * 0.15 + 0.02);
              gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.15 + 0.35);
              osc.connect(gain).connect(ctx.destination);
              osc.start(now + i * 0.15); osc.stop(now + i * 0.15 + 0.4);
            });
          } else if (type === 'cover_tap') {
            // Warm welcoming tone for the cover page
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(523.25, now);
            osc.frequency.exponentialRampToValueAtTime(659.25, now + 0.15);
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.1, now + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
            osc.connect(gain).connect(ctx.destination);
            osc.start(now); osc.stop(now + 0.35);
          } else if (type === 'download_done') {
            // Happy completion chime
            [523.25, 659.25, 783.99].forEach((freq, i) => {
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              osc.type = 'triangle';
              osc.frequency.value = freq;
              gain.gain.setValueAtTime(0, now + i * 0.08);
              gain.gain.linearRampToValueAtTime(0.1, now + i * 0.08 + 0.02);
              gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.08 + 0.3);
              osc.connect(gain).connect(ctx.destination);
              osc.start(now + i * 0.08); osc.stop(now + i * 0.08 + 0.35);
            });
          } else if (type === 'advance') {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(440, now);
            osc.frequency.exponentialRampToValueAtTime(660, now + 0.12);
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.05, now + 0.03);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
            osc.connect(gain).connect(ctx.destination);
            osc.start(now); osc.stop(now + 0.2);
          } else if (type === 'story_end') {
            [[523.25, 0], [659.25, 0.12], [783.99, 0.24], [1046.50, 0.36]].forEach(([freq, delay]) => {
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              osc.type = 'triangle';
              osc.frequency.value = freq;
              gain.gain.setValueAtTime(0, now + delay);
              gain.gain.linearRampToValueAtTime(0.12, now + delay + 0.02);
              gain.gain.exponentialRampToValueAtTime(0.001, now + delay + 0.5);
              osc.connect(gain).connect(ctx.destination);
              osc.start(now + delay); osc.stop(now + delay + 0.6);
            });
          } else if (type === 'busy') {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.value = 200;
            gain.gain.setValueAtTime(0.06, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
            osc.connect(gain).connect(ctx.destination);
            osc.start(now); osc.stop(now + 0.15);
          }
        } catch (e) {
          console.warn('Audio cue error:', e);
        }
      }, [enabled, getCtx, vibrate]);

      // Suspend AudioContext when not in use to save resources
      const suspend = useCallback(() => {
        if (ctxRef.current && ctxRef.current.state === 'running') {
          ctxRef.current.suspend().catch(() => { });
        }
      }, []);

      // Cleanup on unmount
      useEffect(() => {
        return () => {
          if (ctxRef.current) {
            ctxRef.current.close().catch(() => { });
          }
        };
      }, []);

      return { play, vibrate, suspend };
    };

    // =============================================
    // MAIN APPLICATION
    // =============================================
    const DEFAULT_STORY_TITLE = "The Brave Little Bear";
    const DEFAULT_STORY_TEXT = "Once upon a time, there was a little bear who lived in a cozy cave.\nThe bear loved honey more than anything in the world.\nOne sunny morning, the bear smelled something sweet.\nIt was coming from a tall, tall tree!\nThe bear looked up and saw a beehive.\nBuzz buzz buzz, sang the busy bees.\nThe little bear was scared, but also very hungry.\nSo the bear took a deep breath and started to climb.\nUp, up, up went the brave little bear!\nThe bees flew around, but the bear kept going.\nFinally, the bear reached the golden honey.\nYum yum yum! It was the sweetest honey ever.\nThe bear climbed down with a happy, sticky smile.\nAnd from that day on, everyone called the bear the bravest in the forest.\nThe end.";
    const STORAGE_KEY = 'storytap_prefs_v1';
    const App = () => {
      // Load preferences
      const prefs = useMemo(() => {
        try {
          return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
        } catch { return {}; }
      }, []);

      const [mode, setMode] = useState('library');
      const [storyTitle, setStoryTitle] = useState(prefs.storyTitle || DEFAULT_STORY_TITLE);
      const [rawText, setRawText] = useState(prefs.rawText || DEFAULT_STORY_TEXT);
      const [sentences, setSentences] = useState([]);
      const [currentIndex, setCurrentIndex] = useState(-1);
      const [voice, setVoice] = useState(prefs.voice || VOICES[0].name);
      const speed = NATURAL_SPEED; // Locked to 1.0 for proper pronunciation
      const [isTransitioning, setIsTransitioning] = useState(false);

      // New Accessibility & Option States
      const [showBoundary, setShowBoundary] = useState(prefs.showBoundary !== false); // Default true
      const [boundaryColor, setBoundaryColor] = useState(prefs.boundaryColor || 'red');
      const [showTitlePage, setShowTitlePage] = useState(prefs.showTitlePage !== false); // Default true
      const [endAction, setEndAction] = useState(prefs.endAction || 'stop'); // stop, library, loop, next

      // Lock Button Timer State
      const [isHoldingLock, setIsHoldingLock] = useState(false);
      const [lockHoldProgress, setLockHoldProgress] = useState(0);
      const [unlockAction, setUnlockAction] = useState(prefs.unlockAction || 'hold2'); // hold1, hold2, hold3, tripleTap
      const [lockFeedback, setLockFeedback] = useState('');
      const lockTapRef = useRef({ count: 0, lastTime: 0 });
      const lockStartRef = useRef(0);

      const [isHoldingFS, setIsHoldingFS] = useState(false);
      const [fsHoldProgress, setFsHoldProgress] = useState(0);
      const fsHoldTimerRef = useRef(null);
      const fsTapRef = useRef({ count: 0, lastTime: 0 });
      const [fsFeedback, setFsFeedback] = useState('');

      const [exitFeedback, setExitFeedback] = useState('');
      const exitTapRef = useRef({ count: 0, lastTime: 0 });

      const [settingsFeedback, setSettingsFeedback] = useState('');
      const settingsTapRef = useRef({ count: 0, lastTime: 0 });
      const fsStartRef = useRef(0);
      const ignoreClickRef = useRef(false);

      // Engine state
      const [modelProgress, setModelProgress] = useState(0);
      const [modelStatus, setModelStatus] = useState('');
      const [loadError, setLoadError] = useState(null);
      const [isGenerating, setIsGenerating] = useState(false);
      const [isPlaying, setIsPlaying] = useState(false);

      const [storyToPlay, setStoryToPlay] = useState(null);
      const currentStoryIdRef = useRef(null); // Tracks ID of currently playing story (survives storyToPlay null-out)
      const [editingId, setEditingId] = useState(null);
      const [viewFolder, setViewFolder] = useState(null); // 'Simple Stories' or null
      const [showSettings, setShowSettings] = useState(false);

      // Coverflow carousel state (child view)
      const [carouselIndex, setCarouselIndex] = useState(0);
      const carouselAudioRef = useRef(null);
      const carouselTouchRef = useRef({ startX: 0, startY: 0, startTime: 0, isSwiping: false });
      const carouselAnnouncingRef = useRef(false);
      const carouselBlobUrlRef = useRef(null);
      const childViewStoriesRef = useRef([]);
      const [isFullscreenMode, setIsFullscreenMode] = useState(isFullscreen());
      // Library & Processing Queue
      const [library, setLibrary] = useState(() => {
        try {
          const saved = JSON.parse(localStorage.getItem('storytap_library_v1')) || [];
          return saved.map(s => ({
            ...s,
            status: s.status || 'ready',
            progress: s.progress || 100,
            voice: s.voice || 'af_heart'
            // Speed no longer stored (always uses NATURAL_SPEED)
          }));
        }
        catch { return []; }
      });

      // Cache statistics (for storage indicator)
      const [cacheStats, setCacheStats] = useState({ count: 0, totalSize: 0 });
      const updateCacheStats = useCallback(async () => {
        const stats = await getCacheStats();
        setCacheStats(stats);
      }, []);
      // Debounce library persistence â€” avoids thrashing localStorage during download progress updates
      const librarySaveTimerRef = useRef(null);
      useEffect(() => {
        if (librarySaveTimerRef.current) clearTimeout(librarySaveTimerRef.current);
        librarySaveTimerRef.current = setTimeout(() => {
          localStorage.setItem('storytap_library_v1', JSON.stringify(library));
        }, 500);
        return () => { if (librarySaveTimerRef.current) clearTimeout(librarySaveTimerRef.current); };
      }, [library]);

      // LOAD SIMPLE STORIES (JS Variable)
      // This is robust for local file:// usage where fetch() is blocked by CORS
      useEffect(() => {
        const loadStories = () => {
          const data = window.QUICK_STORIES;
          if (data && Array.isArray(data)) {
            setLibrary(prev => {
              const newLib = [...prev];
              let changed = false;
              data.forEach(s => {
                const id = 'simple_' + s.title.toLowerCase().replace(/[^a-z0-9]/g, '');
                const existingIdx = newLib.findIndex(existing => existing.id === id);

                if (existingIdx === -1) {
                  // Add new
                  newLib.push({
                    id,
                    title: s.title,
                    text: s.text,
                    voice: 'af_heart',
                    // Speed no longer stored (always uses NATURAL_SPEED)
                    status: 'ready',
                    progress: 100,
                    folder: 'Simple Stories'
                  });
                  changed = true;
                } else {
                  // Update existing if changed (reflects file edits)
                  const ex = newLib[existingIdx];
                  if (ex.text !== s.text || ex.title !== s.title) {
                    newLib[existingIdx] = { ...ex, title: s.title, text: s.text };
                    changed = true;
                  }
                }
              });
              return changed ? newLib : prev;
            });
          }
        };

        // Try immediately
        loadStories();

        // And retry briefly in case of race condition
        setTimeout(loadStories, 100);
        setTimeout(loadStories, 500);
      }, []);

      // Processing Queue
      const processingRef = useRef(null);
      const lockHoldTimerRef = useRef(null);

      // Save Preferences (single consolidated save â€” see note below about removed duplicate)
      // Speed is no longer saved to preferences (locked to NATURAL_SPEED)
      useEffect(() => {
        const settings = {
          storyTitle, rawText, voice, textSize, theme,
          soundCuesEnabled, vibrationEnabled, allowSkip,
          showBoundary, boundaryColor, showTitlePage, endAction,
          unlockAction
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
      }, [storyTitle, rawText, voice, textSize, theme, soundCuesEnabled, vibrationEnabled, allowSkip, showBoundary, boundaryColor, showTitlePage, endAction, unlockAction]);

      // Send OS notification (PWA/Browser) â€” only sends if permission already granted
      const sendNotification = async (title, body) => {
        if (!('Notification' in window)) return;
        if (Notification.permission === 'granted') {
          try {
            new Notification(title, {
              body,
              icon: 'icon.svg',
              badge: 'icon.svg',
              tag: 'storytap-download',
              requireInteraction: false,
              silent: false
            });
          } catch (e) {
            console.log('Notification failed:', e);
          }
        }
      };

      // Cancel a download in progress
      const cancelDownload = (storyId, e) => {
        if (e) e.stopPropagation();
        if (processingRef.current === storyId) {
          processingRef.current = null;
        }
        setLibrary(prev => prev.map(s => s.id === storyId ? { ...s, status: 'ready', progress: 0 } : s));
      };

      const processStory = async (story) => {
        processingRef.current = story.id;

        // Request notification permission once at start of first download
        if ('Notification' in window && Notification.permission === 'default') {
          Notification.requestPermission().catch(() => { });
        }

        const sentences = splitIntoSentences(story.text);

        // Plain title in cache list (removed "Title:" prefix for cleaner speech)
        const titleText = story.title;
        // Also cache "The End." so it's ready instantly
        const allItemsToCache = [titleText, ...sentences, "The End."];
        const total = allItemsToCache.length;

        if (sentences.length === 0) {
          setLibrary(prev => prev.map(s => s.id === story.id ? { ...s, status: 'cached', progress: 100 } : s));
          processingRef.current = null;
          return;
        }

        // Ensure model is loaded before we start downloading
        if (!ttsRef.current) {
          setModelStatus('Loading voice engine for download...');
          const success = await loadKokoroModel();
          if (!success) {
            console.error('Failed to load model for download');
            setLibrary(prev => prev.map(s => s.id === story.id ? { ...s, status: 'ready', progress: 0 } : s));
            processingRef.current = null;
            return;
          }
        }

        // Mobile-aware batching: smaller batches + longer delays on mobile
        // CRITICAL: Aggressive delays prevent Android "App Not Responding" dialog
        const device = deviceInfoRef.current;
        const isMobile = device.isMobile;
        const BATCH_SIZE = isMobile ? 1 : 3; // Process 1 item at a time on mobile
        const BATCH_DELAY = isMobile ? 800 : 200; // Much longer pause on mobile (800ms)
        const ITEM_DELAY = isMobile ? 300 : 50; // Longer between items on mobile

        let completed = 0;
        let consecutiveErrors = 0;
        const MAX_CONSECUTIVE_ERRORS = 5; // Bail out if too many failures in a row

        // Set initial progress to show download has started
        setLibrary(prev => prev.map(s => s.id === story.id ? {
          ...s,
          progress: 0,
          progressText: `0 of ${total}`
        } : s));

        for (let i = 0; i < allItemsToCache.length; i++) {
          // Check for cancellation before each item
          if (processingRef.current !== story.id) {
            console.log('Download cancelled for story:', story.id);
            return;
          }

          try {
            // Generate and cache audio (uses story's voice, speed locked to NATURAL_SPEED)
            await generateKokoroAudio(allItemsToCache[i], story.voice, NATURAL_SPEED, true);
            consecutiveErrors = 0; // Reset on success
          } catch (e) {
            console.warn('Error caching item:', e);
            consecutiveErrors++;

            // Bail out if device is struggling (too many failures in a row)
            if (consecutiveErrors >= MAX_CONSECUTIVE_ERRORS) {
              console.error('Too many consecutive errors, aborting download');
              setLibrary(prev => prev.map(s => s.id === story.id ? { ...s, status: 'ready', progress: 0 } : s));
              processingRef.current = null;
              return;
            }
          }

          completed++;
          const progressPercent = Math.round((completed / total) * 100);

          // OPTIMIZATION: Only update UI every 5 items to reduce re-renders
          // This dramatically improves performance on older devices
          const shouldUpdateUI = (i % 5 === 4) || (i === allItemsToCache.length - 1);

          if (shouldUpdateUI) {
            setLibrary(prev => prev.map(s => s.id === story.id ? {
              ...s,
              progress: progressPercent,
              progressText: `${completed} of ${total}`
            } : s));
          }

          // Always yield to browser between items to keep UI responsive
          await yieldToBrowser();

          // Longer pause every BATCH_SIZE items for UI responsiveness
          // On mobile, aggressive yielding prevents ANR dialog
          if (i % BATCH_SIZE === BATCH_SIZE - 1) {
            await new Promise(r => setTimeout(r, BATCH_DELAY));
            await yieldIdle(isMobile ? 500 : 100); // Much longer idle on mobile
          } else {
            await new Promise(r => setTimeout(r, ITEM_DELAY));
            await yieldIdle(isMobile ? 200 : 50); // Add idle in else branch too
          }
        }

        if (processingRef.current === story.id) {
          setLibrary(prev => prev.map(s => s.id === story.id ? {
            ...s,
            status: 'cached',
            progress: 100,
            progressText: null
          } : s));
          processingRef.current = null;
          playCue('download_done');

          // Send OS notification
          sendNotification(
            'âœ… Story Ready!',
            `"${story.title}" is ready to read.`
          );

          // Update cache stats display
          updateCacheStats();
        }
      };

      // Watch for stories that need processing (Download button was pressed)
      // ONLY ONE story can process at a time
      useEffect(() => {
        if (mode !== 'library') return; // Never cache while editing â€” too disruptive
        const task = library.find(s => s.status === 'processing');
        // Process ONLY if there's a task and nothing else is currently processing
        if (task && !processingRef.current) {
          processStory(task);
        }
      }, [library, mode]);

      // Track fullscreen state changes
      useEffect(() => {
        const handleFullscreenChange = () => {
          setIsFullscreenMode(isFullscreen());
        };
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('MSFullscreenChange', handleFullscreenChange);
        return () => {
          document.removeEventListener('fullscreenchange', handleFullscreenChange);
          document.removeEventListener('webkitfullscreenchange', handleFullscreenChange);
          document.removeEventListener('mozfullscreenchange', handleFullscreenChange);
          document.removeEventListener('MSFullscreenChange', handleFullscreenChange);
        };
      }, []);

      // Handle fullscreen toggle (stops event propagation)
      const handleFullscreenToggle = useCallback(() => {
        const elem = document.documentElement;
        if (!document.fullscreenElement && !document.webkitFullscreenElement) {
          if (elem.requestFullscreen) elem.requestFullscreen().catch(err => console.warn("Fullscreen error:", err));
          else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
          setIsFullscreenMode(true);
        } else {
          if (document.exitFullscreen) document.exitFullscreen();
          else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
          setIsFullscreenMode(false);
        }
      }, []);

      // Auto-split text into pages/sentences for preview ONLY in Create Mode
      // This prevents stale rawText from overwriting the story when loading a book
      useEffect(() => {
        if (mode === 'create') {
          setSentences(splitIntoSentences(rawText));
        }
      }, [rawText, mode]);

      // Update cache stats when on library page
      useEffect(() => {
        if (mode === 'library') {
          updateCacheStats();
        }
      }, [mode, library, updateCacheStats]);

      const createNewBook = () => {
        setStoryTitle('');
        setRawText('');
        setStoryColor('indigo');
        setEditingId(null);
        setMode('create');
      };

      const editBook = (story, e) => {
        e.stopPropagation();
        setStoryTitle(story.title);
        setRawText(story.text);
        setVoice(story.voice || VOICES[0].name);
        // Speed is now locked to NATURAL_SPEED (1.0)
        setStoryColor(story.color || 'indigo');
        setEditingId(story.id);
        setMode('create');
      };

      const saveCreatedBook = () => {
        if (!storyTitle.trim()) return;

        const storyData = {
          title: storyTitle,
          text: rawText,
          voice,
          // Speed no longer saved (always uses NATURAL_SPEED)
          color: storyColor,
          status: 'ready',  // Save without auto-caching â€” user can Download to pre-cache
          progress: 100
        };

        if (editingId) {
          setLibrary(prev => prev.map(s => s.id === editingId ? { ...storyData, id: editingId } : s));
          setEditingId(null);
        } else {
          setLibrary(prev => [{ ...storyData, id: Date.now() }, ...prev]);
        }
        setMode('library');
      };

      // Only allow playing stories that are fully cached (downloaded)
      const loadBookForPlay = (story) => {
        if (story.status !== 'cached') return; // Must download first!
        // Stop carousel title announcement before entering reading mode
        if (carouselAudioRef.current) {
          try { carouselAudioRef.current.pause(); carouselAudioRef.current.currentTime = 0; } catch (e) { }
        }
        if (carouselBlobUrlRef.current) {
          URL.revokeObjectURL(carouselBlobUrlRef.current);
          carouselBlobUrlRef.current = null;
        }
        setStoryTitle(story.title);
        setRawText(story.text);
        setVoice(story.voice || VOICES[0].name);
        // Speed is now locked to NATURAL_SPEED (1.0)
        setStoryToPlay(story);
      };
      const preloadBook = (story, e) => {
        e.stopPropagation();
        // Prevent starting a new download if one is already in progress
        if (processingRef.current) {
          playCue('busy');
          return;
        }
        setLibrary(prev => prev.map(s => s.id === story.id ? { ...s, status: 'processing', progress: 0 } : s));
      };

      const deleteBook = async (story, e) => {
        e.stopPropagation();

        const isCached = story.status === 'cached';

        if (isCached) {
          // First press: Delete cached audio, keep the story
          if (confirm(`Delete cached audio for "${story.title}"?\n\nThe story will remain in your library but you'll need to re-download it to play.`)) {
            // Delete all cached audio entries for this story's sentences
            const sentences = story.text.split(/(?<=[.!?])\s+/).filter(s => s.trim());

            try {
              const db = await openDB();
              const tx = db.transaction(STORE_NAME, 'readwrite');
              const store = tx.objectStore(STORE_NAME);

              // Delete each sentence's cached audio
              for (const sentence of sentences) {
                const key = getCacheKey(sentence.trim(), story.voice, NATURAL_SPEED);
                store.delete(key);
              }

              // Also delete "The End." audio if it exists
              store.delete(getCacheKey("The End.", story.voice, NATURAL_SPEED));

              await new Promise((resolve) => {
                tx.oncomplete = () => resolve();
                tx.onerror = () => resolve(); // Still resolve on error
              });
            } catch (e) {
              console.warn('Error deleting cached audio:', e);
            }

            // Update story status to 'ready' (no longer cached)
            setLibrary(prev => prev.map(s => s.id === story.id ? { ...s, status: 'ready', progress: 0 } : s));
            playCue('tap');

            // Update cache stats display
            updateCacheStats();
          }
        } else {
          // Second press (or first press if not cached): Delete the story entirely
          if (confirm(`Permanently delete "${story.title}"?\n\nThis cannot be undone.`)) {
            setLibrary(prev => prev.filter(s => s.id !== story.id));
            playCue('tap');
          }
        }
      };
      const [soundCuesEnabled, setSoundCuesEnabled] = useState(prefs.soundCuesEnabled ?? true);
      const [vibrationEnabled, setVibrationEnabled] = useState(prefs.vibrationEnabled ?? true);
      const [theme, setTheme] = useState(prefs.theme || 'buff');
      const [textSize, setTextSize] = useState(prefs.textSize || 'huge');
      const [allowSkip, setAllowSkip] = useState(prefs.allowSkip ?? false);
      const [showEditControls, setShowEditControls] = useState(false);
      const [storyColor, setStoryColor] = useState('indigo');

      // Exit button hold state
      const [isHoldingExit, setIsHoldingExit] = useState(false);
      const [holdProgress, setHoldProgress] = useState(0);
      const holdTimerRef = useRef(null);
      const holdStartRef = useRef(null);
      const lastInteractionRef = useRef(0);

      // Settings hold state (child-safe â€” requires 2s hold to open on library page)
      const [isHoldingSettings, setIsHoldingSettings] = useState(false);
      const [settingsHoldProgress, setSettingsHoldProgress] = useState(0);
      const settingsHoldTimerRef = useRef(null);
      const settingsHoldStartRef = useRef(null);

      // Refs
      const ttsRef = useRef(null);
      const audioRef = useRef(null);
      const cacheRef = useRef({});
      const deviceInfoRef = useRef(getDeviceInfo());
      const initPromiseRef = useRef(null);

      const { play: playCue } = useAudioCues(soundCuesEnabled, vibrationEnabled);
      const currentTheme = THEMES.find(t => t.id === theme) || THEMES[0];

      const getTextSizeClass = () => {
        if (textSize === 'huge') return 'text-4xl md:text-6xl lg:text-7xl';
        if (textSize === 'large') return 'text-3xl md:text-5xl lg:text-6xl';
        return 'text-2xl md:text-4xl lg:text-5xl';
      };

      // =============================================
      // KOKORO TTS ENGINE (Primary)
      // =============================================
      const loadKokoroModel = useCallback(async () => {
        if (ttsRef.current) return true;

        if (initPromiseRef.current) return initPromiseRef.current;

        initPromiseRef.current = (async () => {
          const device = deviceInfoRef.current;
          setLoadError(null);
          setModelProgress(0);
          setModelStatus('Initializing...');

          try {
            await yieldToBrowser();

            // Determine optimal settings based on device
            let useWebGPU = false;
            let dtype = 'q8'; // Default to q8 for stability

            // Only try WebGPU on desktop Chrome/Edge with good specs
            if (!device.isMobile && !device.isSafari && device.hasWebGPU && device.memory >= 8) {
              try {
                const adapter = await navigator.gpu.requestAdapter();
                if (adapter) {
                  const gpuDevice = await adapter.requestDevice();
                  gpuDevice.destroy();
                  useWebGPU = true;
                  dtype = 'fp32';
                  setModelStatus('Using GPU acceleration...');
                }
              } catch (e) {
                console.warn('WebGPU not available:', e);
              }
            }

            // Tiered model quality based on device capabilities
            if (device.isMobile || device.memory < 4 || device.cores < 4) {
              dtype = 'q4';
              setModelStatus('Loading compact model...');
            } else if (device.memory < 6 && !useWebGPU) {
              dtype = 'q4';
              setModelStatus('Loading optimized model...');
            } else if (!useWebGPU) {
              dtype = 'q8';
              setModelStatus('Loading high-quality model...');
            } else {
              setModelStatus('Loading premium model...');
            }

            console.log(`Loading Kokoro TTS: device=${useWebGPU ? 'webgpu' : 'wasm'}, dtype=${dtype}`);

            const tts = await KokoroTTS.from_pretrained(MODEL_ID, {
              dtype,
              device: useWebGPU ? 'webgpu' : 'wasm',
              progress_callback: (p) => {
                if (p.status === 'progress' && p.total) {
                  const pct = Math.round((p.loaded / p.total) * 100);
                  setModelProgress(pct);
                  if (pct < 30) setModelStatus('Downloading voice model...');
                  else if (pct < 70) setModelStatus('Preparing voice engine...');
                  else if (pct < 95) setModelStatus('Almost ready...');
                  else setModelStatus('Finalizing...');
                }
              }
            });

            ttsRef.current = tts;
            console.log('Kokoro TTS loaded successfully');
            return true;

          } catch (error) {
            console.error('Kokoro TTS failed to load:', error);
            setLoadError(`Voice engine error: ${error.message || 'Unknown error'}`);
            initPromiseRef.current = null; // Reset promise on error so we can retry
            return false;
          }
        })();

        return initPromiseRef.current;
      }, []);

      // NOTE: Model is NOT auto-loaded on mount anymore
      // It only loads when actually needed (first uncached sentence playback)
      // This prevents lag in the menu on slower devices

      // Load audio from IndexedDB cache ONLY (no generation)
      // This can run without the TTS model being loaded
      const loadFromCache = useCallback(async (text, voiceOpt, speedOpt) => {
        const useVoice = voiceOpt || voice;
        const useSpeed = speedOpt || speed;
        const cleanText = cleanTextForTTS(text);
        const cacheKey = getCacheKey(cleanText, useVoice, useSpeed);

        try {
          const cachedBlob = await getCachedAudio(cacheKey);
          if (cachedBlob) {
            return URL.createObjectURL(cachedBlob);
          }
        } catch (e) { /* Cache miss */ }
        return null;
      }, [voice]); // speed is now constant (NATURAL_SPEED)

      // Announce a book title aloud using cached TTS audio (for coverflow carousel)
      const announceTitle = useCallback(async (title, storyVoice) => {
        if (carouselAnnouncingRef.current) {
          if (carouselAudioRef.current) {
            try { carouselAudioRef.current.pause(); carouselAudioRef.current.currentTime = 0; } catch (e) { }
          }
        }
        carouselAnnouncingRef.current = true;

        if (carouselBlobUrlRef.current) {
          URL.revokeObjectURL(carouselBlobUrlRef.current);
          carouselBlobUrlRef.current = null;
        }

        try {
          const url = await loadFromCache(title, storyVoice, NATURAL_SPEED);
          if (url && carouselAudioRef.current) {
            carouselBlobUrlRef.current = url;
            carouselAudioRef.current.src = url;
            await carouselAudioRef.current.play();
          }
        } catch (e) {
          console.warn('Title announcement failed:', e);
        } finally {
          carouselAnnouncingRef.current = false;
        }
      }, [loadFromCache]);

      // Generate audio with Kokoro + persistent cache
      // skipCacheCheck: true when called from processStory (we know it's not cached)
      const generateKokoroAudio = useCallback(async (text, voiceOpt, speedOpt, skipCacheCheck = false) => {
        const useVoice = voiceOpt || voice;
        const useSpeed = speedOpt || speed;

        // Clean text FIRST â€” normalize elongated letters, whitespace, etc.
        const cleanText = cleanTextForTTS(text);
        const cacheKey = getCacheKey(cleanText, useVoice, useSpeed);

        // Check persistent cache first (skip if called from download process)
        if (!skipCacheCheck) {
          try {
            const cachedBlob = await getCachedAudio(cacheKey);
            if (cachedBlob) {
              return URL.createObjectURL(cachedBlob);
            }
          } catch (e) { /* Cache miss, generate fresh */ }
        }

        // Need model to generate - ensure it's loaded
        if (!ttsRef.current) {
          const success = await loadKokoroModel();
          if (!success) return null;
        }

        try {
          // Longer yield before generation to prevent ANR on mobile
          const device = deviceInfoRef.current;
          await yieldIdle(device?.isMobile ? 100 : 10);

          const audio = await ttsRef.current.generate(cleanText, { voice: useVoice, speed: useSpeed });
          const resultBlob = audio.toBlob();

          // Save to persistent cache (don't await, do in background)
          setCachedAudio(cacheKey, resultBlob).catch(() => { });

          return URL.createObjectURL(resultBlob);

        } catch (error) {
          console.error('Kokoro generation error:', error);
          return null;
        }
      }, [voice, loadKokoroModel]); // speed is now constant (NATURAL_SPEED)

      // =============================================
      // UNIFIED SPEECH SYSTEM
      // =============================================
      // NOTE: Audio is ONLY cached via the Download button (processStory function)
      // No background prefetching or on-demand generation during playback
      // This ensures the app never stalls on low-power devices

      // Play a sentence from cache ONLY (stories must be downloaded first)
      const playSentence = useCallback(async (idx, list) => {
        if (idx < -1 || idx >= list.length) return; // Allow -1 for Title

        // Stop current audio
        setIsPlaying(false);
        if (audioRef.current) {
          try { audioRef.current.pause(); audioRef.current.currentTime = 0; } catch (e) { }
        }
        window.speechSynthesis?.cancel();

        const text = idx === -1 ? storyTitle : list[idx];

        // First check in-memory cache (fastest)
        let url = cacheRef.current[idx];

        // If not in memory, try IndexedDB cache
        if (!url) {
          url = await loadFromCache(text);
          if (url) cacheRef.current[idx] = url; // Store in memory for next time
        }

        // Play the cached audio (stories MUST be downloaded before playing)
        if (url && audioRef.current) {
          try {
            audioRef.current.src = url;
            await audioRef.current.play();
            setIsPlaying(true);
            return;
          } catch (e) {
            console.warn('Audio playback failed:', e);
          }
        }

        // No cached audio found - this shouldn't happen for downloaded stories
        // But just in case, play a ready cue and move on
        console.warn('No cached audio found for:', text.substring(0, 30));
        playCue('ready');
      }, [loadFromCache, playCue, storyTitle]);

      // Audio ended handler
      // NOTE: Do NOT revoke blob URLs here â€” they are kept in cacheRef for instant replay
      // All blob URLs are cleaned up when exiting the story (exitStory)
      const handleAudioEnded = useCallback(() => {
        setIsPlaying(false);

        if (currentIndex >= 0 && currentIndex < sentences.length) {
          playCue('ready');
        }
      }, [currentIndex, sentences, playCue]);

      // Generic Helpers for Protected Actions
      const getUnlockDuration = () => ({ hold1: 1000, hold2: 2000, hold3: 3000 }[unlockAction] || 2000);

      const startProtectedAction = (e, setIsHolding, setProgress, setFeedback, timerRef, startTimeRef, onComplete, deferAction = false) => {
        setIsHolding(true);
        setFeedback('');
        if (unlockAction === 'tripleTap') return;

        const duration = getUnlockDuration();
        e.stopPropagation();

        startTimeRef.current = Date.now();
        const start = startTimeRef.current;
        const update = () => {
          const elapsed = Date.now() - start;
          const p = Math.min((elapsed / duration) * 100, 100);
          setProgress(p);

          if (p >= 100) {
            if (!deferAction) {
              onComplete();
            } else {
              // Deferred: Play cue, stop timer, wait for release
              if (timerRef.current) {
                playCue('story_start');
                cancelAnimationFrame(timerRef.current);
                timerRef.current = null;
              }
            }
          } else {
            timerRef.current = requestAnimationFrame(update);
          }
        };
        timerRef.current = requestAnimationFrame(update);
      };

      const endProtectedAction = (setIsHolding, setProgress, timerRef, startTimeRef, onDeferredComplete) => {
        if (onDeferredComplete) {
          const duration = getUnlockDuration();
          const elapsed = Date.now() - startTimeRef.current;
          // Check for valid time and prevent double-fire
          if (startTimeRef.current > 0 && elapsed >= duration) {
            // Reset start time immediately to prevent second event (mouse/touch overlap)
            startTimeRef.current = 0;
            onDeferredComplete();
            ignoreClickRef.current = true;
            setTimeout(() => ignoreClickRef.current = false, 50);
          }
        }
        setIsHolding(false);
        setProgress(0);
        if (timerRef.current) {
          cancelAnimationFrame(timerRef.current);
          timerRef.current = null;
        }
      };

      const handleProtectedClick = (setIsHolding, setFeedback, tapRef, onComplete) => {
        if (ignoreClickRef.current) return;

        setIsHolding(false);
        if (unlockAction === 'tripleTap') {
          const now = Date.now();
          if (now - tapRef.current.lastTime < 600) {
            tapRef.current.count++;
          } else {
            tapRef.current.count = 1;
          }
          tapRef.current.lastTime = now;

          if (tapRef.current.count >= 3) {
            tapRef.current.count = 0;
            setFeedback('Unlocked!');
            playCue('story_start');
            onComplete();
          } else {
            setFeedback(`Tap ${3 - tapRef.current.count} more times`);
            setTimeout(() => setFeedback(''), 1500);
          }
        } else {
          const sec = { hold1: '1', hold2: '2', hold3: '3' }[unlockAction] || '2';
          setFeedback(`Hold for ${sec}s`);
          setTimeout(() => setFeedback(''), 2000);
        }
      };

      // Exit Button Logic
      const startHoldExit = (e) => startProtectedAction(e, setIsHoldingExit, setHoldProgress, setExitFeedback, holdTimerRef, holdStartRef, exitStory);
      const endHoldExit = () => endProtectedAction(setIsHoldingExit, setHoldProgress, holdTimerRef, holdStartRef);
      const handleExitClick = () => handleProtectedClick(setIsHoldingExit, setExitFeedback, exitTapRef, exitStory);

      // Settings Button Logic
      const startHoldSettings = (e) => startProtectedAction(e, setIsHoldingSettings, setSettingsHoldProgress, setSettingsFeedback, settingsHoldTimerRef, settingsHoldStartRef, () => setShowSettings(true));
      const endHoldSettings = () => endProtectedAction(setIsHoldingSettings, setSettingsHoldProgress, settingsHoldTimerRef, settingsHoldStartRef);
      const handleSettingsClick = () => handleProtectedClick(setIsHoldingSettings, setSettingsFeedback, settingsTapRef, () => setShowSettings(true));

      // Fullscreen Button Logic - Protect ONLY Exit
      const startHoldFS = (e) => {
        if (isFullscreenMode) {
          startProtectedAction(e, setIsHoldingFS, setFsHoldProgress, setFsFeedback, fsHoldTimerRef, fsStartRef, handleFullscreenToggle, true);
        }
      };

      const endHoldFS = () => {
        if (isFullscreenMode) {
          endProtectedAction(setIsHoldingFS, setFsHoldProgress, fsHoldTimerRef, fsStartRef, handleFullscreenToggle);
        }
      };

      const handleFSClick = () => {
        if (isFullscreenMode) {
          handleProtectedClick(setIsHoldingFS, setFsFeedback, fsTapRef, handleFullscreenToggle);
        } else {
          handleFullscreenToggle();
        }
      };

      // Lock button hold timer
      const startHoldLock = (e) => {
        if (showEditControls) return;
        startProtectedAction(e, setIsHoldingLock, setLockHoldProgress, setLockFeedback, lockHoldTimerRef, lockStartRef, () => {
          setShowEditControls(true);
          setIsHoldingLock(false);
          setLockFeedback('');
          setLockHoldProgress(0);
        });
      };

      const endHoldLock = () => {
        if (showEditControls) return;
        endProtectedAction(setIsHoldingLock, setLockHoldProgress, lockHoldTimerRef, lockStartRef);
      };

      const handleLockClick = () => {
        if (showEditControls) {
          setShowEditControls(false);
          setViewFolder(null); // Reset folder view when locking
          setCarouselIndex(0); // Reset carousel to first book
        } else {
          handleProtectedClick(setIsHoldingLock, setLockFeedback, lockTapRef, () => {
            setShowEditControls(true);
            setIsHoldingLock(false);
            setLockFeedback('');
            setLockHoldProgress(0);
          });
        }
      };

      // Main tap handler
      const handleTap = useCallback(() => {
        if (isTransitioning) { playCue('busy'); return; }

        if (isPlaying) {
          if (!allowSkip) { playCue('busy'); return; }
          // Skip mode: stop current audio and continue to advance
          if (audioRef.current) {
            try { audioRef.current.pause(); audioRef.current.currentTime = 0; } catch (e) { }
          }
          window.speechSynthesis?.cancel();
          setIsPlaying(false);
        }

        // Context-aware tap cue
        // Cover Page behavior: Tap advances to story (Title reads auto on load)
        if (currentIndex === -1) {
          // Auto-fullscreen on start
          if (!isFullscreenMode) handleFullscreenToggle();
          playCue('story_start');

          setIsTransitioning(true);
          setTimeout(() => {
            setCurrentIndex(0);
            playSentence(0, sentences);
            setIsTransitioning(false);
          }, 300);
          return;
        }

        const nextIndex = currentIndex + 1;

        if (currentIndex >= sentences.length) {
          executeEndAction();
          return;
        }

        if (nextIndex >= sentences.length) {
          playCue('story_end');
          setTimeout(() => {
            setCurrentIndex(sentences.length);
            setIsTransitioning(false);
            // "The End." audio is pre-loaded in memory cache (idx = sentences.length)
            const url = cacheRef.current[sentences.length];
            if (url && audioRef.current) {
              try {
                audioRef.current.src = url;
                audioRef.current.play();
              } catch (e) { /* Audio play failed */ }
            }
          }, 30);
          return;
        }

        playCue('advance');
        setTimeout(() => {
          setCurrentIndex(nextIndex);
          playSentence(nextIndex, sentences);
          setIsTransitioning(false);
        }, 80);
      }, [currentIndex, sentences, isPlaying, isTransitioning, allowSkip, playCue, playSentence, showTitlePage, isFullscreenMode, handleFullscreenToggle, endAction, executeEndAction]);

      // Ultra-responsive touch handler for accessibility
      // Fires on the SLIGHTEST contact â€” any finger count, any pressure
      // Uses touchstart (not click) for zero-delay response
      const handleInteraction = useCallback((e) => {
        // Prevent all default browser behaviors (scrolling, zooming, pull-to-refresh, text selection)
        e.preventDefault();

        // Debounce: touchstart + click + pointerdown can multi-fire
        const now = Date.now();
        if (now - lastInteractionRef.current < 300) return;
        lastInteractionRef.current = now;

        handleTap();
      }, [handleTap]);

      // Dedicated touch handler â€” fires on ANY contact, any finger count, any pressure
      // touchstart fires instantly with zero delay (unlike click which has ~300ms delay on mobile)
      const handleTouchInteraction = useCallback((e) => {
        e.preventDefault();
        e.stopPropagation();
        const now = Date.now();
        if (now - lastInteractionRef.current < 300) return;
        lastInteractionRef.current = now;
        handleTap();
      }, [handleTap]);

      // Clear in-memory cache when voice settings change
      // No automatic pre-generation - audio is ONLY cached via Download button or on-demand playback
      // Speed is locked to NATURAL_SPEED, so no need to clear cache when it changes
      useEffect(() => {
        Object.values(cacheRef.current).forEach(url => URL.revokeObjectURL(url));
        cacheRef.current = {};
      }, [voice]);

      // Coverflow: auto-announce title when carousel selection changes
      useEffect(() => {
        if (showEditControls) return;
        if (mode !== 'library') return;
        if (!childViewStoriesRef.current || childViewStoriesRef.current.length === 0) return;

        const story = childViewStoriesRef.current[carouselIndex];
        if (!story) return;

        const timer = setTimeout(() => {
          announceTitle(story.title, story.voice);
        }, 150);

        return () => clearTimeout(timer);
      }, [carouselIndex, showEditControls, mode, announceTitle]);

      // Start story (stories MUST be downloaded/cached before playing)
      // PRE-LOADS all audio into memory so ZERO IndexedDB access during reading
      const startStory = useCallback(async (textToRead) => {
        // Clear in-memory cache from previous story
        Object.values(cacheRef.current).forEach(url => {
          if (url && url.startsWith('blob:')) URL.revokeObjectURL(url);
        });
        cacheRef.current = {};

        const text = textToRead || rawText;
        const allSentences = splitIntoSentences(text);

        setSentences(allSentences);
        const startIndex = showTitlePage ? -1 : 0;
        setCurrentIndex(startIndex);

        // Go directly to reading mode â€” stories are pre-cached via Download
        setMode('reading');

        // PRE-LOAD ALL audio into memory from IndexedDB
        // This eliminates ALL IndexedDB access during reading for instant playback
        const preloadItems = [
          { idx: -1, text: storyTitle },             // Title page
          ...allSentences.map((s, i) => ({ idx: i, text: s })), // Story pages
          { idx: allSentences.length, text: "The End." }        // End page
        ];

        for (const item of preloadItems) {
          try {
            const url = await loadFromCache(item.text);
            if (url) cacheRef.current[item.idx] = url;
          } catch (e) { /* Skip failed items */ }
        }

        // Start playback after preload
        setTimeout(() => playSentence(startIndex, allSentences), 100);
      }, [rawText, showTitlePage, playSentence, loadFromCache, storyTitle]);

      useEffect(() => {
        if (storyToPlay) {
          currentStoryIdRef.current = storyToPlay.id; // Remember which story is playing
          // Ensure we play the text of the SELECTED story, regardless of race conditions with rawText state
          startStory(storyToPlay.text);
          setStoryToPlay(null);
        }
      }, [storyToPlay]);

      // Exit story
      const exitStory = useCallback(() => {
        if (audioRef.current) {
          try {
            // Revoke blob URL before clearing
            if (audioRef.current.src && audioRef.current.src.startsWith('blob:')) {
              URL.revokeObjectURL(audioRef.current.src);
            }
            audioRef.current.pause();
            audioRef.current.src = '';
            audioRef.current.load(); // Force unload audio data from memory
          } catch (e) { }
        }

        // Clean up all in-memory blob URLs for this story
        Object.values(cacheRef.current).forEach(url => {
          if (url && url.startsWith('blob:')) {
            URL.revokeObjectURL(url);
          }
        });
        cacheRef.current = {};

        window.speechSynthesis?.cancel();
        setStoryToPlay(null);
        setMode('library');
        setCurrentIndex(-1);
        setIsPlaying(false);
        setIsGenerating(false);
      }, []);

      // Consolidated end-of-story logic
      const executeEndAction = useCallback(() => {
        if (endAction === 'stop') {
          playCue('busy');
          setIsTransitioning(false);
          return;
        }

        playCue('tap');

        if (endAction === 'library') {
          exitStory();
        } else if (endAction === 'loop') {
          const startIdx = showTitlePage ? -1 : 0;
          setCurrentIndex(startIdx);
          playCue('story_start');
          setTimeout(() => playSentence(startIdx, sentences), 200);
          setIsTransitioning(false);
        } else if (endAction === 'random') {
          const available = library.filter(s => s.status === 'cached');
          if (available.length > 0) {
            const others = available.filter(s => s.id !== currentStoryIdRef.current);
            const candidates = others.length > 0 ? others : available;
            const randomStory = candidates[Math.floor(Math.random() * candidates.length)];
            playCue('story_start');
            loadBookForPlay(randomStory); // This will transition mode/index via useEffect
            setIsTransitioning(false);
          } else {
            exitStory();
          }
        }
      }, [endAction, library, showTitlePage, sentences, exitStory, playCue, playSentence, loadBookForPlay]);

      // Clear all cached audio from all storage
      const handleClearCache = async () => {
        const stats = await getCacheStats();
        const sizeMB = (stats.totalSize / (1024 * 1024)).toFixed(1);

        if (stats.count === 0) {
          alert('No cached audio data found.');
          return;
        }

        if (!confirm(`This will delete ${stats.count} cached audio files (${sizeMB} MB).\n\nAll stories will need to re-download their audio.\n\nContinue?`)) return;

        await clearAllCachedAudio();

        // Reset all library items to 'ready'
        setLibrary(prev => prev.map(s => ({ ...s, status: 'ready', progress: 100 })));

        // Clear in-memory cache
        Object.values(cacheRef.current).forEach(url => URL.revokeObjectURL(url));
        cacheRef.current = {};
        processingRef.current = null;

        // Update cache stats display
        updateCacheStats();
      };

      // =============================================
      // SETTINGS MODAL
      // =============================================
      const SettingsModal = () => (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/60 backdrop-blur-sm" onClick={() => setShowSettings(false)}>
          <div className={`${currentTheme.cardBg} rounded-3xl shadow-2xl max-w-lg w-full max-h-[85vh] flex flex-col ${currentTheme.border} border ${theme.includes('high-contrast') ? 'high-contrast' : ''}`} onClick={e => e.stopPropagation()}>
            <div className={`p-6 border-b ${currentTheme.border} flex items-center justify-between`}>
              <h2 className={`text-xl font-bold ${currentTheme.textMain}`}>Accessibility Settings</h2>
              <button onClick={() => setShowSettings(false)} className={`p-2 rounded-full transition-colors ${theme.includes('high-contrast') ? `hover:bg-white/10 ${currentTheme.textMain}` : `hover:bg-slate-100 ${currentTheme.textSub}`}`}>
                <X size={20} />
              </button>
            </div>

            <div className="p-6 space-y-6 overflow-y-auto settings-scroll">
              {/* Sound Cues */}
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${theme.includes('high-contrast') ? `border ${currentTheme.border}` : 'bg-indigo-100'}`}>
                    {soundCuesEnabled ? <Volume2 size={20} className={theme.includes('high-contrast') ? currentTheme.textMain : 'text-indigo-600'} /> : <VolumeX size={20} className={currentTheme.textSub} />}
                  </div>
                  <div>
                    <div className={`font-bold ${currentTheme.textMain}`}>Sound Cues</div>
                    <div className={`text-sm ${currentTheme.textSub}`}>Audio feedback on taps</div>
                  </div>
                </div>
                <button onClick={() => setSoundCuesEnabled(!soundCuesEnabled)} className={`w-14 h-8 rounded-full transition-colors relative border-2 ${soundCuesEnabled ? `bg-${currentTheme.highlight}-500 border-${currentTheme.highlight}-500 ${theme === 'high-contrast-wb' ? 'bg-white border-white' : ''}` : `${theme.includes('high-contrast') ? 'bg-zinc-700 border-zinc-500' : 'bg-slate-600 border-slate-700'}`}`}>
                  <div className={`absolute top-0.5 w-6 h-6 rounded-full shadow transition-all ${soundCuesEnabled ? 'left-7' : 'left-0.5'} ${theme.includes('high-contrast') ? 'bg-black' : 'bg-white'}`} />
                </button>
              </div>

              {/* Vibration */}
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${theme.includes('high-contrast') ? `border ${currentTheme.border}` : 'bg-purple-100'}`}>
                    <Vibrate size={20} className={theme.includes('high-contrast') ? currentTheme.textMain : 'text-purple-600'} />
                  </div>
                  <div>
                    <div className={`font-bold ${currentTheme.textMain}`}>Vibration</div>
                    <div className={`text-sm ${currentTheme.textSub}`}>Haptic feedback on taps</div>
                  </div>
                </div>
                <button onClick={() => setVibrationEnabled(!vibrationEnabled)} className={`w-14 h-8 rounded-full transition-colors relative border-2 ${vibrationEnabled ? `bg-${currentTheme.highlight}-500 border-${currentTheme.highlight}-500 ${theme === 'high-contrast-wb' ? 'bg-white border-white' : ''}` : `${theme.includes('high-contrast') ? 'bg-zinc-700 border-zinc-500' : 'bg-slate-600 border-slate-700'}`}`}>
                  <div className={`absolute top-0.5 w-6 h-6 rounded-full shadow transition-all ${vibrationEnabled ? 'left-7' : 'left-0.5'} ${theme.includes('high-contrast') ? 'bg-black' : 'bg-white'}`} />
                </button>
              </div>

              {/* Allow Skip */}
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${theme.includes('high-contrast') ? `border ${currentTheme.border}` : 'bg-sky-100'}`}>
                    <SkipForward size={20} className={theme.includes('high-contrast') ? currentTheme.textMain : 'text-sky-600'} />
                  </div>
                  <div>
                    <div className={`font-bold ${currentTheme.textMain}`}>Allow Skip</div>
                    <div className={`text-sm ${currentTheme.textSub}`}>Tap to skip during playback</div>
                  </div>
                </div>
                <button onClick={() => setAllowSkip(!allowSkip)} className={`w-14 h-8 rounded-full transition-colors relative border-2 ${allowSkip ? `bg-${currentTheme.highlight}-500 border-${currentTheme.highlight}-500 ${theme === 'high-contrast-wb' ? 'bg-white border-white' : ''}` : `${theme.includes('high-contrast') ? 'bg-zinc-700 border-zinc-500' : 'bg-slate-600 border-slate-700'}`}`}>
                  <div className={`absolute top-0.5 w-6 h-6 rounded-full shadow transition-all ${allowSkip ? 'left-7' : 'left-0.5'} ${theme.includes('high-contrast') ? 'bg-black' : 'bg-white'}`} />
                </button>
              </div>

              {/* Visual Theme */}
              <div className="space-y-3">
                <div className="flex items-center gap-3">
                  <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${theme.includes('high-contrast') ? `border ${currentTheme.border}` : 'bg-amber-100'}`}>
                    <Palette size={20} className={theme.includes('high-contrast') ? currentTheme.textMain : 'text-amber-600'} />
                  </div>
                  <div>
                    <div className={`font-bold ${currentTheme.textMain}`}>Visual Theme</div>
                    <div className={`text-sm ${currentTheme.textSub}`}>Reading appearance</div>
                  </div>
                </div>
                <div className="grid grid-cols-2 gap-3 mt-3">
                  {THEMES.map(t => (
                    <button key={t.id} onClick={() => setTheme(t.id)} className={`relative overflow-hidden p-1 rounded-xl border-2 transition-all group ${theme === t.id ? `${currentTheme.highlightBorder} ring-2 ${currentTheme.highlightRing}` : `${theme.includes('high-contrast') ? 'border-zinc-700 hover:border-zinc-500' : 'border-slate-200 hover:border-indigo-200'}`}`}>
                      <div className={`w-full aspect-[16/10] rounded-lg ${t.bg} flex flex-col items-center justify-center relative overflow-hidden`}>
                        {/* Mini text preview */}
                        <div className={`text-xs font-serif font-medium ${t.text} opacity-90 mb-1`}>Fairy Tale</div>
                        <div className={`w-12 h-0.5 rounded-full ${t.text} opacity-20`} />

                        {/* Mini progress bar */}
                        <div className="absolute bottom-0 left-0 right-0 h-1 bg-white/10">
                          <div className={`h-full w-2/3 ${t.progress}`} />
                        </div>
                      </div>

                      <div className={`p-2 text-center ${currentTheme.cardBg}`}>
                        <div className={`font-bold text-xs ${currentTheme.textMain}`}>{t.label}</div>
                      </div>

                      {/* Selection check */}
                      {theme === t.id && (
                        <div className={`absolute top-2 right-2 w-5 h-5 rounded-full flex items-center justify-center shadow-sm z-10 ${theme.includes('high-contrast') ? `${currentTheme.border} border-2 ${currentTheme.textMain}` : 'bg-indigo-500 text-white'}`}>
                          <Check size={12} className={theme.includes('high-contrast') ? '' : 'text-white'} strokeWidth={3} />
                        </div>
                      )}
                    </button>
                  ))}
                </div>
              </div>

              {/* Text Size */}
              <div className="space-y-3">
                <div className="flex items-center gap-3">
                  <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${theme.includes('high-contrast') ? `border ${currentTheme.border}` : 'bg-emerald-100'}`}>
                    <Eye size={20} className={theme.includes('high-contrast') ? currentTheme.textMain : 'text-emerald-600'} />
                  </div>
                  <div>
                    <div className={`font-bold ${currentTheme.textMain}`}>Text Size</div>
                    <div className={`text-sm ${currentTheme.textSub}`}>Story text size</div>
                  </div>
                </div>
                <div className="flex gap-2 mt-3">
                  {[{ id: 'normal', label: 'Normal' }, { id: 'large', label: 'Large' }, { id: 'huge', label: 'Huge' }].map(s => (
                    <button key={s.id} onClick={() => setTextSize(s.id)} className={`flex-1 p-3 rounded-xl border-2 text-center transition-all ${textSize === s.id ? `${currentTheme.highlightBorder} ${currentTheme.highlightBgLight}` : `${currentTheme.border} ${theme.includes('high-contrast') ? '' : 'hover:bg-slate-50'}`} ${currentTheme.cardBg}`}>
                      <div className={`font-bold mb-1 ${s.id === 'huge' ? 'text-2xl' : s.id === 'large' ? 'text-xl' : 'text-base'} ${currentTheme.textMain}`}>Aa</div>
                      <div className={`text-xs ${currentTheme.textSub}`}>{s.label}</div>
                    </button>
                  ))}
                </div>
              </div>



              {/* Screen Boundary */}
              <div className={`space-y-3 pt-4 border-t ${currentTheme.border}`}>
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${theme.includes('high-contrast') ? `border ${currentTheme.border}` : 'bg-orange-100'}`}>
                      <Layout size={20} className={theme.includes('high-contrast') ? currentTheme.textMain : 'text-orange-600'} />
                    </div>
                    <div>
                      <div className={`font-bold ${currentTheme.textMain}`}>Show Screen Boundary</div>
                      <div className={`text-sm ${currentTheme.textSub}`}>High contrast edge outline</div>
                    </div>
                  </div>
                  <button onClick={() => setShowBoundary(!showBoundary)} className={`w-14 h-8 rounded-full transition-colors relative border-2 ${showBoundary ? `bg-${currentTheme.highlight}-500 border-${currentTheme.highlight}-500 ${theme === 'high-contrast-wb' ? 'bg-white border-white' : ''}` : `${theme.includes('high-contrast') ? 'bg-zinc-700 border-zinc-500' : 'bg-slate-600 border-slate-700'}`}`}>
                    <div className={`absolute top-0.5 w-6 h-6 rounded-full shadow transition-all ${showBoundary ? 'left-7' : 'left-0.5'} ${theme.includes('high-contrast') ? 'bg-black' : 'bg-white'}`} />
                  </button>
                </div>

                <div className={`pt-4 border-t ${currentTheme.border} mt-4`}>
                  <div className="flex items-center gap-3 mb-3">
                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${theme.includes('high-contrast') ? `border ${currentTheme.border}` : 'bg-slate-100'}`}>
                      <PenTool size={16} className={theme.includes('high-contrast') ? currentTheme.textMain : 'text-slate-600'} />
                    </div>
                    <span className={`text-xs font-bold uppercase tracking-wider ${currentTheme.textSub}`}>Highlight Color (Boundary & Progress)</span>
                  </div>

                  <div className="grid grid-cols-6 gap-2">
                    {[{ id: 'yellow', hex: '#facc15', label: 'Yellow' }, { id: 'red', hex: '#ef4444', label: 'Red' }, { id: 'green', hex: '#10b981', label: 'Green' }, { id: 'orange', hex: '#f97316', label: 'Orange' }, { id: 'purple', hex: '#a855f7', label: 'Purple' }, { id: 'blue', hex: '#3b82f6', label: 'Blue' }].map(c => (
                      <button
                        key={c.id}
                        onClick={() => setBoundaryColor(c.id)}
                        className={`w-10 h-10 rounded-full transition-transform shadow-sm ${boundaryColor === c.id ? `ring-4 ring-offset-2 ${currentTheme.highlightRing} scale-110 ${theme.includes('high-contrast') ? 'ring-offset-zinc-900' : ''}` : `hover:scale-105 border-2 opacity-80 hover:opacity-100 ${theme.includes('high-contrast') ? 'border-zinc-600' : 'border-slate-200'}`}`}
                        style={{ backgroundColor: c.hex }}
                        title={c.label}
                      />
                    ))}
                  </div>
                </div>
              </div>

              {/* STORY OPTIONS */}
              <div className={`space-y-3 pt-4 border-t ${currentTheme.border}`}>
                <h3 className={`text-xs font-bold uppercase tracking-wider ${currentTheme.textSub}`}>Story Options</h3>

                {/* Show Title Page */}
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${theme.includes('high-contrast') ? `border ${currentTheme.border}` : 'bg-teal-100'}`}>
                      <Type size={20} className={theme.includes('high-contrast') ? currentTheme.textMain : 'text-teal-600'} />
                    </div>
                    <div>
                      <div className={`font-bold ${currentTheme.textMain}`}>Show Title Page</div>
                      <div className={`text-sm ${currentTheme.textSub}`}>Read title before story</div>
                    </div>
                  </div>
                  <button onClick={() => setShowTitlePage(!showTitlePage)} className={`w-14 h-8 rounded-full transition-colors relative border-2 ${showTitlePage ? `bg-${currentTheme.highlight}-500 border-${currentTheme.highlight}-500 ${theme === 'high-contrast-wb' ? 'bg-white border-white' : ''}` : `${theme.includes('high-contrast') ? 'bg-zinc-700 border-zinc-500' : 'bg-slate-600 border-slate-700'}`}`}>
                    <div className={`absolute top-0.5 w-6 h-6 rounded-full shadow transition-all ${showTitlePage ? 'left-7' : 'left-0.5'} ${theme.includes('high-contrast') ? 'bg-black' : 'bg-white'}`} />
                  </button>
                </div>

                {/* End Action */}
                <div className={`space-y-3 pt-4 border-t ${currentTheme.border}`}>
                  <div className="flex items-center gap-3">
                    <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${theme.includes('high-contrast') ? `border ${currentTheme.border}` : 'bg-blue-100'}`}>
                      <Check size={20} className={theme.includes('high-contrast') ? currentTheme.textMain : 'text-blue-600'} />
                    </div>
                    <div>
                      <div className={`font-bold ${currentTheme.textMain}`}>End of Story Action</div>
                      <div className={`text-sm ${currentTheme.textSub}`}>What happens when a story finishes</div>
                    </div>
                  </div>
                  <div className="grid grid-cols-2 gap-2 mt-2">
                    {[
                      { id: 'stop', label: 'Stop', desc: 'Stay on End Screen' },
                      { id: 'library', label: 'Library', desc: 'Return to list' },
                      { id: 'loop', label: 'Loop', desc: 'Show Replay button' },
                      { id: 'random', label: 'Random', desc: 'Play random story' }
                    ].map(opt => (
                      <button key={opt.id} onClick={() => setEndAction(opt.id)} className={`px-3 py-3 rounded-xl border-2 text-left transition-all ${endAction === opt.id ? `${currentTheme.highlightBorder} ${currentTheme.highlightBgLight} ${currentTheme.textMain} shadow-sm` : `${currentTheme.border} ${currentTheme.textSub} opacity-70`}`}>
                        <div className="font-bold text-sm">{opt.label}</div>
                        <div className="text-[10px] opacity-70">{opt.desc}</div>
                      </button>
                    ))}
                  </div>
                </div>

                {/* Lock Button Action */}
                <div className={`space-y-3 pt-4 border-t ${currentTheme.border}`}>
                  <div className="flex items-center gap-3">
                    <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${theme.includes('high-contrast') ? `border ${currentTheme.border}` : 'bg-red-100'}`}>
                      <Lock size={20} className={theme.includes('high-contrast') ? currentTheme.textMain : 'text-red-600'} />
                    </div>
                    <div>
                      <div className={`font-bold ${currentTheme.textMain}`}>Unlock Method</div>
                      <div className={`text-sm ${currentTheme.textSub}`}>How parents unlock the app</div>
                    </div>
                  </div>
                  <div className="grid grid-cols-2 gap-2 mt-2">
                    {[
                      { id: 'hold1', label: 'Hold 1s' },
                      { id: 'hold2', label: 'Hold 2s' },
                      { id: 'hold3', label: 'Hold 3s' },
                      { id: 'tripleTap', label: '3x Tap' }
                    ].map(opt => (
                      <button key={opt.id} onClick={() => setUnlockAction(opt.id)} className={`px-4 py-3 rounded-xl border-2 font-bold text-sm transition-all ${unlockAction === opt.id ? `${currentTheme.highlightBorder} ${currentTheme.highlightBgLight} ${currentTheme.textMain} shadow-sm` : `${currentTheme.border} ${currentTheme.textSub} opacity-70`}`}>
                        {opt.label}
                      </button>
                    ))}
                  </div>
                </div>
              </div>

              {/* About App */}
              <div className={`space-y-3 pt-4 border-t ${currentTheme.border}`}>
                <h3 className={`text-xs font-bold uppercase tracking-wider ${currentTheme.textSub}`}>About</h3>
                <div className={`rounded-2xl p-4 ${currentTheme.inputBg}`}>
                  <p className={`font-bold text-base mb-1 ${currentTheme.textMain}`}>StoryTap</p>
                  <p className={`text-sm ${currentTheme.textSub}`}>
                    Voice powered by <span className={`font-bold ${currentTheme.textMain}`}>Kokoro TTS</span> â€” an open-source text-to-speech model by <span className={`font-bold ${currentTheme.textMain}`}>Hexgrad</span>.
                  </p>
                  <p className={`text-xs mt-2 ${currentTheme.textSub} opacity-70`}>
                    Kokoro-82M-v1.0 running locally on your device via ONNX Runtime.
                  </p>
                </div>
              </div>

            </div>

            <div className={`p-6 border-t ${currentTheme.border}`}>
              <button onClick={() => setShowSettings(false)} className={`w-full py-3 font-bold rounded-xl transition-colors ${theme === 'high-contrast-yb' ? 'bg-yellow-400 text-black hover:bg-yellow-300' : theme === 'high-contrast-wb' ? 'bg-white text-black hover:bg-slate-200' : `bg-${currentTheme.highlight}-500 text-white hover:bg-${currentTheme.highlight}-600`}`}>Done</button>
            </div>
          </div>
        </div>
      );

      // BOUNDARY OVERLAY (High Visibility)
      const renderBoundary = () => {
        if (!showBoundary) return null;
        const colors = {
          yellow: 'border-yellow-400',
          red: 'border-red-500',
          green: 'border-emerald-500',
          orange: 'border-orange-500',
          purple: 'border-purple-500',
          blue: 'border-blue-500'
        };
        return (
          <div className={`fixed inset-0 border-[12px] ${colors[boundaryColor] || 'border-red-500'} pointer-events-none z-[9999]`} style={{ boxShadow: 'inset 0 0 20px rgba(0,0,0,0.2)' }} />
        );
      };

      // =============================================
      // LOADING SCREEN
      // =============================================
      if (mode === 'loading') {
        return (
          <div className={`fixed inset-0 flex flex-col items-center justify-center p-8 ${theme.includes('high-contrast') ? currentTheme.pageBg : 'bg-slate-900'}`}>
            <div className="relative mb-8">
              <div className={`w-24 h-24 rounded-3xl flex items-center justify-center shadow-2xl ${theme.includes('high-contrast') ? `border-2 ${currentTheme.border}` : 'bg-indigo-600 shadow-indigo-500/30'}`}>
                <Wand2 size={40} className={`animate-pulse ${theme.includes('high-contrast') ? currentTheme.textMain : 'text-white'}`} />
              </div>
            </div>
            <h2 className={`text-2xl font-extrabold mb-2 ${theme.includes('high-contrast') ? currentTheme.textMain : 'text-white'}`}>Preparing Magic Voice</h2>
            <p className={`text-sm mb-6 ${theme.includes('high-contrast') ? `${currentTheme.textSub}` : 'text-indigo-300'}`}>{modelStatus || 'This only happens once...'}</p>
            <div className={`w-64 h-2 rounded-full overflow-hidden ${theme.includes('high-contrast') ? `border ${currentTheme.border}` : 'bg-slate-800'}`}>
              <div className={`h-full transition-all duration-300 rounded-full ${theme.includes('high-contrast') ? currentTheme.progress : 'bg-indigo-500'}`} style={{ width: `${modelProgress}%` }} />
            </div>
            <p className={`mt-3 font-bold ${theme.includes('high-contrast') ? currentTheme.textMain : 'text-indigo-400'}`}>{modelProgress}%</p>

            {loadError && (
              <div className={`mt-6 p-4 rounded-xl max-w-md text-center ${theme.includes('high-contrast') ? `border ${currentTheme.border} ${currentTheme.textMain}` : 'bg-amber-900/50 text-amber-200'}`}>
                <AlertTriangle className="mx-auto mb-2" size={24} />
                <p className="text-sm">{loadError}</p>
                <p className="text-xs mt-2 opacity-75">Switching to backup voice...</p>
              </div>
            )}
          </div>
        );
      }

      // =============================================
      // LIBRARY SCREEN (Main Landing)
      // =============================================
      if (mode === 'library') {
        const renderStoryCard = (story) => {
          const colors = {
            indigo: 'bg-indigo-500',
            emerald: 'bg-emerald-500',
            amber: 'bg-amber-500',
            rose: 'bg-rose-500',
            purple: 'bg-purple-500',
            cyan: 'bg-cyan-500'
          };
          const headerColor = colors[story.color] || colors.indigo;

          const isProcessing = story.status === 'processing';
          const isCached = story.status === 'cached';

          // Smart click handler: Play if cached, Download if not (and unlocked)
          const handleCardClick = (e) => {
            if (showEditControls && !isCached && !isProcessing) {
              preloadBook(story, e);
            } else {
              loadBookForPlay(story);
            }
          };

          return (
            <div key={story.id}
              onClick={handleCardClick}
              className={`aspect-[3/4] relative rounded-3xl overflow-hidden shadow-xl transition-all group flex flex-col border-4 border-slate-900 ${currentTheme.cardBg} ${isCached ? 'cursor-pointer hover:scale-[1.02] hover:shadow-2xl' : 'cursor-default opacity-90 grayscale-[0.3]'}`}
            >
              {/* Colored Header: Title */}
              <div className={`flex-1 p-6 flex items-center justify-center text-center relative ${headerColor}`}>
                <h3 className="text-3xl font-extrabold leading-tight text-black line-clamp-4">{story.title}</h3>
              </div>

              {/* Dark Footer: Status & Actions */}
              <div className="bg-slate-900 px-4 py-3 text-white relative border-t-4 border-slate-900">
                <div className="flex items-center justify-between gap-2">

                  {/* Left: Status / Main Action */}
                  <div className="flex items-center gap-2 flex-1 min-w-0">
                    {isProcessing ? (
                      <div className="flex items-center gap-2">
                        <div className="flex flex-col text-white">
                          <span className="font-black text-lg">{story.progress}%</span>
                          <span className="text-[10px] font-bold opacity-80 uppercase tracking-widest">Loading</span>
                        </div>
                        <button
                          onClick={(e) => cancelDownload(story.id, e)}
                          className="p-2.5 rounded-xl bg-rose-500/30 hover:bg-rose-500/50 text-rose-300 transition-all active:scale-95 border border-rose-500/20"
                          title="Cancel download"
                        >
                          <X size={18} />
                        </button>
                      </div>
                    ) : isCached ? (
                      <div className="flex items-center gap-2" style={{ color: { yellow: '#facc15', red: '#ef4444', green: '#10b981', orange: '#f97316', purple: '#a855f7', blue: '#3b82f6' }[boundaryColor] || '#facc15' }}>
                        <div className="p-2.5 rounded-xl bg-white/10">
                          <Play size={26} fill="currentColor" />
                        </div>
                        <span className="font-bold text-base hidden sm:block">Read</span>
                      </div>
                    ) : (
                      <button onClick={(e) => { e.stopPropagation(); preloadBook(story, e); }} className="flex items-center gap-2 px-4 py-2.5 bg-white/20 hover:bg-white/30 rounded-xl text-white transition-all active:scale-95 border border-white/20 shadow-lg">
                        <Download size={18} className="shrink-0" />
                        <span className="font-bold text-sm leading-tight">Process Story</span>
                      </button>
                    )}
                  </div>

                  {/* Right: Edit Controls (Only if unlocked) */}
                  {showEditControls && (
                    <div className="flex items-center gap-1.5 shrink-0">
                      {/* Edit Button */}
                      <button onClick={(e) => editBook(story, e)} className="p-2.5 bg-white/10 rounded-xl hover:bg-white/20 text-white transition-all active:scale-95 border border-white/10" title="Edit story">
                        <Pencil size={18} />
                      </button>

                      {/* Delete Button - Orange for cache delete, Red for permanent story delete */}
                      {isCached ? (
                        <button onClick={(e) => deleteBook(story, e)} className="p-2.5 bg-orange-500/20 rounded-xl hover:bg-orange-500/40 text-orange-400 transition-all active:scale-95 border border-orange-500/20" title="Delete cached audio">
                          <Trash2 size={18} />
                        </button>
                      ) : (
                        <button onClick={(e) => deleteBook(story, e)} className="p-2.5 bg-rose-500/25 rounded-xl hover:bg-rose-500/50 text-rose-400 transition-all active:scale-95 border border-rose-500/25" title="Delete story permanently">
                          <Lock size={18} />
                        </button>
                      )}
                    </div>
                  )}
                </div>
              </div>

              {/* Progress Bar Overlay (Bottom edge) */}
              {isProcessing && (
                <div className="absolute bottom-0 left-0 h-2 bg-slate-800 w-full">
                  <div className="h-full transition-all duration-300 bg-indigo-500" style={{ width: `${story.progress}%` }} />
                </div>
              )}
            </div>
          );
        };

        // Filter stories based on lock state:
        // - Locked (child view): Only show cached/ready-to-play stories
        // - Unlocked (parent view): Show all stories so parents can download them
        const allSimpleStories = library.filter(s => s.folder === 'Simple Stories');
        const allUserStories = library.filter(s => !s.folder);

        const simpleStories = showEditControls
          ? allSimpleStories
          : allSimpleStories.filter(s => s.status === 'cached');
        const userStories = showEditControls
          ? allUserStories
          : allUserStories.filter(s => s.status === 'cached');

        // In child view (locked): cached simple stories appear as regular books (no folders)
        const childViewStories = showEditControls ? userStories : [...userStories, ...simpleStories];
        childViewStoriesRef.current = childViewStories;

        // Clamp carousel index if stories list shrinks
        if (carouselIndex >= childViewStories.length && childViewStories.length > 0) {
          setCarouselIndex(childViewStories.length - 1);
        }

        // Check if there are any stories at all (for empty state message)
        const hasAnyCachedStories = showEditControls
          ? (simpleStories.length > 0 || userStories.length > 0)
          : childViewStories.length > 0;
        const hasAnyStories = allSimpleStories.length > 0 || allUserStories.length > 0;

        // Processing Overlay Modal - blocks navigation during download
        const processingStory = library.find(s => s.status === 'processing');
        const ProcessingOverlay = () => {
          if (!processingStory) return null;

          const colors = {
            indigo: 'bg-indigo-500',
            emerald: 'bg-emerald-500',
            amber: 'bg-amber-500',
            rose: 'bg-rose-500',
            purple: 'bg-purple-500',
            cyan: 'bg-cyan-500'
          };
          const headerColor = colors[processingStory.color] || colors.indigo;

          return (
            <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm">
              <div className={`max-w-md w-full mx-6 rounded-3xl overflow-hidden shadow-2xl border-4 border-slate-900 ${currentTheme.cardBg}`}>
                {/* Colored Header */}
                <div className={`p-8 ${headerColor}`}>
                  <h2 className="text-3xl font-black text-white text-center leading-tight">{processingStory.title}</h2>
                </div>

                {/* Progress Content */}
                <div className="p-8 space-y-6 bg-slate-900">
                  <div className="text-center">
                    <div className="text-6xl font-black text-white mb-2">{processingStory.progress}%</div>
                    <div className="text-sm font-bold text-white/60 uppercase tracking-widest">Processing Story</div>
                    {processingStory.progressText && (
                      <div className="text-sm font-bold text-white/40 mt-2">{processingStory.progressText}</div>
                    )}
                  </div>

                  {/* Progress Bar */}
                  <div className="w-full h-3 bg-white/10 rounded-full overflow-hidden">
                    <div
                      className="h-full bg-white transition-all duration-300 ease-out"
                      style={{ width: `${processingStory.progress}%` }}
                    />
                  </div>

                  {/* Cancel Button */}
                  <button
                    onClick={(e) => cancelDownload(processingStory.id, e)}
                    className="w-full py-4 rounded-2xl bg-rose-500 hover:bg-rose-600 text-white font-bold text-lg transition-all active:scale-95 flex items-center justify-center gap-3"
                  >
                    <X size={24} />
                    Cancel Download
                  </button>

                  <p className="text-center text-white/40 text-sm">Please wait while we prepare this story...</p>
                </div>
              </div>
            </div>
          );
        };

        return (
          <div className={`min-h-screen overflow-x-hidden ${currentTheme.pageBg} p-6 md:p-8 transition-colors duration-300`}>
            {renderBoundary()}
            {showSettings && SettingsModal()}
            {ProcessingOverlay()}

            <header className="max-w-4xl mx-auto flex items-center justify-between mb-8">
              <div className="flex items-center gap-3">
                {viewFolder ? (
                  <button onClick={() => setViewFolder(null)} className={`flex items-center gap-2 font-bold ${currentTheme.textMain} hover:opacity-80 transition-colors`}>
                    <div className={`w-10 h-10 rounded-xl flex items-center justify-center border-2 ${theme.includes('high-contrast') ? `${currentTheme.cardBg} ${currentTheme.border}` : `${currentTheme.inputBg} ${currentTheme.border}`}`}>
                      <ArrowLeft size={20} className={currentTheme.textMain} />
                    </div>
                    <span className="text-xl">Back to Library</span>
                  </button>
                ) : (
                  <>
                    <div className={`w-12 h-12 rounded-xl bg-indigo-600 flex items-center justify-center shadow-lg text-white`}>
                      <BookOpen size={24} />
                    </div>
                    <h1 className={`text-3xl font-bold font-serif ${currentTheme.textMain} tracking-tight`}>StoryTap</h1>
                  </>
                )}
              </div>
              <div className="flex items-center gap-2">
                <button
                  onClick={showEditControls ? () => { setShowEditControls(false); playCue('tap'); } : handleLockClick}
                  onMouseDown={!showEditControls ? startHoldLock : undefined} onMouseUp={!showEditControls ? endHoldLock : undefined} onMouseLeave={!showEditControls ? endHoldLock : undefined}
                  onTouchStart={!showEditControls ? startHoldLock : undefined} onTouchEnd={!showEditControls ? endHoldLock : undefined} onTouchCancel={!showEditControls ? endHoldLock : undefined}
                  className={`relative p-3 rounded-2xl shadow-md transition-all border ${currentTheme.cardBg} ${currentTheme.border} ${currentTheme.textSub} ${isHoldingLock ? `ring-4 ring-offset-4 ring-${currentTheme.highlight}-400 scale-110 z-50` : ''}`}
                  title={showEditControls ? "Lock Library" : (unlockAction.startsWith('hold') ? "Hold to unlock" : "Tap 3 times to unlock")}
                >
                  {isHoldingLock && (
                    <svg className="absolute inset-0 w-full h-full pointer-events-none" viewBox="0 0 48 48">
                      <circle cx="24" cy="24" r="20" fill="none" stroke="currentColor" strokeWidth="3" strokeOpacity="0.15" />
                      <circle cx="24" cy="24" r="20" fill="none" stroke="currentColor" strokeWidth="3" strokeDasharray="126" strokeDashoffset={126 - (lockHoldProgress / 100) * 126} strokeLinecap="round" style={{ transform: 'rotate(-90deg)', transformOrigin: 'center' }} />
                    </svg>
                  )}
                  {showEditControls ? <Unlock size={22} className={currentTheme.textMain} /> : <Lock size={22} />}
                </button>
                <button
                  onClick={handleSettingsClick}
                  onMouseDown={startHoldSettings} onMouseUp={endHoldSettings} onMouseLeave={endHoldSettings}
                  onTouchStart={startHoldSettings} onTouchEnd={endHoldSettings} onTouchCancel={endHoldSettings}
                  className={`relative p-3 rounded-2xl shadow-md hover:shadow-lg transition-all border ${currentTheme.cardBg} ${currentTheme.border} ${currentTheme.textSub} ${isHoldingSettings ? `ring-4 ring-offset-4 ring-${currentTheme.highlight}-400 scale-110 z-50` : ''}`}
                  title="Hold for settings"
                >
                  {isHoldingSettings && (
                    <svg className="absolute inset-0 w-full h-full pointer-events-none" viewBox="0 0 48 48">
                      <circle cx="24" cy="24" r="20" fill="none" stroke="currentColor" strokeWidth="3" strokeOpacity="0.15" />
                      <circle cx="24" cy="24" r="20" fill="none" stroke="currentColor" strokeWidth="3" strokeDasharray="126" strokeDashoffset={126 - (settingsHoldProgress / 100) * 126} strokeLinecap="round" style={{ transform: 'rotate(-90deg)', transformOrigin: 'center' }} />
                    </svg>
                  )}
                  <Settings size={22} />
                </button>
              </div>
            </header>
            {(isHoldingSettings || isHoldingLock || lockFeedback || settingsFeedback) && (
              <div className={`max-w-4xl mx-auto -mt-6 mb-4 text-center text-sm font-bold animate-pulse ${currentTheme.textSub}`}>
                {lockFeedback || settingsFeedback || (isHoldingLock ? 'Hold to unlock...' : 'Hold for settings...')}
              </div>
            )}

            {/* End of Story Action â€” visible in parent/unlocked library */}
            {showEditControls && (
              <div className="max-w-4xl mx-auto mb-4">
                <div className={`flex flex-wrap items-center justify-center gap-2 p-3 rounded-2xl ${currentTheme.cardBg} border ${currentTheme.border}`}>
                  <span className={`w-full sm:w-auto text-center text-xs font-bold uppercase tracking-wider mb-2 sm:mb-0 sm:mr-2 ${currentTheme.textSub}`}>After Story:</span>
                  {[
                    { id: 'stop', label: 'Stop', icon: StopCircle },
                    { id: 'library', label: 'Library', icon: ArrowLeft },
                    { id: 'loop', label: 'Replay', icon: RefreshCw },
                    { id: 'random', label: 'Surprise', icon: Sparkles }
                  ].map(opt => {
                    const Icon = opt.icon;
                    const active = endAction === opt.id;
                    return (
                      <button
                        key={opt.id}
                        onClick={() => setEndAction(opt.id)}
                        className={`flex items-center justify-center gap-2 px-3 py-2 sm:px-4 sm:py-3 rounded-xl transition-all border-2 flex-grow sm:flex-grow-0 ${active ? `${currentTheme.highlightBorder} ${currentTheme.highlightBgLight} ${currentTheme.textMain} shadow-sm` : `${currentTheme.border} ${currentTheme.textSub} opacity-70`}`}
                      >
                        <Icon size={18} />
                        <span className="font-bold text-sm whitespace-nowrap">{opt.label}</span>
                      </button>
                    );
                  })}
                </div>
              </div>
            )}

            <div className="max-w-4xl mx-auto pb-12">

              {/* FOLDER VIEW: Simple Stories (parent/edit mode only) */}
              {viewFolder === 'Simple Stories' && showEditControls && (
                <div>
                  <div className="flex items-center gap-3 mb-6">
                    <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${theme.includes('high-contrast') ? `border ${currentTheme.border} ${currentTheme.textMain}` : 'bg-amber-100 text-amber-500'}`}>
                      <Star size={24} fill="currentColor" />
                    </div>
                    <h2 className={`text-2xl font-bold ${currentTheme.textMain}`}>Simple Stories</h2>
                  </div>
                  <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                    {simpleStories.map(renderStoryCard)}

                    {/* Empty state for folder */}
                    {simpleStories.length === 0 && (
                      <div className={`col-span-full flex flex-col items-center justify-center py-12 px-6 text-center`}>
                        <p className={`text-lg ${currentTheme.textSub}`}>
                          {showEditControls
                            ? "Download some stories to make them available for reading."
                            : "No stories downloaded yet. Ask a grown-up to add some!"}
                        </p>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* ROOT VIEW */}
              {viewFolder === null && showEditControls && (
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">

                  {/* Create New (Edit Mode Only, Root Only) */}
                  <button onClick={createNewBook} className={`aspect-[3/4] rounded-3xl border-4 border-dashed flex flex-col items-center justify-center gap-4 transition-all group ${currentTheme.border} ${theme.includes('high-contrast') ? `hover:border-current hover:bg-white/5 ${currentTheme.textMain}` : `hover:border-${currentTheme.highlight}-400 hover:bg-${currentTheme.highlight}-50/30`}`}>
                    <div className={`w-20 h-20 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform ${theme.includes('high-contrast') ? `border-2 ${currentTheme.border} ${currentTheme.textMain}` : `bg-${currentTheme.highlight}-100 text-${currentTheme.highlight}-600`}`}>
                      <Plus size={40} />
                    </div>
                    <span className={`font-bold text-lg ${currentTheme.textSub}`}>Create New Book</span>
                  </button>

                  {/* FOLDER: Simple Stories (parent/edit mode only) */}
                  {simpleStories.length > 0 && (
                    <button onClick={() => setViewFolder('Simple Stories')} className={`aspect-[3/4] relative rounded-3xl overflow-hidden shadow-xl transition-all cursor-pointer group hover:scale-[1.02] border-4 border-slate-900 ${theme.includes('high-contrast') ? currentTheme.cardBg : 'bg-amber-50 hover:bg-amber-100'}`}>
                      <div className="absolute inset-0 flex flex-col items-center justify-center p-6 text-center">
                        <div className="relative mb-6 group-hover:scale-110 transition-transform duration-300">
                          {!theme.includes('high-contrast') && <div className="absolute inset-0 bg-amber-200 blur-xl opacity-50 rounded-full"></div>}
                          <Star size={64} className={`relative drop-shadow-sm ${theme.includes('high-contrast') ? currentTheme.textMain : 'text-amber-400'}`} fill="currentColor" />
                        </div>
                        <h3 className={`text-2xl font-bold mb-2 ${theme.includes('high-contrast') ? currentTheme.textMain : 'text-amber-900'}`}>Simple Stories</h3>
                        <div className={`inline-flex items-center gap-2 px-4 py-1.5 rounded-full text-sm font-bold shadow-sm ${theme.includes('high-contrast') ? `border ${currentTheme.border} ${currentTheme.textMain}` : 'bg-white/60 text-amber-700'}`}>
                          <BookOpen size={14} />
                          {simpleStories.length} Books
                        </div>
                      </div>
                    </button>
                  )}

                  {/* Parent view: story cards */}
                  {childViewStories.map(renderStoryCard)}

                  {/* Empty State for unlocked parent view */}
                  {!hasAnyStories && !viewFolder && (
                    <div className={`col-span-full flex flex-col items-center justify-center py-8 px-6 text-center ${userStories.length === 0 && simpleStories.length === 0 ? '' : 'hidden'}`}>
                      <p className={`text-sm ${currentTheme.textSub}`}>
                        Tap "Create New Book" to add your first story, or download stories from Simple Stories.
                      </p>
                    </div>
                  )}
                </div>
              )}

              {/* CHILD VIEW: Coverflow Carousel */}
              {viewFolder === null && !showEditControls && (
                childViewStories.length > 0 ? (
                  <div
                    className="relative w-full select-none outline-none"
                    style={{
                      height: '70vh',
                      touchAction: 'pan-y'
                    }}
                    onTouchStart={(e) => {
                      const touch = e.touches[0];
                      carouselTouchRef.current = {
                        startX: touch.clientX,
                        startY: touch.clientY,
                        startTime: Date.now(),
                        isSwiping: false
                      };
                    }}
                    onTouchMove={(e) => {
                      const touch = e.touches[0];
                      const ref = carouselTouchRef.current;
                      const deltaX = touch.clientX - ref.startX;
                      const deltaY = touch.clientY - ref.startY;
                      if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 10) {
                        e.preventDefault();
                        ref.isSwiping = true;
                      }
                    }}
                    onTouchEnd={(e) => {
                      const ref = carouselTouchRef.current;
                      const touch = e.changedTouches[0];
                      const deltaX = touch.clientX - ref.startX;
                      const deltaY = touch.clientY - ref.startY;
                      const elapsed = Date.now() - ref.startTime;

                      if (Math.abs(deltaX) > 40 && Math.abs(deltaX) > Math.abs(deltaY)) {
                        if (deltaX < 0) {
                          setCarouselIndex(prev => Math.min(prev + 1, childViewStories.length - 1));
                        } else {
                          setCarouselIndex(prev => Math.max(prev - 1, 0));
                        }
                      } else if (Math.abs(deltaX) < 15 && Math.abs(deltaY) < 15 && elapsed < 300) {
                        const story = childViewStories[carouselIndex];
                        if (story && story.status === 'cached') {
                          loadBookForPlay(story);
                        }
                      }
                    }}
                    onClick={() => {
                      const story = childViewStories[carouselIndex];
                      if (story && story.status === 'cached') {
                        loadBookForPlay(story);
                      }
                    }}
                    tabIndex={0}
                    role="listbox"
                    aria-label="Story carousel. Swipe left or right to browse stories."
                    onKeyDown={(e) => {
                      if (e.key === 'ArrowLeft') {
                        e.preventDefault();
                        setCarouselIndex(prev => Math.max(prev - 1, 0));
                      } else if (e.key === 'ArrowRight') {
                        e.preventDefault();
                        setCarouselIndex(prev => Math.min(prev + 1, childViewStories.length - 1));
                      } else if (e.key === 'Enter') {
                        e.preventDefault();
                        const story = childViewStories[carouselIndex];
                        if (story && story.status === 'cached') loadBookForPlay(story);
                      }
                    }}
                    ref={(el) => { if (el && !showEditControls) el.focus(); }}
                  >
                    <audio ref={carouselAudioRef} preload="auto" hidden />

                    <div className="w-full flex items-center" style={{ height: 'calc(100% - 40px)' }}>
                      <div
                        className="flex items-center gap-8 flex-nowrap"
                        style={{
                          position: 'relative',
                          left: '50%',
                          transformOrigin: 'left center',
                          transition: 'transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)',
                          transform: `translateX(calc(-130px - ${carouselIndex * 292}px))`
                        }}
                      >
                        {childViewStories.map((story, idx) => {
                          const colors = {
                            indigo: 'bg-indigo-500', emerald: 'bg-emerald-500', amber: 'bg-amber-500',
                            rose: 'bg-rose-500', purple: 'bg-purple-500', cyan: 'bg-cyan-500'
                          };
                          const headerColor = colors[story.color] || colors.indigo;
                          const isSelected = idx === carouselIndex;

                          const glowHex = {
                            yellow: '#facc15', red: '#ef4444', green: '#10b981',
                            orange: '#f97316', purple: '#a855f7', blue: '#3b82f6'
                          }[boundaryColor] || '#facc15';

                          return (
                            <div
                              key={story.id}
                              role="option"
                              aria-selected={isSelected}
                              aria-label={story.title}
                              className={`flex-shrink-0 ${isSelected ? 'coverflow-selected' : ''}`}
                              style={{
                                width: '260px',
                                aspectRatio: '3/4',
                                border: '4px solid #0f172a',
                                outline: isSelected ? `10px solid ${glowHex}` : 'none',
                                outlineOffset: '6px',
                                borderRadius: '1.5rem',
                                overflow: 'hidden',
                                pointerEvents: 'none'
                              }}
                            >
                              <div className={`h-3/4 p-6 flex items-center justify-center text-center ${headerColor}`}>
                                <h3 className="text-3xl font-extrabold leading-tight text-black line-clamp-4">
                                  {story.title}
                                </h3>
                              </div>
                              <div className="h-1/4 bg-slate-900 flex items-center justify-center border-t-4 border-slate-900">
                                <div className="flex items-center gap-2" style={{ color: isSelected ? glowHex : '#94a3b8' }}>
                                  <Play size={isSelected ? 32 : 24} fill="currentColor" />
                                  {isSelected && <span className="font-bold text-lg text-white">Tap to Read</span>}
                                </div>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>

                    {/* Dot indicators */}
                    {childViewStories.length > 1 && (
                      <div className="flex justify-center gap-2 pt-4">
                        {childViewStories.map((_, idx) => {
                          const glowHex = {
                            yellow: '#facc15', red: '#ef4444', green: '#10b981',
                            orange: '#f97316', purple: '#a855f7', blue: '#3b82f6'
                          }[boundaryColor] || '#facc15';
                          return (
                            <div
                              key={idx}
                              className="rounded-full transition-all duration-300"
                              style={{
                                width: idx === carouselIndex ? '24px' : '10px',
                                height: '10px',
                                backgroundColor: idx === carouselIndex
                                  ? glowHex
                                  : (theme.includes('high-contrast') ? '#ffffff40' : '#94a3b8')
                              }}
                            />
                          );
                        })}
                      </div>
                    )}
                  </div>
                ) : (
                  /* Empty state: no cached books */
                  <div className="flex flex-col items-center justify-center py-16 px-6 text-center">
                    <div className={`w-24 h-24 rounded-full flex items-center justify-center mb-6 ${theme.includes('high-contrast') ? `border-2 ${currentTheme.border}` : 'bg-indigo-100'}`}>
                      <BookOpen size={48} className={theme.includes('high-contrast') ? currentTheme.textMain : 'text-indigo-400'} />
                    </div>
                    <h3 className={`text-2xl font-bold mb-3 ${currentTheme.textMain}`}>No Stories Yet</h3>
                    <p className={`text-lg mb-6 max-w-sm ${currentTheme.textSub}`}>
                      Unlock the app to add stories to your child's library.
                    </p>
                    <div className={`flex items-center gap-2 px-4 py-2 rounded-full text-sm ${theme.includes('high-contrast') ? `border ${currentTheme.border} ${currentTheme.textSub}` : 'bg-slate-100 text-slate-500'}`}>
                      <Lock size={14} />
                      <span>Hold the lock button to unlock</span>
                    </div>
                  </div>
                )
              )}
            </div>

            {/* Storage Indicator (Fixed at bottom - only visible when unlocked for parents) */}
            {showEditControls && (
              <div className="fixed bottom-0 left-0 right-0 z-40 pointer-events-none">
                <div className="max-w-4xl mx-auto px-6 pb-6 pointer-events-auto">
                  <div className={`rounded-2xl shadow-2xl border-2 overflow-hidden ${currentTheme.cardBg} ${currentTheme.border}`}>
                    <div className="p-4 flex items-center justify-between gap-4">
                      {/* Left: Storage Info */}
                      <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0 ${theme.includes('high-contrast') ? `border ${currentTheme.border}` : 'bg-indigo-100'}`}>
                          <Database size={20} className={theme.includes('high-contrast') ? currentTheme.textMain : 'text-indigo-600'} />
                        </div>
                        <div>
                          <div className={`font-bold text-sm ${currentTheme.textMain}`} style={{ color: theme.includes('high-contrast') ? (theme === 'high-contrast-yb' ? '#facc15' : '#ffffff') : undefined }}>
                            {cacheStats.count === 0 ? 'No cached audio' : `${(cacheStats.totalSize / (1024 * 1024)).toFixed(1)} MB cached`}
                          </div>
                          <div className={`text-xs ${currentTheme.textSub}`} style={{ color: theme.includes('high-contrast') ? (theme === 'high-contrast-yb' ? '#fde047' : '#d1d5db') : undefined }}>
                            {cacheStats.count === 0 ? 'Download stories to cache audio' : `${cacheStats.count} audio pages saved`}
                          </div>
                        </div>
                      </div>

                      {/* Right: Clear Button */}
                      {cacheStats.count > 0 && (
                        <button
                          onClick={handleClearCache}
                          className={`px-4 py-2 rounded-xl font-bold text-sm transition-all active:scale-95 shadow-md flex items-center gap-2 ${theme.includes('high-contrast') ? `border ${currentTheme.border} ${currentTheme.textMain}` : 'bg-rose-500 hover:bg-rose-600 text-white'}`}
                        >
                          <Trash2 size={16} />
                          Clear All
                        </button>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      // =============================================
      // CREATE BOOK SCREEN
      // =============================================
      if (mode === 'create') {
        const isHighContrast = theme.includes('high-contrast');
        // Use thick dark border for standard themes, or theme border for high contrast
        const activeBorder = isHighContrast ? `border-4 ${currentTheme.border}` : 'border-4 border-slate-900';
        const labelClass = `text-lg font-bold uppercase tracking-widest mb-3 block ${currentTheme.textSub} opacity-90`;

        return (
          <div className={`min-h-screen ${currentTheme.pageBg} p-6 md:p-8 transition-colors duration-300`}>
            {renderBoundary()}
            {showSettings && SettingsModal()}

            <div className="max-w-3xl mx-auto space-y-8 pb-12">
              <header className="flex items-center justify-between mb-8">
                <button onClick={() => setMode('library')} className={`flex items-center gap-3 font-bold ${currentTheme.textMain} hover:opacity-80 transition-all active:scale-95`}>
                  <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${currentTheme.cardBg} ${activeBorder}`}>
                    <ArrowLeft size={24} className={currentTheme.textMain} strokeWidth={3} />
                  </div>
                  <span className="text-xl">Back to Library</span>
                </button>
                <div className={`text-2xl font-black font-serif ${currentTheme.textMain}`}>{editingId ? 'Edit Story' : 'Create Story'}</div>
              </header>

              <div className={`${currentTheme.cardBg} rounded-3xl p-6 md:p-8 space-y-10 ${activeBorder} shadow-2xl`}>

                {/* Intro / Help Text */}
                <div className={`p-5 rounded-2xl flex gap-4 ${isHighContrast ? `border-4 ${currentTheme.border}` : 'bg-slate-100 border-4 border-slate-200'}`}>
                  <div className={`p-3 rounded-xl h-fit flex-shrink-0 ${isHighContrast ? `${currentTheme.highlightBgLight} ${currentTheme.textMain}` : 'bg-indigo-500 text-white'}`}>
                    <Sparkles size={24} fill="currentColor" />
                  </div>
                  <div className="space-y-4">
                    <div>
                      <h3 className={`font-bold text-lg mb-1 ${currentTheme.textMain}`}>Create Custom Stories</h3>
                      <p className={`text-base leading-relaxed ${currentTheme.textSub}`}>
                        In this menu, you can input a short story for your child. It will be processed locally by a task-specific AI model on your device into a realistic voice. <strong>No data will leave your device.</strong>
                      </p>
                    </div>

                    <div className={`text-base leading-relaxed ${currentTheme.textSub} opacity-90 space-y-2`}>
                      <p className="italic">
                        Note: Processing (saving the story to your child's library) <strong>takes time</strong> because it runs entirely on your device. Speed depends on the power of your device (phone, tablet, or computer).
                      </p>
                      <p className={`text-sm font-bold border-l-4 ${isHighContrast ? 'border-current' : 'border-indigo-400'} pl-3 py-1`}>
                        This app is not connected to the cloud, so you will need to leave your app open while initially processing the story. This only needs to be done once.
                        <span className="block font-normal opacity-90 mt-1">Tip: 5-8 sentences is ideal for most mobile devices.</span>
                      </p>
                    </div>

                    <div className={`mt-2 pt-3 border-t-2 ${isHighContrast ? 'border-current' : 'border-slate-300'} opacity-80 text-sm ${currentTheme.textSub}`}>
                      <div className={`font-bold uppercase text-xs tracking-wider mb-1 flex items-center gap-1 ${currentTheme.textMain}`}><Database size={12} /> Storage Info</div>
                      Stories are saved in your internet browser and consume space. You can check usage in the Settings menu and delete books to reclaim space.
                    </div>
                  </div>
                </div>

                {/* Title Input */}
                <div>
                  <label className={labelClass}>Story Title</label>
                  <input
                    type="text"
                    value={storyTitle}
                    onChange={e => setStoryTitle(e.target.value)}
                    className={`w-full p-5 rounded-2xl text-2xl font-bold focus:outline-none transition-all ${currentTheme.inputBg} ${currentTheme.textMain} ${activeBorder} focus:ring-4 focus:ring-current placeholder:opacity-50`}
                    style={{ color: theme.includes('high-contrast') ? (theme === 'high-contrast-yb' ? '#facc15' : '#ffffff') : undefined }}
                    placeholder="e.g. The Brave Little Toaster"
                  />
                </div>

                {/* Text Input */}
                <div>
                  <label className={labelClass}>Story Text</label>
                  <textarea
                    value={rawText}
                    onChange={e => setRawText(e.target.value)}
                    className={`w-full min-h-[240px] p-5 rounded-2xl text-xl leading-relaxed focus:outline-none transition-all font-serif ${currentTheme.inputBg} ${currentTheme.textMain} ${activeBorder} focus:ring-4 focus:ring-current placeholder:opacity-50`}
                    style={{ color: theme.includes('high-contrast') ? (theme === 'high-contrast-yb' ? '#facc15' : '#ffffff') : undefined }}
                    placeholder="Type or paste the full story here..."
                  />
                </div>

                {/* Card Color */}
                <div>
                  <label className={labelClass}>Card Header Color</label>
                  <div className="grid grid-cols-6 gap-4">
                    {['indigo', 'emerald', 'amber', 'rose', 'purple', 'cyan'].map(c => {
                      const colorMap = {
                        indigo: 'bg-indigo-500',
                        emerald: 'bg-emerald-500',
                        amber: 'bg-amber-500',
                        rose: 'bg-rose-500',
                        purple: 'bg-purple-500',
                        cyan: 'bg-cyan-500'
                      };
                      const bg = colorMap[c];
                      const isSelected = storyColor === c;

                      return (
                        <button
                          key={c}
                          onClick={() => setStoryColor(c)}
                          className={`h-16 rounded-2xl transition-all ${bg} ${activeBorder} ${isSelected ? 'ring-4 ring-offset-4 ring-slate-900 scale-105 shadow-xl z-10' : 'opacity-80 hover:opacity-100 hover:scale-105'}`}
                          title={`Select ${c} color`}
                        >
                          {isSelected && <Check className="mx-auto text-white" size={32} strokeWidth={4} />}
                        </button>
                      );
                    })}
                  </div>
                </div>

                {/* Save Button */}
                <button onClick={saveCreatedBook} disabled={!rawText.trim() || !storyTitle.trim()} className={`w-full py-6 rounded-2xl text-2xl font-black flex items-center justify-center gap-4 transition-all active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed ${isHighContrast ? `${currentTheme.cardBg} ${currentTheme.textMain} border-4 ${currentTheme.border}` : 'bg-slate-900 text-white shadow-xl hover:bg-slate-800'}`}>
                  <Sparkles size={28} />
                  {editingId ? 'Save Changes' : 'Save New Story'}
                </button>

              </div>
            </div>
          </div>
        );
      }

      // =============================================
      // READING MODE
      // =============================================
      const isCover = currentIndex === -1;
      const isEnd = currentIndex >= sentences.length;
      const isReading = !isCover && !isEnd;
      const progress = sentences.length ? ((currentIndex + 1) / sentences.length) * 100 : 0;

      return (
        <div
          onTouchStart={handleTouchInteraction}
          onClick={handleInteraction}
          onContextMenu={(e) => e.preventDefault()}
          onKeyDown={(e) => { if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); handleInteraction(e); } }}
          className="fixed inset-0 select-none cursor-pointer overflow-hidden"
          style={{ touchAction: 'none' }}
          role="button"
          tabIndex={0}
          aria-label={isCover ? 'Tap anywhere to begin the story' : isEnd ? 'Tap to start over' : `Sentence ${currentIndex + 1} of ${sentences.length}. Tap for next.`}
          aria-live="polite"
        >
          {renderBoundary()}
          <audio ref={audioRef} onEnded={handleAudioEnded} preload="auto" hidden />

          <div className="absolute top-5 left-5 z-[60]" onTouchStart={(e) => e.stopPropagation()} onClick={(e) => e.stopPropagation()}>
            <button
              onClick={handleExitClick}
              onMouseDown={startHoldExit} onMouseUp={endHoldExit} onMouseLeave={endHoldExit}
              onTouchStart={startHoldExit} onTouchEnd={endHoldExit} onTouchCancel={endHoldExit}
              className={`relative p-3 rounded-full transition-all ${currentTheme.readingDark ? 'bg-white/10 hover:bg-white/20 text-white/60 hover:text-white/90' : 'bg-black/10 hover:bg-black/20 text-black/60 hover:text-black/90'}`}
            >
              {isHoldingExit && (
                <svg className="absolute inset-0 w-full h-full -rotate-90" viewBox="0 0 36 36">
                  <circle cx="18" cy="18" r="16" fill="none" stroke="currentColor" strokeWidth="2" strokeOpacity="0.2" />
                  <circle cx="18" cy="18" r="16" fill="none" stroke="currentColor" strokeWidth="2" strokeDasharray="100" strokeDashoffset={100 - holdProgress} strokeLinecap="round" />
                </svg>
              )}
              <ArrowLeft size={18} />
            </button>
            {(isHoldingExit || exitFeedback) && <div className={`absolute left-14 top-1/2 -translate-y-1/2 text-xs px-3 py-1.5 rounded-lg whitespace-nowrap ${currentTheme.readingDark ? 'bg-black/80 text-white' : 'bg-white/90 text-black shadow-lg'}`}>{exitFeedback || 'Hold to exit...'}</div>}
          </div>

          {/* Fullscreen toggle - now protected */}
          {!isStandalone() && (
            <div className="absolute top-5 right-5 z-[60]" onTouchStart={(e) => e.stopPropagation()} onClick={(e) => e.stopPropagation()}>
              <button
                onClick={handleFSClick}
                onMouseDown={startHoldFS} onMouseUp={endHoldFS} onMouseLeave={endHoldFS}
                onTouchStart={startHoldFS} onTouchEnd={endHoldFS} onTouchCancel={endHoldFS}
                className={`relative p-3 rounded-full transition-all ${currentTheme.readingDark ? 'bg-white/10 hover:bg-white/20 text-white/60 hover:text-white/90' : 'bg-black/10 hover:bg-black/20 text-black/60 hover:text-black/90'} ${isHoldingFS ? `ring-4 ring-offset-4 ring-${currentTheme.highlight}-400 ring-offset-black/20 scale-110` : ''}`}
                title={isFullscreenMode ? 'Exit fullscreen' : 'Enter fullscreen'}
              >
                {isHoldingFS && (
                  <svg className="absolute inset-0 w-full h-full -rotate-90" viewBox="0 0 36 36">
                    <circle cx="18" cy="18" r="16" fill="none" stroke="currentColor" strokeWidth="2" strokeOpacity="0.2" />
                    <circle cx="18" cy="18" r="16" fill="none" stroke="currentColor" strokeWidth="2" strokeDasharray="100" strokeDashoffset={100 - fsHoldProgress} strokeLinecap="round" />
                  </svg>
                )}
                {isFullscreenMode ? <Minimize2 size={18} /> : <Maximize2 size={18} />}
              </button>
              {(isHoldingFS || fsFeedback) && <div className={`absolute right-14 top-1/2 -translate-y-1/2 text-xs px-3 py-1.5 rounded-lg whitespace-nowrap ${currentTheme.readingDark ? 'bg-black/80 text-white' : 'bg-white/90 text-black shadow-lg'}`}>{fsFeedback || 'Hold to toggle...'}</div>}
            </div>
          )}

          {isCover && (
            <div className={`absolute inset-0 ${currentTheme.coverBg} flex flex-col items-center justify-center p-10`}>
              {!theme.includes('high-contrast') && (
                <div className="absolute inset-0 overflow-hidden pointer-events-none">
                  {/* Flat ambient background removed for accessibility */}
                </div>
              )}
              <div className="flex flex-col items-center justify-between h-full max-h-[800px] py-4">
                <div className="flex-1 flex flex-col items-center justify-center w-full">
                  <div className={`w-20 h-28 rounded-xl flex items-center justify-center border-4 ${currentTheme.readingDark ? 'glow' : 'shadow-lg'} backdrop-blur-sm mb-6 ${currentTheme.coverBorder} ${currentTheme.readingDark ? 'bg-white/10' : 'bg-black'}`}>
                    <BookOpen size={40} style={{ color: { yellow: '#facc15', red: '#ef4444', green: '#10b981', orange: '#f97316', purple: '#a855f7', blue: '#3b82f6' }[boundaryColor] || '#facc15' }} />
                  </div>
                  <h1 className={`text-4xl md:text-6xl font-black font-serif text-center mb-4 leading-tight tracking-tight fade-in-up ${currentTheme.coverText} max-w-4xl`}>{storyTitle}</h1>
                  <p className={`text-xl font-bold mb-8 fade-in-up ${currentTheme.coverSub}`}>A Story for You</p>

                  <div className="relative mb-8">
                    <div className={`absolute inset-0 w-20 h-20 rounded-full pulse-ring ${currentTheme.pulse}`} />
                    <div className={`w-20 h-20 rounded-full flex items-center justify-center border-4 backdrop-blur-sm ${currentTheme.coverElementBg} ${currentTheme.coverBorder}`}>
                      <Volume2 size={32} style={{ color: { yellow: '#facc15', red: '#ef4444', green: '#10b981', orange: '#f97316', purple: '#a855f7', blue: '#3b82f6' }[boundaryColor] || '#facc15' }} />
                    </div>
                  </div>
                </div>

                <div className="flex flex-col items-center pb-8">
                  <span className={`font-black text-xl uppercase tracking-widest mb-2 ${currentTheme.coverSub}`}>Tap Anywhere</span>
                  <span className={`text-lg font-bold ${currentTheme.coverSub} border-b-2 ${currentTheme.coverBorder} pb-1`}>Title Page</span>
                </div>
              </div>
            </div>
          )
          }

          {
            isReading && (
              <div className={`absolute inset-0 ${currentTheme.bg} flex flex-col items-center justify-center px-8 pt-20 pb-40 md:px-16 md:pt-24 md:pb-48`}>
                <div className={`relative max-w-5xl mx-auto px-6 ${isTransitioning ? 'page-turn' : ''}`}>
                  <p className={`${getTextSizeClass()} font-serif font-bold text-center leading-loose tracking-wide ${currentTheme.text}`}>{sentences[currentIndex]}</p>
                </div>
                <div className="absolute bottom-0 left-0 right-0 px-8 pb-6 pt-4 flex flex-col items-center gap-4">
                  {isPlaying ? (
                    <div className={`flex items-center gap-3 ${currentTheme.text} opacity-60`}>
                      <div className="flex gap-1">{[...Array(4)].map((_, i) => (<div key={i} className={`w-1 rounded-full animate-pulse ${currentTheme.progress}`} style={{ height: `${12 + Math.random() * 12}px`, animationDelay: `${i * 0.1}s` }} />))}</div>
                      <span className="text-sm font-semibold uppercase tracking-wider">Listening...</span>
                    </div>
                  ) : (
                    <div className={`flex items-center gap-2 opacity-40 animate-pulse ${currentTheme.text}`}>
                      <span className="text-sm font-semibold uppercase tracking-wider">Tap for next</span>
                    </div>
                  )}
                  <div className="w-full max-w-md mx-auto">
                    <div className={`h-8 rounded-full overflow-hidden border-4 border-current ${currentTheme.readingDark ? 'bg-white/20' : 'bg-black/10'} shadow-inner ${currentTheme.text}`}>
                      <div className={`h-full transition-all duration-500`} style={{ width: `${progress}%`, backgroundColor: { yellow: '#facc15', red: '#ef4444', green: '#10b981', orange: '#f97316', purple: '#a855f7', blue: '#3b82f6' }[boundaryColor] || '#facc15' }} />
                    </div>
                    <p className={`text-center text-lg mt-3 font-black uppercase tracking-widest ${currentTheme.text}`}>Page {currentIndex + 1}</p>
                  </div>
                </div>
              </div>
            )
          }

          {
            isEnd && (
              <div
                className={`absolute inset-0 ${currentTheme.coverBg} flex flex-col items-center justify-center p-10 z-50 cursor-pointer`}
                onTouchStart={(e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  const now = Date.now();
                  if (now - lastInteractionRef.current < 300) return;
                  lastInteractionRef.current = now;
                  executeEndAction();
                }}
                onClick={(e) => {
                  e.stopPropagation();
                  const now = Date.now();
                  if (now - lastInteractionRef.current < 300) return;
                  lastInteractionRef.current = now;
                  executeEndAction();
                }}
              >
                {!theme.includes('high-contrast') && (
                  <div className="absolute inset-0 overflow-hidden pointer-events-none"></div>
                )}
                <div className="flex flex-col items-center justify-between h-full max-h-[800px] py-4">
                  <div className="flex-1 flex flex-col items-center justify-center w-full">
                    {/* Check Icon Card */}
                    <div className={`w-20 h-28 rounded-xl flex items-center justify-center border-4 ${currentTheme.readingDark ? 'glow' : 'shadow-lg'} backdrop-blur-sm mb-6 ${currentTheme.coverBorder} ${currentTheme.readingDark ? 'bg-white/10' : 'bg-black'}`}>
                      <Check size={40} strokeWidth={3} style={{ color: { yellow: '#facc15', red: '#ef4444', green: '#10b981', orange: '#f97316', purple: '#a855f7', blue: '#3b82f6' }[boundaryColor] || '#facc15' }} />
                    </div>

                    <h1 className={`text-4xl md:text-6xl font-black font-serif text-center mb-4 leading-tight tracking-tight fade-in-up ${currentTheme.coverText}`}>The End</h1>
                    <p className={`text-xl font-bold mb-8 fade-in-up ${currentTheme.coverSub}`}>What a great story!</p>

                    {/* Action Icon (Centerpiece) */}
                    {endAction !== 'stop' && (
                      <div className="relative mb-8">
                        <div className={`absolute inset-0 w-24 h-24 rounded-full pulse-ring ${currentTheme.pulse}`} />
                        <div className={`w-24 h-24 rounded-full flex items-center justify-center border-4 backdrop-blur-sm shadow-xl ${currentTheme.coverElementBg} ${currentTheme.coverBorder}`}>
                          {endAction === 'library' && <ArrowLeft size={40} style={{ color: { yellow: '#facc15', red: '#ef4444', green: '#10b981', orange: '#f97316', purple: '#a855f7', blue: '#3b82f6' }[boundaryColor] || '#facc15' }} />}
                          {endAction === 'loop' && <RefreshCw size={40} style={{ color: { yellow: '#facc15', red: '#ef4444', green: '#10b981', orange: '#f97316', purple: '#a855f7', blue: '#3b82f6' }[boundaryColor] || '#facc15' }} />}
                          {endAction === 'random' && <Sparkles size={40} style={{ color: { yellow: '#facc15', red: '#ef4444', green: '#10b981', orange: '#f97316', purple: '#a855f7', blue: '#3b82f6' }[boundaryColor] || '#facc15' }} />}
                        </div>
                      </div>
                    )}

                    {endAction === 'stop' && (
                      <div className={`w-24 h-24 rounded-full flex items-center justify-center border-4 opacity-50 ${currentTheme.coverBorder}`}>
                        <StopCircle size={40} style={{ color: { yellow: '#facc15', red: '#ef4444', green: '#10b981', orange: '#f97316', purple: '#a855f7', blue: '#3b82f6' }[boundaryColor] || '#facc15' }} />
                      </div>
                    )}
                  </div>

                  <div className="flex flex-col items-center pb-8 opacity-80">
                    <span className={`font-black text-xl uppercase tracking-widest mb-2 ${currentTheme.coverSub}`}>
                      {endAction === 'library' && 'Tap for Library'}
                      {endAction === 'loop' && 'Tap to Read Again'}
                      {endAction === 'random' && 'Tap for Surprise'}
                      {endAction === 'stop' && 'Story Finished'}
                    </span>
                    {endAction !== 'stop' && <span className={`text-lg font-bold ${currentTheme.coverSub} border-b-2 ${currentTheme.coverBorder} pb-1`}>Next Step</span>}
                  </div>
                </div>
              </div>
            )
          }
        </div >
      );
    };

    createRoot(document.getElementById('root')).render(<App />);
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(registration => console.log('SW registered: ', registration.scope))
          .catch(registrationError => console.log('SW registration failed: ', registrationError));
      });
    }
  </script>
</body>

</html>