<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#6366f1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="description" content="Interactive touch stories for children with accessibility features." />
  <title>StoryTap â€” Touch Books for Little Ones</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/svg+xml" href="icon.svg" />
  <link rel="apple-touch-icon" href="icon.svg" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Crimson+Pro:wght@400;500;600&display=swap"
    rel="stylesheet">
  <script src="https://cdn.tailwindcss.com/3.4.16"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Nunito', 'system-ui', 'sans-serif'],
            serif: ['Crimson Pro', 'Georgia', 'serif'],
          },
        },
      },
    };
  </script>
  <style>
    * {
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      overscroll-behavior: none;
      font-family: 'Nunito', sans-serif;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
      -webkit-user-select: none;
      user-select: none;
      touch-action: manipulation;
      /* Prevents double-tap zoom on some devices */
    }

    input,
    textarea {
      -webkit-user-select: text;
      /* Allow typing */
      user-select: text;
      touch-action: auto;
    }

    @keyframes breathe {

      0%,
      100% {
        transform: scale(1);
        opacity: 0.5;
      }

      50% {
        transform: scale(1.1);
        opacity: 0.7;
      }
    }

    .ambient-orb {
      animation: breathe 8s ease-in-out infinite;
    }

    .ambient-orb-2 {
      animation: breathe 10s ease-in-out infinite;
      animation-delay: -3s;
    }

    @keyframes pulse-ring {
      0% {
        transform: scale(0.8);
        opacity: 0.8;
      }

      50% {
        transform: scale(1);
        opacity: 0.4;
      }

      100% {
        transform: scale(0.8);
        opacity: 0.8;
      }
    }

    .pulse-ring {
      animation: pulse-ring 2s ease-in-out infinite;
    }

    @keyframes glow {

      0%,
      100% {
        box-shadow: 0 0 30px rgba(255, 255, 255, 0.1);
      }

      50% {
        box-shadow: 0 0 60px rgba(255, 255, 255, 0.2);
      }
    }

    .glow {
      animation: glow 3s ease-in-out infinite;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in-up {
      animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    @keyframes pageTurn {
      0% {
        opacity: 1;
        transform: translateX(0);
      }

      50% {
        opacity: 0;
        transform: translateX(50px);
      }

      51% {
        opacity: 0;
        transform: translateX(-50px);
      }

      100% {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .page-turn {
      animation: pageTurn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes burst {
      0% {
        transform: scale(0) rotate(0deg);
        opacity: 1;
      }

      100% {
        transform: scale(2) rotate(180deg);
        opacity: 0;
      }
    }

    .burst {
      animation: burst 1s ease-out forwards;
    }

    @keyframes processingPulse {
      0%, 100% { border-color: rgba(129, 140, 248, 0.3); }
      50% { border-color: rgba(129, 140, 248, 1); }
    }

    .processing-card {
      animation: processingPulse 2s ease-in-out infinite;
      border-width: 3px;
    }
  </style>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useRef, useCallback, useMemo } from 'https://esm.sh/react@18.3.1';
    import { createRoot } from 'https://esm.sh/react-dom@18.3.1/client';
    import { BookOpen, Play, Volume2, VolumeX, Sparkles, ArrowLeft, Loader2, Check, Star, Heart, Moon, Sun, Wand2, Settings, X, Eye, Vibrate, Palette, AlertTriangle, List, Trash2, Save, Plus, Download, Pencil, SkipForward } from 'https://esm.sh/lucide-react?deps=react@18.3.1,react-dom@18.3.1';
    import { KokoroTTS } from 'https://esm.sh/kokoro-js';

    const MODEL_ID = "onnx-community/Kokoro-82M-v1.0-ONNX";

    // =============================================
    // CONFIGURATION
    // =============================================
    const VOICES = [
      { name: "af_heart", label: "Gentle", desc: "Warm bedtime voice", emoji: "ðŸŒ™", color: "from-violet-500 to-purple-600" },
      { name: "af_sky", label: "Cheerful", desc: "Bright & happy", emoji: "â˜€ï¸", color: "from-amber-400 to-orange-500" },
      { name: "bf_lily", label: "Soft", desc: "Calm & soothing", emoji: "ðŸŒ¸", color: "from-pink-400 to-rose-500" },
      { name: "am_puck", label: "Playful", desc: "Fun & silly", emoji: "ðŸŽ­", color: "from-emerald-400 to-teal-500" },
    ];

    const SPEEDS = [
      { label: "Slow & Cozy", value: 0.85, icon: Moon },
      { label: "Just Right", value: 1.0, icon: Heart },
      { label: "Energetic", value: 1.15, icon: Sun },
    ];

    const THEMES = [
      {
        id: 'default',
        label: 'Default',
        desc: 'Clean & Crisp',
        bg: 'from-slate-950 via-slate-900 to-slate-950',
        text: 'text-white',
        accent: 'indigo',
        progress: 'bg-indigo-500',
        coverBg: 'from-indigo-950 via-slate-900 to-indigo-950',
        coverText: 'text-white',
        coverSub: 'text-indigo-200',
        pulse: 'bg-white/10',
        coverBorder: 'border-white/10',
        coverElementBg: 'bg-white/5',

        // PWA & Setup Screen
        pageBg: 'bg-slate-50',
        cardBg: 'bg-white',
        textMain: 'text-slate-900',
        textSub: 'text-slate-500',
        border: 'border-slate-200',
        inputBg: 'bg-slate-50',
        highlight: 'indigo'
      },
      {
        id: 'calm',
        label: 'Calm Sky',
        desc: 'Peaceful Blue',
        bg: 'from-sky-50 via-blue-50 to-indigo-50',
        text: 'text-slate-800',
        accent: 'sky',
        progress: 'bg-sky-500',
        coverBg: 'from-sky-100 via-blue-50 to-indigo-50',
        coverText: 'text-sky-900',
        coverSub: 'text-sky-700',
        pulse: 'bg-sky-500/10',
        coverBorder: 'border-sky-200',
        coverElementBg: 'bg-white/60',

        // PWA & Setup Screen
        pageBg: 'bg-slate-50',
        cardBg: 'bg-white',
        textMain: 'text-slate-700',
        textSub: 'text-slate-400',
        border: 'border-sky-100',
        inputBg: 'bg-sky-50/20',
        highlight: 'sky'
      },
      {
        id: 'high-contrast-wb',
        label: 'High Contrast',
        desc: 'White on Black',
        bg: 'from-black to-black',
        text: 'text-white',
        accent: 'white',
        progress: 'bg-white',
        coverBg: 'from-black to-black',
        coverText: 'text-white',
        coverSub: 'text-white',
        pulse: 'bg-white/20',
        coverBorder: 'border-white',
        coverElementBg: 'bg-transparent',

        // PWA & Setup Screen
        pageBg: 'bg-black',
        cardBg: 'bg-zinc-900',
        textMain: 'text-white',
        textSub: 'text-slate-300',
        border: 'border-white',
        inputBg: 'bg-black',
        highlight: 'white'
      },
      {
        id: 'high-contrast-yb',
        label: 'Yellow on Black',
        desc: 'Accessibility',
        bg: 'from-black to-black',
        text: 'text-yellow-400',
        accent: 'yellow',
        progress: 'bg-yellow-400',
        coverBg: 'from-black via-zinc-900 to-black',
        coverText: 'text-yellow-400',
        coverSub: 'text-yellow-400/80',
        pulse: 'bg-yellow-400/20',
        coverBorder: 'border-yellow-400',
        coverElementBg: 'bg-transparent',

        // PWA & Setup Screen
        pageBg: 'bg-black',
        cardBg: 'bg-zinc-900',
        textMain: 'text-yellow-400',
        textSub: 'text-yellow-200',
        border: 'border-yellow-400',
        inputBg: 'bg-black',
        highlight: 'yellow'
      }
    ];

    // Optimized yield - use requestIdleCallback when available for non-urgent work
    const yieldToBrowser = () => new Promise(r => requestAnimationFrame(() => setTimeout(r, 0)));
    const yieldIdle = (timeout = 100) => new Promise(r => {
      if (window.requestIdleCallback) {
        window.requestIdleCallback(r, { timeout });
      } else {
        setTimeout(r, 16);
      }
    });

    // Detect device capabilities
    const getDeviceInfo = () => {
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const hasWebGPU = !!navigator.gpu;
      const memory = navigator.deviceMemory || 4; // Default to 4GB if not available
      const cores = navigator.hardwareConcurrency || 4;

      return { isMobile, isSafari, isIOS, hasWebGPU, memory, cores };
    };

    // =============================================
    // AUDIO CACHE SYSTEM (IndexedDB)
    // =============================================
    const DB_NAME = 'StoryTapAudioCache';
    const DB_VERSION = 2; // Upgraded to support LRU
    const STORE_NAME = 'audio_v2';
    const MAX_ITEMS = 300; // Limit to ~15MB of audio

    const openDB = () => new Promise((resolve, reject) => {
      const request = indexedDB.open(DB_NAME, DB_VERSION);
      request.onerror = () => reject(request.error);
      request.onsuccess = () => resolve(request.result);
      request.onupgradeneeded = (e) => {
        const db = e.target.result;
        // Clean up old v1 store if exists
        if (db.objectStoreNames.contains('audio')) {
          db.deleteObjectStore('audio');
        }
        if (!db.objectStoreNames.contains(STORE_NAME)) {
          const store = db.createObjectStore(STORE_NAME, { keyPath: 'key' });
          store.createIndex('ts', 'ts'); // Timestamp index for LRU
        }
      };
    });

    const getCachedAudio = async (key) => {
      try {
        const db = await openDB();
        return new Promise((resolve) => {
          const tx = db.transaction(STORE_NAME, 'readwrite'); // Readwrite to update TS
          const store = tx.objectStore(STORE_NAME);
          const request = store.get(key);
          request.onsuccess = () => {
            const result = request.result;
            if (result) {
              // Update timestamp (LRU)
              result.ts = Date.now();
              store.put(result);
              resolve(result.blob);
            } else resolve(null);
          };
          request.onerror = () => resolve(null);
        });
      } catch (e) { return null; }
    };

    const setCachedAudio = async (key, blob) => {
      try {
        const db = await openDB();
        return new Promise((resolve) => {
          const tx = db.transaction(STORE_NAME, 'readwrite');
          const store = tx.objectStore(STORE_NAME);

          store.put({ key, blob, ts: Date.now() });

          // Periodic cleanup (simple check)
          const countReq = store.count();
          countReq.onsuccess = () => {
            if (countReq.result > MAX_ITEMS) {
              // Delete oldest
              const idx = store.index('ts');
              const cursorReq = idx.openCursor(); // Ascending = oldest first
              let deleted = 0;
              cursorReq.onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor && deleted < (countReq.result - MAX_ITEMS) + 5) {
                  cursor.delete();
                  deleted++;
                  cursor.continue();
                }
              };
            }
          };

          tx.oncomplete = () => resolve(true);
          tx.onerror = () => resolve(false);
        });
      } catch (e) { return false; }
    };

    // Create a hash key for caching (text + voice + speed + version)
    // Version 2: Fixed chunking bug - invalidates old partial audio
    const CACHE_VERSION = 2;
    const getCacheKey = (text, voice, speed) => {
      const str = `v${CACHE_VERSION}|${text}|${voice}|${speed}`;
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) - hash) + str.charCodeAt(i);
        hash = hash & hash;
      }
      return `audio_${hash}`;
    };

    // =============================================
    // TEXT OPTIMIZATION FOR FASTER TTS
    // =============================================
    // Clean text for TTS processing
    const cleanTextForTTS = (text) => {
      return text.trim().replace(/\s+/g, ' ');
    };

    // =============================================
    // AUDIO CUE ENGINE
    // =============================================
    const useAudioCues = (enabled, vibrationEnabled) => {
      const ctxRef = useRef(null);

      const getCtx = useCallback(() => {
        if (!ctxRef.current) {
          ctxRef.current = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (ctxRef.current.state === 'suspended') {
          ctxRef.current.resume().catch(() => { });
        }
        return ctxRef.current;
      }, []);

      const vibrate = useCallback((pattern) => {
        if (vibrationEnabled && navigator.vibrate) {
          try { navigator.vibrate(pattern); } catch (e) { }
        }
      }, [vibrationEnabled]);

      const play = useCallback((type) => {
        // Haptic patterns tailored for each cue type
        const haptics = {
          tap: 25,
          story_start: [40, 40, 80],
          story_end: [80, 40, 80, 40, 150],
          ready: [60, 30, 60],        // Strong double-pulse: "your turn!"
          advance: 20,
          busy: [15, 15, 15],         // Quick triple-buzz: "wait"
          cover_tap: [30, 20, 30],    // Gentle nudge
          download_done: [50, 30, 80] // Celebration
        };
        vibrate(haptics[type] || 15);

        if (!enabled) return;

        try {
          const ctx = getCtx();
          const now = ctx.currentTime;

          if (type === 'tap') {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, now);
            osc.frequency.exponentialRampToValueAtTime(1320, now + 0.05);
            gain.gain.setValueAtTime(0.12, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.08);
            osc.connect(gain).connect(ctx.destination);
            osc.start(now); osc.stop(now + 0.1);
          } else if (type === 'story_start') {
            [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              osc.type = 'triangle';
              osc.frequency.value = freq;
              gain.gain.setValueAtTime(0, now + i * 0.1);
              gain.gain.linearRampToValueAtTime(0.1, now + i * 0.1 + 0.03);
              gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.1 + 0.35);
              osc.connect(gain).connect(ctx.destination);
              osc.start(now + i * 0.1); osc.stop(now + i * 0.1 + 0.4);
            });
          } else if (type === 'ready') {
            // Friendly two-tone "ding-ding" â€” clearly signals "your turn to tap!"
            [698.46, 880].forEach((freq, i) => {
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              osc.type = 'sine';
              osc.frequency.value = freq;
              gain.gain.setValueAtTime(0, now + i * 0.15);
              gain.gain.linearRampToValueAtTime(0.14, now + i * 0.15 + 0.02);
              gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.15 + 0.35);
              osc.connect(gain).connect(ctx.destination);
              osc.start(now + i * 0.15); osc.stop(now + i * 0.15 + 0.4);
            });
          } else if (type === 'cover_tap') {
            // Warm welcoming tone for the cover page
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(523.25, now);
            osc.frequency.exponentialRampToValueAtTime(659.25, now + 0.15);
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.1, now + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
            osc.connect(gain).connect(ctx.destination);
            osc.start(now); osc.stop(now + 0.35);
          } else if (type === 'download_done') {
            // Happy completion chime
            [523.25, 659.25, 783.99].forEach((freq, i) => {
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              osc.type = 'triangle';
              osc.frequency.value = freq;
              gain.gain.setValueAtTime(0, now + i * 0.08);
              gain.gain.linearRampToValueAtTime(0.1, now + i * 0.08 + 0.02);
              gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.08 + 0.3);
              osc.connect(gain).connect(ctx.destination);
              osc.start(now + i * 0.08); osc.stop(now + i * 0.08 + 0.35);
            });
          } else if (type === 'advance') {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(440, now);
            osc.frequency.exponentialRampToValueAtTime(660, now + 0.12);
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.05, now + 0.03);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
            osc.connect(gain).connect(ctx.destination);
            osc.start(now); osc.stop(now + 0.2);
          } else if (type === 'story_end') {
            [[523.25, 0], [659.25, 0.12], [783.99, 0.24], [1046.50, 0.36]].forEach(([freq, delay]) => {
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              osc.type = 'triangle';
              osc.frequency.value = freq;
              gain.gain.setValueAtTime(0, now + delay);
              gain.gain.linearRampToValueAtTime(0.12, now + delay + 0.02);
              gain.gain.exponentialRampToValueAtTime(0.001, now + delay + 0.5);
              osc.connect(gain).connect(ctx.destination);
              osc.start(now + delay); osc.stop(now + delay + 0.6);
            });
          } else if (type === 'busy') {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.value = 200;
            gain.gain.setValueAtTime(0.06, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
            osc.connect(gain).connect(ctx.destination);
            osc.start(now); osc.stop(now + 0.15);
          }
        } catch (e) {
          console.warn('Audio cue error:', e);
        }
      }, [enabled, getCtx, vibrate]);

      return { play, vibrate };
    };

    // =============================================
    // MAIN APPLICATION
    // =============================================
    const DEFAULT_STORY_TITLE = "The Brave Little Bear";
    const DEFAULT_STORY_TEXT = "Once upon a time, there was a little bear who lived in a cozy cave.\nThe bear loved honey more than anything in the world.\nOne sunny morning, the bear smelled something sweet.\nIt was coming from a tall, tall tree!\nThe bear looked up and saw a beehive.\nBuzz buzz buzz, sang the busy bees.\nThe little bear was scared, but also very hungry.\nSo the bear took a deep breath and started to climb.\nUp, up, up went the brave little bear!\nThe bees flew around, but the bear kept going.\nFinally, the bear reached the golden honey.\nYum yum yum! It was the sweetest honey ever.\nThe bear climbed down with a happy, sticky smile.\nAnd from that day on, everyone called the bear the bravest in the forest.\nThe end.";
    const STORAGE_KEY = 'storytap_prefs_v1';
    const App = () => {
      // Load preferences
      const prefs = useMemo(() => {
        try {
          return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
        } catch { return {}; }
      }, []);

      const [mode, setMode] = useState('library');
      const [storyTitle, setStoryTitle] = useState(prefs.storyTitle || DEFAULT_STORY_TITLE);
      const [rawText, setRawText] = useState(prefs.rawText || DEFAULT_STORY_TEXT);
      const [sentences, setSentences] = useState([]);
      const [currentIndex, setCurrentIndex] = useState(-1);
      const [voice, setVoice] = useState(prefs.voice || VOICES[0].name);
      const [speed, setSpeed] = useState(prefs.speed || 0.85);
      const [isTransitioning, setIsTransitioning] = useState(false);

      // Engine state
      const [engineMode, setEngineMode] = useState('kokoro'); // 'kokoro' | 'fallback'
      const [modelReady, setModelReady] = useState(false);
      const [modelProgress, setModelProgress] = useState(0);
      const [modelStatus, setModelStatus] = useState('');
      const [loadError, setLoadError] = useState(null);
      const [isGenerating, setIsGenerating] = useState(false);
      const [isPlaying, setIsPlaying] = useState(false);

      // Accessibility Settings
      const [storyToPlay, setStoryToPlay] = useState(null);
      const [editingId, setEditingId] = useState(null);
      const [showSettings, setShowSettings] = useState(false);
      // Library & Processing Queue
      const [library, setLibrary] = useState(() => {
        try {
          const saved = JSON.parse(localStorage.getItem('storytap_library_v1')) || [];
          return saved.map(s => ({
            ...s,
            status: s.status || 'ready',
            progress: s.progress || 100,
            voice: s.voice || 'af_heart',
            speed: s.speed || 0.85
          }));
        }
        catch { return []; }
      });
      useEffect(() => localStorage.setItem('storytap_library_v1', JSON.stringify(library)), [library]);

      // Processing Queue
      const processingRef = useRef(null);

      const processStory = async (story) => {
        processingRef.current = story.id;

        const sentences = [];
        story.text.split('\n').forEach(line => {
          (line.match(/[^.!?]+[.!?]+|[^.!?]+$/g) || []).forEach(s => {
            if (s.trim()) sentences.push(s.trim());
          });
        });

        const total = sentences.length;
        if (total === 0) {
          setLibrary(prev => prev.map(s => s.id === story.id ? { ...s, status: 'cached', progress: 100 } : s));
          processingRef.current = null;
          return;
        }

        let completed = 0;
        for (const sentence of sentences) {
          if (processingRef.current !== story.id) break;

          await generateKokoroAudio(sentence, story.voice, story.speed);
          completed++;

          setLibrary(prev => prev.map(s => s.id === story.id ? {
            ...s,
            progress: Math.round((completed / total) * 100)
          } : s));

          await yieldIdle(20);
        }

        if (processingRef.current === story.id) {
          setLibrary(prev => prev.map(s => s.id === story.id ? { ...s, status: 'cached', progress: 100 } : s));
          processingRef.current = null;
          playCue('download_done');
        }
      };

      useEffect(() => {
        if (mode !== 'library') return; // Never cache while editing â€” too disruptive
        const task = library.find(s => s.status === 'processing');
        if (task && modelReady && ttsRef.current && (!processingRef.current || processingRef.current !== task.id)) {
          processStory(task);
        }
      }, [library, modelReady, mode]);

      const createNewBook = () => {
        setStoryTitle('');
        setRawText('');
        setEditingId(null);
        setMode('create');
      };

      const editBook = (story, e) => {
        e.stopPropagation();
        setStoryTitle(story.title);
        setRawText(story.text);
        setVoice(story.voice || VOICES[0].name);
        setSpeed(story.speed || 0.85);
        setEditingId(story.id);
        setMode('create');
      };

      const saveCreatedBook = () => {
        if (!storyTitle.trim()) return;

        const storyData = {
          title: storyTitle,
          text: rawText,
          voice,
          speed,
          status: 'ready',  // Save without auto-caching â€” user can Download to pre-cache
          progress: 100
        };

        if (editingId) {
          setLibrary(prev => prev.map(s => s.id === editingId ? { ...storyData, id: editingId } : s));
          setEditingId(null);
        } else {
          setLibrary(prev => [{ ...storyData, id: Date.now() }, ...prev]);
        }
        setMode('library');
      };

      const loadBookForPlay = (story) => {
        if (story.status === 'processing') return; // Block only while downloading
        setStoryTitle(story.title);
        setRawText(story.text);
        setVoice(story.voice || VOICES[0].name);
        setSpeed(story.speed || 0.85);
        setStoryToPlay(story);
      };
      const preloadBook = (story, e) => {
        e.stopPropagation();
        setLibrary(prev => prev.map(s => s.id === story.id ? { ...s, status: 'processing', progress: 0 } : s));
      };

      const deleteBook = (id, e) => {
        e.stopPropagation();
        if (confirm('Delete this story?')) {
          setLibrary(prev => prev.filter(s => s.id !== id));
        }
      };
      const [soundCuesEnabled, setSoundCuesEnabled] = useState(prefs.soundCuesEnabled ?? true);
      const [vibrationEnabled, setVibrationEnabled] = useState(prefs.vibrationEnabled ?? true);
      const [theme, setTheme] = useState(prefs.theme || 'default');
      const [textSize, setTextSize] = useState(prefs.textSize || 'normal');
      const [allowSkip, setAllowSkip] = useState(prefs.allowSkip ?? false);

      // Save preferences on change
      useEffect(() => {
        const toSave = {
          storyTitle, rawText, voice, speed,
          soundCuesEnabled, vibrationEnabled, theme, textSize, allowSkip
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
      }, [storyTitle, rawText, voice, speed, soundCuesEnabled, vibrationEnabled, theme, textSize, allowSkip]);

      // Exit button hold state
      const [isHoldingExit, setIsHoldingExit] = useState(false);
      const [holdProgress, setHoldProgress] = useState(0);
      const holdTimerRef = useRef(null);
      const holdStartRef = useRef(null);
      const lastInteractionRef = useRef(0);

      // Refs
      const ttsRef = useRef(null);
      const audioRef = useRef(null);
      const cacheRef = useRef({});
      const prefetchRef = useRef(new Set());
      const deviceInfoRef = useRef(getDeviceInfo());
      const initPromiseRef = useRef(null);

      const { play: playCue } = useAudioCues(soundCuesEnabled, vibrationEnabled);
      const currentTheme = THEMES.find(t => t.id === theme) || THEMES[0];

      const getTextSizeClass = () => {
        if (textSize === 'huge') return 'text-4xl md:text-6xl lg:text-7xl';
        if (textSize === 'large') return 'text-3xl md:text-5xl lg:text-6xl';
        return 'text-2xl md:text-4xl lg:text-5xl';
      };

      // =============================================
      // KOKORO TTS ENGINE (Primary)
      // =============================================
      const loadKokoroModel = useCallback(async () => {
        if (ttsRef.current) {
          setModelReady(true);
          return true;
        }

        if (initPromiseRef.current) return initPromiseRef.current;

        initPromiseRef.current = (async () => {
          const device = deviceInfoRef.current;
          setLoadError(null);
          setModelProgress(0);
          setModelStatus('Initializing...');

          try {
            await yieldToBrowser();

            // Determine optimal settings based on device
            let useWebGPU = false;
            let dtype = 'q8'; // Default to q8 for stability

            // Only try WebGPU on desktop Chrome/Edge with good specs
            if (!device.isMobile && !device.isSafari && device.hasWebGPU && device.memory >= 8) {
              try {
                const adapter = await navigator.gpu.requestAdapter();
                if (adapter) {
                  const gpuDevice = await adapter.requestDevice();
                  gpuDevice.destroy();
                  useWebGPU = true;
                  dtype = 'fp32';
                  setModelStatus('Using GPU acceleration...');
                }
              } catch (e) {
                console.warn('WebGPU not available:', e);
              }
            }

            // Tiered model quality based on device capabilities
            if (device.isMobile || device.memory < 4 || device.cores < 4) {
              dtype = 'q4';
              setModelStatus('Loading compact model...');
            } else if (device.memory < 6 && !useWebGPU) {
              dtype = 'q4';
              setModelStatus('Loading optimized model...');
            } else if (!useWebGPU) {
              dtype = 'q8';
              setModelStatus('Loading high-quality model...');
            } else {
              setModelStatus('Loading premium model...');
            }

            console.log(`Loading Kokoro TTS: device=${useWebGPU ? 'webgpu' : 'wasm'}, dtype=${dtype}`);

            const tts = await KokoroTTS.from_pretrained(MODEL_ID, {
              dtype,
              device: useWebGPU ? 'webgpu' : 'wasm',
              progress_callback: (p) => {
                if (p.status === 'progress' && p.total) {
                  const pct = Math.round((p.loaded / p.total) * 100);
                  setModelProgress(pct);
                  if (pct < 30) setModelStatus('Downloading voice model...');
                  else if (pct < 70) setModelStatus('Preparing voice engine...');
                  else if (pct < 95) setModelStatus('Almost ready...');
                  else setModelStatus('Finalizing...');
                }
              }
            });

            ttsRef.current = tts;
            setModelReady(true);
            setEngineMode('kokoro');
            console.log('Kokoro TTS loaded successfully');
            return true;

          } catch (error) {
            console.error('Kokoro TTS failed to load:', error);
            setLoadError(`Voice engine error: ${error.message || 'Unknown error'}`);
            initPromiseRef.current = null; // Reset promise on error so we can retry
            return false;
          }
        })();

        return initPromiseRef.current;
      }, []);

      // Auto-init on mount
      useEffect(() => {
        loadKokoroModel();
      }, [loadKokoroModel]);

      // Generate audio with Kokoro + persistent cache
      const generateKokoroAudio = useCallback(async (text, voiceOpt, speedOpt) => {
        if (!ttsRef.current) return null;

        const useVoice = voiceOpt || voice;
        const useSpeed = speedOpt || speed;

        // Check persistent cache first
        const cacheKey = getCacheKey(text, useVoice, useSpeed);
        try {
          const cachedBlob = await getCachedAudio(cacheKey);
          if (cachedBlob) {
            console.log('Using cached audio for:', text.substring(0, 30) + '...');
            return URL.createObjectURL(cachedBlob);
          }
        } catch (e) { /* Cache miss, generate fresh */ }

        try {
          // Clean the text and generate audio for the full sentence
          const cleanText = cleanTextForTTS(text);
          await yieldIdle(10);

          const audio = await ttsRef.current.generate(cleanText, { voice: useVoice, speed: useSpeed });
          const resultBlob = audio.toBlob();

          // Save to persistent cache (don't await, do in background)
          setCachedAudio(cacheKey, resultBlob).catch(() => { });

          return URL.createObjectURL(resultBlob);

        } catch (error) {
          console.error('Kokoro generation error:', error);
          return null;
        }
      }, [voice, speed]);

      // =============================================
      // WEB SPEECH FALLBACK ENGINE
      // =============================================
      const speakWithFallback = useCallback((text) => {
        return new Promise((resolve, reject) => {
          if (!window.speechSynthesis) {
            reject(new Error('Speech synthesis not available'));
            return;
          }

          window.speechSynthesis.cancel();
          const utterance = new SpeechSynthesisUtterance(text);

          // Find a good English voice
          const voices = window.speechSynthesis.getVoices();
          const englishVoice = voices.find(v => v.lang.startsWith('en') && v.name.includes('Female'))
            || voices.find(v => v.lang.startsWith('en'))
            || voices[0];
          if (englishVoice) utterance.voice = englishVoice;

          utterance.rate = speed * 0.9;
          utterance.pitch = 1.0;
          utterance.onend = resolve;
          utterance.onerror = reject;

          window.speechSynthesis.speak(utterance);
        });
      }, [speed]);

      // =============================================
      // UNIFIED SPEECH SYSTEM
      // =============================================
      const prefetch = useCallback(async (startIdx, list) => {
        if (engineMode !== 'kokoro' || !ttsRef.current) return;

        const device = deviceInfoRef.current;
        const isSlowDevice = device.isMobile || device.memory < 4 || device.cores < 4;

        // Priority 1: CRITICAL â€” next 2 sentences with NO yielding (instant pipeline)
        for (let i = startIdx; i < Math.min(startIdx + 2, list.length); i++) {
          if (cacheRef.current[i] || prefetchRef.current.has(i)) continue;
          prefetchRef.current.add(i);
          try {
            const url = await generateKokoroAudio(list[i]);
            if (url) cacheRef.current[i] = url;
          } catch (e) { console.warn('Prefetch P1 error:', e); }
          prefetchRef.current.delete(i);
        }

        // Priority 2: Look-ahead buffer â€” next 4-8 sentences with minimal yielding
        const lookAhead = isSlowDevice ? 4 : 8;
        for (let i = startIdx + 2; i < Math.min(startIdx + 2 + lookAhead, list.length); i++) {
          if (cacheRef.current[i] || prefetchRef.current.has(i)) continue;
          prefetchRef.current.add(i);
          await yieldIdle(5);
          try {
            const url = await generateKokoroAudio(list[i]);
            if (url) cacheRef.current[i] = url;
          } catch (e) { console.warn('Prefetch P2 error:', e); }
          prefetchRef.current.delete(i);
        }

        // Priority 3: Fill remaining gaps during true idle time (background)
        for (let i = 0; i < list.length; i++) {
          if (cacheRef.current[i] || prefetchRef.current.has(i)) continue;
          prefetchRef.current.add(i);
          await yieldIdle(isSlowDevice ? 80 : 30);
          try {
            const url = await generateKokoroAudio(list[i]);
            if (url) cacheRef.current[i] = url;
          } catch (e) { console.warn('Prefetch P3 error:', e); }
          prefetchRef.current.delete(i);
        }
      }, [engineMode, generateKokoroAudio]);

      const playSentence = useCallback(async (idx, list) => {
        if (idx < 0 || idx >= list.length) return;

        // Stop current audio
        setIsPlaying(false);
        if (audioRef.current) {
          try { audioRef.current.pause(); audioRef.current.currentTime = 0; } catch (e) { }
        }
        window.speechSynthesis?.cancel();

        const text = list[idx];

        // Try Kokoro first
        if (engineMode === 'kokoro' && ttsRef.current) {
          let url = cacheRef.current[idx];

          if (!url) {
            setIsGenerating(true);
            url = await generateKokoroAudio(text);
            if (url) cacheRef.current[idx] = url;
            setIsGenerating(false);
          }

          if (url && audioRef.current) {
            try {
              audioRef.current.src = url;
              await audioRef.current.play();
              setIsPlaying(true);

              // IMMEDIATELY start prefetching next sentences while this one plays
              // This runs in background - generates while audio is playing
              prefetch(idx + 1, list);

              return;
            } catch (e) {
              console.warn('Kokoro playback failed, trying fallback:', e);
            }
          }
        }

        // Fallback to Web Speech
        console.log('Using Web Speech fallback');
        setEngineMode('fallback');
        setIsPlaying(true);

        try {
          await speakWithFallback(text);
        } catch (e) {
          console.error('Fallback speech error:', e);
        }

        setIsPlaying(false);
        playCue('ready');
      }, [engineMode, generateKokoroAudio, speakWithFallback, prefetch, playCue]);

      // Audio ended handler - also continue prefetching
      const handleAudioEnded = useCallback(() => {
        setIsPlaying(false);
        if (currentIndex >= 0 && currentIndex < sentences.length) {
          playCue('ready');

          // Pre-load next sentence audio for instant playback on next tap
          const nextIdx = currentIndex + 1;
          if (nextIdx < sentences.length) {
            const nextUrl = cacheRef.current[nextIdx];
            if (nextUrl && audioRef.current) {
              audioRef.current.src = nextUrl;
              audioRef.current.load(); // Force browser to decode audio ahead of time
            }
          }

          // Continue prefetching while waiting for next tap
          if (engineMode === 'kokoro' && ttsRef.current) {
            prefetch(currentIndex + 1, sentences);
          }
        }
      }, [currentIndex, sentences, engineMode, playCue, prefetch]);

      // Exit button hold logic
      const startHoldExit = (e) => {
        e.preventDefault(); // Prevent synthesized mouse events from reaching parent
        e.stopPropagation();
        setIsHoldingExit(true);
        holdStartRef.current = Date.now();

        const updateProgress = () => {
          const elapsed = Date.now() - holdStartRef.current;
          const progress = Math.min((elapsed / 2000) * 100, 100);
          setHoldProgress(progress);

          if (progress >= 100) {
            exitStory();
            endHoldExit();
          } else {
            holdTimerRef.current = requestAnimationFrame(updateProgress);
          }
        };
        holdTimerRef.current = requestAnimationFrame(updateProgress);
      };

      const endHoldExit = () => {
        setIsHoldingExit(false);
        setHoldProgress(0);
        if (holdTimerRef.current) {
          cancelAnimationFrame(holdTimerRef.current);
          holdTimerRef.current = null;
        }
      };

      // Main tap handler
      const handleTap = useCallback(() => {
        if (isGenerating || isTransitioning) { playCue('busy'); return; }

        if (isPlaying) {
          if (!allowSkip) { playCue('busy'); return; }
          // Skip mode: stop current audio and continue to advance
          if (audioRef.current) {
            try { audioRef.current.pause(); audioRef.current.currentTime = 0; } catch (e) { }
          }
          window.speechSynthesis?.cancel();
          setIsPlaying(false);
        }

        // Context-aware tap cue
        if (currentIndex === -1) {
          playCue('cover_tap');
        } else {
          playCue('tap');
        }
        setIsTransitioning(true);

        const nextIndex = currentIndex + 1;

        if (currentIndex >= sentences.length) {
          playCue('story_start');
          setTimeout(() => {
            setCurrentIndex(-1);
            setIsTransitioning(false);
          }, 500);
          return;
        }

        if (currentIndex === -1) {
          playCue('story_start');
          setTimeout(() => {
            setCurrentIndex(0);
            playSentence(0, sentences);
            setIsTransitioning(false);
          }, 300); // Reduced from 500ms for snappier start
          return;
        }

        if (nextIndex >= sentences.length) {
          playCue('story_end');
          setTimeout(() => {
            setCurrentIndex(sentences.length);
            setIsTransitioning(false);
          }, 80); // Reduced from 100ms
          return;
        }

        playCue('advance');
        setTimeout(() => {
          setCurrentIndex(nextIndex);
          playSentence(nextIndex, sentences);
          setIsTransitioning(false);
        }, 80); // Reduced from 150ms â€” much snappier page turns
      }, [currentIndex, sentences, isGenerating, isPlaying, isTransitioning, allowSkip, playCue, playSentence]);

      // Ultra-responsive touch handler for accessibility
      // Fires on the SLIGHTEST contact â€” any finger count, any pressure
      // Uses touchstart (not click) for zero-delay response
      const handleInteraction = useCallback((e) => {
        // Prevent all default browser behaviors (scrolling, zooming, pull-to-refresh, text selection)
        e.preventDefault();

        // Debounce: touchstart + synthesized mousedown can double-fire
        const now = Date.now();
        if (now - lastInteractionRef.current < 180) return;
        lastInteractionRef.current = now;

        handleTap();
      }, [handleTap]);

      // Start story
      // Background Pre-generation of First Page (Sentence 0 & 1)
      useEffect(() => {
        // Clear cache on any invalidating change
        const clearCache = () => {
          Object.values(cacheRef.current).forEach(url => URL.revokeObjectURL(url));
          cacheRef.current = {};
          prefetchRef.current.clear();
        };
        clearCache();

        const timer = setTimeout(async () => {
          if (mode === 'create') return; // Don't hog the CPU while user is typing
          if (!rawText.trim() || !modelReady || engineMode !== 'kokoro' || !ttsRef.current) return;

          const sentences = [];
          rawText.split('\n').forEach(line => {
            (line.match(/[^.!?]+[.!?]+|[^.!?]+$/g) || []).forEach(s => {
              if (s.trim()) sentences.push(s.trim());
            });
          });

          if (!sentences.length) return;

          // Generate first 2 sentences
          try {
            // 0
            if (!cacheRef.current[0]) {
              const url0 = await generateKokoroAudio(sentences[0]);
              if (url0) cacheRef.current[0] = url0;
            }
            // 1
            if (sentences[1] && !cacheRef.current[1]) {
              await yieldIdle(100);
              const url1 = await generateKokoroAudio(sentences[1]);
              if (url1) cacheRef.current[1] = url1;
            }
          } catch (e) { }
        }, 1500); // Debounce

        return () => clearTimeout(timer);
      }, [rawText, voice, speed, modelReady, engineMode, generateKokoroAudio, mode]);

      // Start story
      const startStory = async () => {
        const allSentences = [];
        rawText.split('\n').forEach(line => {
          (line.match(/[^.!?]+[.!?]+|[^.!?]+$/g) || []).forEach(s => {
            const c = s.trim();
            if (c) allSentences.push(c);
          });
        });
        if (!allSentences.length) return;

        // Note: We do NOT clear cache here anymore because background generator might have populated it.
        // Cache is cleared by the useEffect above when settings change.

        setSentences(allSentences);
        setCurrentIndex(-1);
        setMode('loading');

        // Ensure model is loaded (should be already due to auto-init)
        if (!ttsRef.current) {
          const success = await loadKokoroModel();
          if (!success) {
            setEngineMode('fallback');
            setModelReady(true);
            setMode('reading');
            return;
          }
        }

        // =============================================
        // JIT STRATEGY: Only generate FIRST sentence
        // This makes the app launch into reading mode much faster
        // =============================================
        if (ttsRef.current) {
          setModelStatus('Preparing first sentence...');

          try {
            if (cacheRef.current[0]) {
              // Already pre-buffered!
            } else {
              const firstSentence = allSentences[0];
              const url = await generateKokoroAudio(firstSentence);
              if (url) cacheRef.current[0] = url;
            }
          } catch (e) {
            console.warn('Initial generation error:', e);
          }
        }

        setMode('reading');

        // Trigger background prefetch for the rest immediately
        if (ttsRef.current && engineMode === 'kokoro') {
          // Start prefetcing from index 1 (since 0 is done)
          setTimeout(() => prefetch(1, allSentences), 50);
        }
      };

      useEffect(() => {
        if (storyToPlay && rawText === storyToPlay.text) {
          startStory();
          setStoryToPlay(null);
        }
      }, [storyToPlay, rawText]);

      // Exit story
      const exitStory = () => {
        if (audioRef.current) {
          try { audioRef.current.pause(); audioRef.current.src = ''; } catch (e) { }
        }
        window.speechSynthesis?.cancel();
        setMode('library');
        setCurrentIndex(-1);
        setIsPlaying(false);
        setIsGenerating(false);
      };

      // =============================================
      // SETTINGS MODAL
      // =============================================
      const SettingsModal = () => (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" onClick={() => setShowSettings(false)}>
          <div className={`${currentTheme.cardBg} rounded-3xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto ${currentTheme.border} border`} onClick={e => e.stopPropagation()}>
            <div className={`p-6 border-b ${currentTheme.border} flex items-center justify-between`}>
              <h2 className={`text-xl font-bold ${currentTheme.textMain}`}>Accessibility Settings</h2>
              <button onClick={() => setShowSettings(false)} className={`p-2 rounded-full transition-colors ${theme.includes('high-contrast') ? `hover:bg-white/10 ${currentTheme.textMain}` : 'hover:bg-slate-100 text-slate-500'}`}>
                <X size={20} />
              </button>
            </div>

            <div className="p-6 space-y-6">
              {/* Sound Cues */}
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${theme.includes('high-contrast') ? `border ${currentTheme.border}` : 'bg-indigo-100'}`}>
                    {soundCuesEnabled ? <Volume2 size={20} className={theme.includes('high-contrast') ? currentTheme.textMain : 'text-indigo-600'} /> : <VolumeX size={20} className={currentTheme.textSub} />}
                  </div>
                  <div>
                    <div className={`font-bold ${currentTheme.textMain}`}>Sound Cues</div>
                    <div className={`text-sm ${currentTheme.textSub}`}>Audio feedback on taps</div>
                  </div>
                </div>
                <button onClick={() => setSoundCuesEnabled(!soundCuesEnabled)} className={`w-14 h-8 rounded-full transition-colors relative ${soundCuesEnabled ? `bg-${currentTheme.highlight}-500 ${theme.includes('high-contrast') ? 'bg-white' : ''}` : 'bg-slate-200'} ${theme.includes('high-contrast') && !soundCuesEnabled ? 'bg-zinc-700' : ''}`}>
                  <div className={`absolute top-1 w-6 h-6 rounded-full shadow transition-all ${soundCuesEnabled ? 'left-7' : 'left-1'} ${theme.includes('high-contrast') ? 'bg-black' : 'bg-white'}`} />
                </button>
              </div>

              {/* Vibration */}
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${theme.includes('high-contrast') ? `border ${currentTheme.border}` : 'bg-purple-100'}`}>
                    <Vibrate size={20} className={theme.includes('high-contrast') ? currentTheme.textMain : 'text-purple-600'} />
                  </div>
                  <div>
                    <div className={`font-bold ${currentTheme.textMain}`}>Vibration</div>
                    <div className={`text-sm ${currentTheme.textSub}`}>Haptic feedback on taps</div>
                  </div>
                </div>
                <button onClick={() => setVibrationEnabled(!vibrationEnabled)} className={`w-14 h-8 rounded-full transition-colors relative ${vibrationEnabled ? `bg-${currentTheme.highlight}-500 ${theme.includes('high-contrast') ? 'bg-white' : ''}` : 'bg-slate-200'} ${theme.includes('high-contrast') && !vibrationEnabled ? 'bg-zinc-700' : ''}`}>
                  <div className={`absolute top-1 w-6 h-6 rounded-full shadow transition-all ${vibrationEnabled ? 'left-7' : 'left-1'} ${theme.includes('high-contrast') ? 'bg-black' : 'bg-white'}`} />
                </button>
              </div>

              {/* Allow Skip */}
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${theme.includes('high-contrast') ? `border ${currentTheme.border}` : 'bg-sky-100'}`}>
                    <SkipForward size={20} className={theme.includes('high-contrast') ? currentTheme.textMain : 'text-sky-600'} />
                  </div>
                  <div>
                    <div className={`font-bold ${currentTheme.textMain}`}>Allow Skip</div>
                    <div className={`text-sm ${currentTheme.textSub}`}>Tap to skip during playback</div>
                  </div>
                </div>
                <button onClick={() => setAllowSkip(!allowSkip)} className={`w-14 h-8 rounded-full transition-colors relative ${allowSkip ? `bg-${currentTheme.highlight}-500 ${theme.includes('high-contrast') ? 'bg-white' : ''}` : 'bg-slate-200'} ${theme.includes('high-contrast') && !allowSkip ? 'bg-zinc-700' : ''}`}>
                  <div className={`absolute top-1 w-6 h-6 rounded-full shadow transition-all ${allowSkip ? 'left-7' : 'left-1'} ${theme.includes('high-contrast') ? 'bg-black' : 'bg-white'}`} />
                </button>
              </div>

              {/* Visual Theme */}
              <div className="space-y-3">
                <div className="flex items-center gap-3">
                  <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${theme.includes('high-contrast') ? `border ${currentTheme.border}` : 'bg-amber-100'}`}>
                    <Palette size={20} className={theme.includes('high-contrast') ? currentTheme.textMain : 'text-amber-600'} />
                  </div>
                  <div>
                    <div className={`font-bold ${currentTheme.textMain}`}>Visual Theme</div>
                    <div className={`text-sm ${currentTheme.textSub}`}>Reading appearance</div>
                  </div>
                </div>
                <div className="grid grid-cols-2 gap-3 mt-3">
                  {THEMES.map(t => (
                    <button key={t.id} onClick={() => setTheme(t.id)} className={`relative overflow-hidden p-1 rounded-xl border-2 transition-all group ${theme === t.id ? 'border-indigo-500 ring-2 ring-indigo-200' : 'border-slate-100 hover:border-indigo-200'}`}>
                      <div className={`w-full aspect-[16/10] rounded-lg bg-gradient-to-br ${t.bg} flex flex-col items-center justify-center relative overflow-hidden`}>
                        {/* Mini text preview */}
                        <div className={`text-xs font-serif font-medium ${t.text} opacity-90 mb-1`}>Fairy Tale</div>
                        <div className={`w-12 h-0.5 rounded-full ${t.text} opacity-20`} />

                        {/* Mini progress bar */}
                        <div className="absolute bottom-0 left-0 right-0 h-1 bg-white/10">
                          <div className={`h-full w-2/3 ${t.progress}`} />
                        </div>
                      </div>

                      <div className="p-2 text-center bg-white">
                        <div className="font-bold text-xs text-slate-800">{t.label}</div>
                      </div>

                      {/* Selection check */}
                      {theme === t.id && (
                        <div className="absolute top-2 right-2 w-5 h-5 bg-indigo-500 rounded-full flex items-center justify-center shadow-sm z-10">
                          <Check size={12} className="text-white" strokeWidth={3} />
                        </div>
                      )}
                    </button>
                  ))}
                </div>
              </div>

              {/* Text Size */}
              <div className="space-y-3">
                <div className="flex items-center gap-3">
                  <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${theme.includes('high-contrast') ? `border ${currentTheme.border}` : 'bg-emerald-100'}`}>
                    <Eye size={20} className={theme.includes('high-contrast') ? currentTheme.textMain : 'text-emerald-600'} />
                  </div>
                  <div>
                    <div className={`font-bold ${currentTheme.textMain}`}>Text Size</div>
                    <div className={`text-sm ${currentTheme.textSub}`}>Story text size</div>
                  </div>
                </div>
                <div className="flex gap-2 mt-3">
                  {[{ id: 'normal', label: 'Normal' }, { id: 'large', label: 'Large' }, { id: 'huge', label: 'Huge' }].map(s => (
                    <button key={s.id} onClick={() => setTextSize(s.id)} className={`flex-1 p-3 rounded-xl border-2 text-center transition-all ${textSize === s.id ? `border-${currentTheme.highlight}-500 ${theme.includes('high-contrast') ? `bg-${currentTheme.highlight}-900/30` : `bg-${currentTheme.highlight}-50`}` : `${currentTheme.border} ${theme.includes('high-contrast') ? '' : 'hover:bg-slate-50'}`} ${currentTheme.cardBg}`}>
                      <div className={`font-bold mb-1 ${s.id === 'huge' ? 'text-2xl' : s.id === 'large' ? 'text-xl' : 'text-base'} ${currentTheme.textMain}`}>Aa</div>
                      <div className={`text-xs ${currentTheme.textSub}`}>{s.label}</div>
                    </button>
                  ))}
                </div>
              </div>
            </div>

            <div className={`p-6 border-t ${currentTheme.border}`}>
              <button onClick={() => setShowSettings(false)} className={`w-full py-3 font-bold rounded-xl transition-colors ${theme.includes('high-contrast') ? `bg-white text-black hover:bg-slate-200` : `bg-${currentTheme.highlight}-500 text-white hover:bg-${currentTheme.highlight}-600`}`}>Done</button>
            </div>
          </div>
        </div>
      );

      // =============================================
      // LOADING SCREEN
      // =============================================
      if (mode === 'loading') {
        return (
          <div className="fixed inset-0 bg-gradient-to-br from-slate-900 via-indigo-950 to-slate-900 flex flex-col items-center justify-center p-8">
            <div className="relative mb-8">
              <div className="w-24 h-24 rounded-3xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-2xl shadow-indigo-500/30">
                <Wand2 size={40} className="text-white animate-pulse" />
              </div>
            </div>
            <h2 className="text-2xl font-extrabold text-white mb-2">Preparing Magic Voice</h2>
            <p className="text-indigo-300 text-sm mb-6">{modelStatus || 'This only happens once...'}</p>
            <div className="w-64 h-2 bg-slate-800 rounded-full overflow-hidden">
              <div className="h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-300 rounded-full" style={{ width: `${modelProgress}%` }} />
            </div>
            <p className="text-indigo-400 mt-3 font-bold">{modelProgress}%</p>

            {loadError && (
              <div className="mt-6 bg-amber-900/50 text-amber-200 p-4 rounded-xl max-w-md text-center">
                <AlertTriangle className="mx-auto mb-2" size={24} />
                <p className="text-sm">{loadError}</p>
                <p className="text-xs mt-2 opacity-75">Switching to backup voice...</p>
              </div>
            )}
          </div>
        );
      }

      // =============================================
      // LIBRARY SCREEN (Main Landing)
      // =============================================
      if (mode === 'library') {
        return (
          <div className={`min-h-screen ${currentTheme.pageBg} p-4 md:p-8 transition-colors duration-300`}>
            {showSettings && <SettingsModal />}

            <header className="max-w-4xl mx-auto flex items-center justify-between mb-8">
              <div className="flex items-center gap-3">
                <div className={`w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg text-white`}>
                  <BookOpen size={24} />
                </div>
                <h1 className={`text-3xl font-bold font-serif ${currentTheme.textMain} tracking-tight`}>StoryTap</h1>
              </div>
              <button onClick={() => setShowSettings(true)} className={`p-3 rounded-2xl shadow-md hover:shadow-lg transition-all border ${currentTheme.cardBg} ${currentTheme.border} ${currentTheme.textSub}`}>
                <Settings size={22} />
              </button>
            </header>

            <div className="max-w-4xl mx-auto grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
              <button onClick={createNewBook} className={`aspect-[3/4] rounded-3xl border-4 border-dashed flex flex-col items-center justify-center gap-4 transition-all group ${currentTheme.border} hover:border-${currentTheme.highlight}-400 hover:bg-${currentTheme.highlight}-50/30`}>
                <div className={`w-20 h-20 rounded-full bg-${currentTheme.highlight}-100 flex items-center justify-center text-${currentTheme.highlight}-600 group-hover:scale-110 transition-transform`}>
                  <Plus size={40} />
                </div>
                <span className={`font-bold text-lg ${currentTheme.textSub}`}>Create New Book</span>
              </button>

              {library.map(story => (
                <div key={story.id} onClick={() => loadBookForPlay(story)} className={`aspect-[3/4] relative rounded-3xl overflow-hidden shadow-xl transition-all cursor-pointer group ${currentTheme.cardBg} ${story.status === 'processing' ? 'processing-card' : `border ${currentTheme.border} hover:scale-[1.02]`}`}>
                  <div className={`h-1/2 bg-gradient-to-br ${VOICES.find(v => v.name === story.voice)?.color || 'from-indigo-400 to-purple-500'} p-6 flex flex-col justify-between`}>
                    <div className="flex justify-between items-start w-full">
                      <span className="text-4xl shadow-sm filter drop-shadow-md">{VOICES.find(v => v.name === story.voice)?.emoji || 'ðŸ“–'}</span>
                      {story.status === 'processing' && (
                        <Loader2 className="text-white animate-spin" size={24} />
                      )}
                    </div>
                  </div>
                  <div className="p-6 flex flex-col h-1/2 justify-between">
                    <div>
                      <div className={`font-bold text-xl leading-tight mb-2 line-clamp-2 ${currentTheme.textMain}`}>{story.title}</div>
                      <div className={`text-sm ${currentTheme.textSub} line-clamp-2`}>{story.text}</div>
                    </div>

                    <div className="flex items-center justify-between mt-4">
                      {story.status === 'processing' ? (
                        <div className="flex-1 mr-4">
                          <div className={`text-xs font-bold mb-1 text-${currentTheme.highlight}-600`}>Downloading... {story.progress}%</div>
                          <div className="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                            <div className={`h-full bg-${currentTheme.highlight}-500 transition-all duration-300`} style={{ width: `${story.progress}%` }} />
                          </div>
                        </div>
                      ) : story.status === 'cached' ? (
                        <div className="flex items-center gap-1 text-xs font-bold uppercase tracking-wider text-emerald-500">
                          <Check size={12} strokeWidth={3} /> Cached &amp; Ready
                        </div>
                      ) : (
                        <div className={`flex items-center gap-1 text-xs font-bold uppercase tracking-wider ${currentTheme.textSub}`}>
                          <Play size={12} fill="currentColor" /> Tap to Read
                        </div>
                      )}

                      <div className="flex items-center -mr-2">
                        {story.status !== 'processing' && story.status !== 'cached' && (
                          <button onClick={(e) => preloadBook(story, e)} className="p-2 text-indigo-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-full transition-colors" title="Download audio for faster playback">
                            <Download size={18} />
                          </button>
                        )}
                        {story.status === 'cached' && (
                          <div className="p-2 text-emerald-400" title="Audio cached">
                            <Download size={18} />
                          </div>
                        )}
                        <button onClick={(e) => editBook(story, e)} className="p-2 text-amber-400 hover:text-amber-600 hover:bg-amber-50 rounded-full transition-colors" title="Edit Story">
                          <Pencil size={18} />
                        </button>
                        <button onClick={(e) => deleteBook(story.id, e)} className="p-2 text-rose-300 hover:text-rose-500 hover:bg-rose-50 rounded-full transition-colors">
                          <Trash2 size={18} />
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        );
      }

      // =============================================
      // CREATE BOOK SCREEN
      // =============================================
      if (mode === 'create') {
        const isHighContrast = theme.includes('high-contrast');

        return (
          <div className={`min-h-screen ${currentTheme.pageBg} p-4 md:p-8 transition-colors duration-300`}>
            {showSettings && <SettingsModal />}

            <div className="max-w-2xl mx-auto space-y-6">
              <header className="flex items-center justify-between mb-8">
                <button onClick={() => setMode('library')} className={`flex items-center gap-2 font-bold ${currentTheme.textSub} hover:${currentTheme.textMain} transition-colors`}>
                  <ArrowLeft size={20} /> Back to Library
                </button>
                <h1 className={`text-2xl font-bold font-serif ${currentTheme.textMain}`}>{editingId ? 'Edit Story' : 'Create Story'}</h1>
              </header>

              <div className={`rounded-2xl p-4 shadow-lg ${isHighContrast ? `${currentTheme.cardBg} border ${currentTheme.border} ${currentTheme.textMain}` : 'bg-gradient-to-r from-indigo-500 to-purple-500 text-white shadow-indigo-200'}`}>
                <div className="flex items-start gap-3">
                  <div className={`w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0 ${isHighContrast ? `border ${currentTheme.border}` : 'bg-white/20'}`}>
                    <Volume2 size={20} className={isHighContrast ? currentTheme.textMain : 'text-white'} />
                  </div>
                  <div>
                    <h3 className="font-bold mb-1">Designed for Blind Children</h3>
                    <p className={`text-sm ${isHighContrast ? currentTheme.textSub : 'text-white/80'}`}>Your child taps anywhere to hear each sentence with audio cues and vibrations.</p>
                  </div>
                </div>
              </div>

              {modelReady && (
                <div className={`flex items-center justify-center gap-2 rounded-full py-2 px-4 mx-auto w-fit ${isHighContrast ? `${currentTheme.cardBg} border ${currentTheme.border} ${currentTheme.textMain}` : 'bg-emerald-50 text-emerald-600'}`}>
                  <Check size={16} strokeWidth={3} />
                  <span className="text-sm font-bold">{engineMode === 'kokoro' ? 'Premium voice ready' : 'Voice ready'}</span>
                </div>
              )}

              <div className={`${currentTheme.cardBg} rounded-3xl shadow-xl p-6 md:p-8 space-y-8 border ${currentTheme.border} transition-colors`}>
                <div className="space-y-2">
                  <label className={`text-xs font-bold uppercase tracking-wide ${currentTheme.textSub}`}>Story Title</label>
                  <input type="text" value={storyTitle} onChange={e => setStoryTitle(e.target.value)} className={`w-full p-4 rounded-2xl border-2 text-xl font-bold focus:outline-none transition-colors ${currentTheme.inputBg} ${currentTheme.textMain} ${currentTheme.border} focus:border-${currentTheme.highlight}-500`} placeholder="Once Upon a Time..." />
                </div>

                <div className="space-y-2">
                  <label className={`text-xs font-bold uppercase tracking-wide ${currentTheme.textSub}`}>Story Text</label>
                  <textarea value={rawText} onChange={e => setRawText(e.target.value)} className={`w-full min-h-[180px] p-4 rounded-2xl border-2 text-base leading-relaxed focus:outline-none transition-colors font-serif ${currentTheme.inputBg} ${currentTheme.textMain} ${currentTheme.border} focus:border-${currentTheme.highlight}-500`} placeholder="Paste or type your story here..." />
                </div>

                <div className="space-y-3">
                  <label className={`text-xs font-bold uppercase tracking-wide ${currentTheme.textSub}`}>Narrator Voice</label>
                  <div className="grid grid-cols-2 gap-3">
                    {VOICES.map(v => (
                      <button key={v.name} onClick={() => setVoice(v.name)} className={`relative p-4 rounded-2xl border-2 text-left transition-all overflow-hidden group ${voice === v.name ? `border-${currentTheme.highlight}-500 shadow-lg` : `${currentTheme.border} ${isHighContrast ? '' : 'hover:border-slate-200'}`} ${currentTheme.inputBg} ${currentTheme.textMain}`}>
                        {!isHighContrast && <div className={`absolute inset-0 bg-gradient-to-br ${v.color} opacity-0 group-hover:opacity-5 transition-opacity ${voice === v.name ? 'opacity-10' : ''}`} />}
                        <div className="relative flex items-center gap-3">
                          <span className="text-2xl">{v.emoji}</span>
                          <div>
                            <div className="font-bold">{v.label}</div>
                            <div className={`text-xs ${currentTheme.textSub}`}>{v.desc}</div>
                          </div>
                        </div>
                        {voice === v.name && <div className={`absolute top-2 right-2 w-5 h-5 rounded-full flex items-center justify-center ${isHighContrast ? 'bg-white text-black' : 'bg-indigo-500 text-white'}`}><Check size={12} /></div>}
                      </button>
                    ))}
                  </div>
                </div>

                <div className="space-y-3">
                  <label className={`text-xs font-bold uppercase tracking-wide ${currentTheme.textSub}`}>Reading Speed</label>
                  <div className="flex gap-2">
                    {SPEEDS.map(s => {
                      const Icon = s.icon;
                      return (
                        <button key={s.value} onClick={() => setSpeed(s.value)} className={`flex-1 p-4 rounded-2xl border-2 text-center transition-all ${speed === s.value ? `border-${currentTheme.highlight}-500 ${isHighContrast ? currentTheme.textMain : 'bg-indigo-50 text-indigo-700'}` : `${currentTheme.border} ${currentTheme.textSub} ${isHighContrast ? '' : 'hover:border-slate-200'}`} ${currentTheme.inputBg}`}>
                          <Icon size={20} className="mx-auto mb-1" />
                          <div className="font-bold text-sm">{s.label}</div>
                        </button>
                      );
                    })}
                  </div>
                </div>

                <button onClick={saveCreatedBook} disabled={!rawText.trim() || !storyTitle.trim()} className={`w-full font-extrabold py-5 rounded-2xl text-xl flex items-center justify-center gap-3 shadow-xl transition-all duration-500 disabled:opacity-50 ${isHighContrast ? `${currentTheme.border} border-2 ${currentTheme.textMain} hover:bg-white/10` : 'bg-gradient-to-r from-indigo-500 via-purple-500 to-indigo-500 bg-[length:200%_100%] hover:bg-right text-white shadow-indigo-200'}`}>
                  <Sparkles fill={isHighContrast ? "currentColor" : "white"} size={24} />
                  {editingId ? 'Save Changes' : 'Save Book'}
                </button>
              </div>
            </div>
          </div>
        );
      }

      // =============================================
      // READING MODE
      // =============================================
      const isCover = currentIndex === -1;
      const isEnd = currentIndex >= sentences.length;
      const isReading = !isCover && !isEnd;
      const progress = sentences.length ? ((currentIndex + 1) / sentences.length) * 100 : 0;

      return (
        <div
          onTouchStart={handleInteraction}
          onTouchMove={(e) => e.preventDefault()}
          onMouseDown={handleInteraction}
          onContextMenu={(e) => e.preventDefault()}
          onKeyDown={(e) => { if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); handleInteraction(e); }}}
          className="fixed inset-0 select-none touch-none cursor-pointer overflow-hidden"
          role="button"
          tabIndex={0}
          aria-label={isCover ? 'Tap anywhere to begin the story' : isEnd ? 'Tap to start over' : `Sentence ${currentIndex + 1} of ${sentences.length}. Tap for next.`}
          aria-live="polite"
        >
          <audio ref={audioRef} onEnded={handleAudioEnded} preload="auto" hidden />

          <div className="absolute top-4 left-4 z-50">
            <button onMouseDown={startHoldExit} onMouseUp={endHoldExit} onMouseLeave={endHoldExit} onTouchStart={startHoldExit} onTouchEnd={endHoldExit} onTouchCancel={endHoldExit} className="relative p-3 bg-white/10 hover:bg-white/20 rounded-full text-white/40 hover:text-white/70 transition-all">
              {isHoldingExit && (
                <svg className="absolute inset-0 w-full h-full -rotate-90" viewBox="0 0 36 36">
                  <circle cx="18" cy="18" r="16" fill="none" stroke="white" strokeWidth="2" strokeOpacity="0.2" />
                  <circle cx="18" cy="18" r="16" fill="none" stroke="white" strokeWidth="2" strokeDasharray="100" strokeDashoffset={100 - holdProgress} strokeLinecap="round" />
                </svg>
              )}
              <ArrowLeft size={18} />
            </button>
            {isHoldingExit && <div className="absolute left-12 top-1/2 -translate-y-1/2 bg-black/80 text-white text-xs px-3 py-1.5 rounded-lg whitespace-nowrap">Hold to exit...</div>}
          </div>

          {isCover && (
            <div className={`absolute inset-0 bg-gradient-to-br ${currentTheme.coverBg} flex flex-col items-center justify-center p-8`}>
              {!theme.includes('high-contrast') && (
                <div className="absolute inset-0 overflow-hidden pointer-events-none">
                  <div className="absolute top-1/4 left-1/4 w-96 h-96 bg-indigo-500/30 rounded-full blur-3xl ambient-orb" />
                  <div className="absolute bottom-1/4 right-1/4 w-80 h-80 bg-purple-500/30 rounded-full blur-3xl ambient-orb-2" />
                </div>
              )}
              <div className="relative mb-10 fade-in-up">
                <div className={`w-32 h-40 bg-gradient-to-br from-white/10 to-white/5 rounded-2xl flex items-center justify-center border glow backdrop-blur-sm ${currentTheme.coverBorder}`}>
                  <BookOpen size={56} className={currentTheme.coverText} />
                </div>
              </div>
              <h1 className={`text-4xl md:text-6xl font-black text-center mb-4 leading-tight fade-in-up ${currentTheme.coverText}`}>{storyTitle}</h1>
              <p className={`text-lg mb-16 fade-in-up ${currentTheme.coverSub}`}>A Story for You</p>
              <div className="flex flex-col items-center fade-in-up">
                <div className="relative">
                  <div className={`absolute inset-0 w-24 h-24 rounded-full pulse-ring ${currentTheme.pulse}`} />
                  <div className={`w-24 h-24 rounded-full flex items-center justify-center border backdrop-blur-sm ${currentTheme.coverElementBg} ${currentTheme.coverBorder}`}>
                    <Volume2 size={36} className={currentTheme.coverText} />
                  </div>
                </div>
                <span className={`font-bold text-lg mt-6 uppercase tracking-widest ${currentTheme.coverSub}`}>Tap Anywhere</span>
              </div>
            </div>
          )}

          {isReading && (
            <div className={`absolute inset-0 bg-gradient-to-b ${currentTheme.bg} flex flex-col items-center justify-center p-6 md:p-16`}>
              {isGenerating && (
                <div className="absolute inset-0 flex items-center justify-center bg-black/50 z-20 backdrop-blur-sm">
                  <Loader2 className={`w-12 h-12 animate-spin ${currentTheme.text}`} />
                </div>
              )}
              <div className={`relative max-w-4xl mx-auto ${isTransitioning ? 'page-turn' : ''}`}>
                <p className={`${getTextSizeClass()} font-serif font-medium text-center leading-relaxed tracking-wide ${currentTheme.text}`}>{sentences[currentIndex]}</p>
              </div>
              <div className="absolute bottom-0 left-0 right-0 p-8 flex flex-col items-center gap-6">
                {isPlaying ? (
                  <div className={`flex items-center gap-3 ${currentTheme.text} opacity-60`}>
                    <div className="flex gap-1">{[...Array(4)].map((_, i) => (<div key={i} className={`w-1 rounded-full animate-pulse ${currentTheme.progress}`} style={{ height: `${12 + Math.random() * 12}px`, animationDelay: `${i * 0.1}s` }} />))}</div>
                    <span className="text-sm font-semibold uppercase tracking-wider">Listening...</span>
                  </div>
                ) : !isGenerating && (
                  <div className={`flex items-center gap-2 opacity-40 animate-pulse ${currentTheme.text}`}>
                    <span className="text-sm font-semibold uppercase tracking-wider">Tap for next</span>
                  </div>
                )}
                <div className="w-full max-w-xs">
                  <div className="h-1 rounded-full overflow-hidden bg-white/10">
                    <div className={`h-full transition-all duration-500 rounded-full ${currentTheme.progress}`} style={{ width: `${progress}%` }} />
                  </div>
                  <p className={`text-center text-xs mt-2 font-medium ${currentTheme.text} opacity-30`}>{currentIndex + 1} of {sentences.length}</p>
                </div>
              </div>
            </div>
          )}

          {isEnd && (
            <div className="absolute inset-0 bg-gradient-to-br from-amber-400 via-orange-500 to-rose-500 flex flex-col items-center justify-center p-8">
              <div className="absolute inset-0 overflow-hidden pointer-events-none">{[...Array(12)].map((_, i) => (<Sparkles key={i} size={16 + i * 2} className="absolute text-white/40 burst" style={{ top: `${20 + Math.random() * 60}%`, left: `${10 + Math.random() * 80}%`, animationDelay: `${i * 0.1}s` }} />))}</div>
              <Sparkles size={80} className="text-white animate-bounce mb-8" />
              <h2 className="text-5xl md:text-7xl font-black text-white text-center mb-4">The End!</h2>
              <p className="text-white/80 text-xl mb-16">What a great story!</p>
              <div className="flex flex-col items-center">
                <div className="w-20 h-20 rounded-full bg-white/20 flex items-center justify-center mb-4 pulse-ring"><Heart size={36} className="text-white" fill="white" /></div>
                <span className="text-white/80 font-bold text-lg uppercase tracking-wider">Tap to Start Over</span>
              </div>
            </div>
          )}
        </div>
      );
    };

    createRoot(document.getElementById('root')).render(<App />);
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(registration => console.log('SW registered: ', registration.scope))
          .catch(registrationError => console.log('SW registration failed: ', registrationError));
      });
    }
  </script>
</body>

</html>